<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKUST RWA Exchange | V12 Ultimate</title>
    
    <!-- æ ¸å¿ƒåº“ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #2563eb;       /* ç§‘æŠ€è“ */
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-body: #f8fafc;       /* ææµ…ç°èƒŒæ™¯ */
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --sidebar-width: 280px;
            --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* === ä¾§è¾¹æ  (Premium Sidebar) === */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: var(--bg-card);
            border-right: 1px solid #e2e8f0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 24px 0;
            box-shadow: var(--shadow-sm);
        }

        .brand {
            padding: 0 32px 32px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #4f46e5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }

        .brand-text h5 { margin: 0; font-weight: 800; letter-spacing: -0.5px; color: #1e293b; }
        .brand-text small { font-size: 0.75rem; color: var(--text-sub); font-weight: 500; }

        .nav-section {
            padding: 0 16px;
            margin-bottom: 24px;
        }

        .nav-label {
            padding: 0 16px 8px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            font-weight: 700;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 12px;
            color: var(--text-sub);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item i { width: 24px; text-align: center; margin-right: 12px; font-size: 1.1rem; transition: 0.2s; }
        
        .nav-item:hover { background-color: #f1f5f9; color: var(--primary); }
        .nav-item:hover i { transform: scale(1.1); }

        .nav-item.active {
            background: linear-gradient(90deg, #eff6ff 0%, white 100%);
            color: var(--primary);
            font-weight: 600;
            border-left: 4px solid var(--primary);
            border-radius: 4px 12px 12px 4px;
            box-shadow: var(--shadow-sm);
        }

        /* === ä¸»å†…å®¹åŒº (Main Content) === */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 32px 48px;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨æ  */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .page-title h2 { margin: 0; font-weight: 700; color: #1e293b; }
        .page-title p { margin: 4px 0 0; color: var(--text-sub); font-size: 0.9rem; }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            background: white;
            padding: 8px 16px;
            border-radius: 50px;
            box-shadow: var(--shadow-md);
            border: 1px solid #f1f5f9;
        }

        .balance-pill {
            background: #eff6ff;
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid #dbeafe;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-sub);
        }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 0 2px #d1fae5; }
        .status-dot.offline { background: var(--danger); }

        /* === å¡ç‰‡ç³»ç»Ÿ (Modern Cards) === */
        .card-glass {
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }

        .card-glass:hover {
            box-shadow: var(--shadow-lg);
        }

        /* === RWA èµ„äº§å¡ç‰‡ (é‡ç‚¹ç¾åŒ–) === */
        .asset-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #f1f5f9;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .asset-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
            border-color: #bfdbfe;
        }

        .asset-visual {
            height: 180px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: 900;
            color: rgba(0,0,0,0.05);
            letter-spacing: -2px;
            overflow: hidden;
        }
        
        /* è£…é¥°æ€§åœ†åœˆ */
        .asset-visual::after {
            content: '';
            position: absolute;
            width: 120px;
            height: 120px;
            background: linear-gradient(45deg, var(--primary), #a855f7);
            border-radius: 50%;
            opacity: 0.1;
            top: -20px;
            right: -20px;
        }

        .asset-tag {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(4px);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #1e293b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .asset-info { padding: 24px; }
        
        .asset-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
        .asset-subtitle { font-size: 0.85rem; color: #64748b; margin-bottom: 16px; }
        
        .asset-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: baseline;
            gap: 4px;
        }
        .asset-price small { font-size: 0.9rem; font-weight: 500; color: #94a3b8; }

        .btn-buy {
            width: 100%;
            margin-top: 16px;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: var(--text-main);
            color: white;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-buy:hover { background: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        /* === è¡¨å•å…ƒç´ ç¾åŒ– === */
        .form-control, .form-select {
            border: 1px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 10px;
            background: #f8fafc;
            transition: 0.2s;
            font-size: 0.95rem;
        }
        .form-control:focus, .form-select:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* === è¡¨æ ¼ç¾åŒ– === */
        .table-modern {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        .table-modern th {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
            padding: 0 16px 8px;
            border: none;
        }
        .table-modern td {
            background: white;
            padding: 16px;
            vertical-align: middle;
            border-top: 1px solid #f1f5f9;
            border-bottom: 1px solid #f1f5f9;
        }
        .table-modern tr td:first-child { border-left: 1px solid #f1f5f9; border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .table-modern tr td:last-child { border-right: 1px solid #f1f5f9; border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

        /* æƒé™æ§åˆ¶ */
        .admin-only, .root-only { display: none !important; }
        .view-section { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-cube"></i></div>
            <div class="brand-text">
                <h5>RWA.Fi</h5>
                <small>HKUST Demo V12</small>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-label">Marketplace</div>
            <a onclick="nav('market')" class="nav-item active" id="nav-market">
                <i class="fas fa-store-alt"></i> èµ„äº§å¸‚åœº
            </a>
            <a onclick="nav('profile')" class="nav-item" id="nav-profile">
                <i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§
            </a>
        </div>

        <div class="nav-section admin-only">
            <div class="nav-label">Administration</div>
            <a onclick="nav('issuer')" class="nav-item" id="nav-issuer">
                <i class="fas fa-file-signature"></i> å¤šç­¾å‘è¯
            </a>
            <a onclick="nav('logs')" class="nav-item" id="nav-logs">
                <i class="fas fa-history"></i> å®¡è®¡æ—¥å¿—
            </a>
        </div>

        <div class="nav-section root-only">
            <div class="nav-label">Governance</div>
            <a onclick="nav('admin')" class="nav-item" id="nav-admin">
                <i class="fas fa-layer-group"></i> èµ„äº§ä¸Šæ¶
            </a>
            <a onclick="nav('gov')" class="nav-item" id="nav-gov">
                <i class="fas fa-building-columns"></i> æœºæ„ç›‘ç®¡
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="page-title">
                <h2 id="page-header-title">èµ„äº§å¸‚åœº</h2>
                <p>å»ä¸­å¿ƒåŒ–ã€åˆè§„ã€å®‰å…¨çš„ç°å®èµ„äº§äº¤æ˜“å¹³å°ã€‚</p>
            </div>
            <div class="user-controls">
                <div class="status-pill">
                    <div id="net-dot" class="status-dot online"></div>
                    <span id="net-text">RPC åœ¨çº¿</span>
                </div>
                <div class="balance-pill">
                    <span id="hkc-bal">0.00</span> HKC
                </div>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary rounded-pill px-4 fw-bold">
                    è¿æ¥é’±åŒ…
                </button>
                <div id="user-badge" class="d-none d-flex align-items-center gap-2">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" class="rounded-circle" width="32">
                    <span class="fw-bold small text-dark" id="wallet-display">0x...</span>
                </div>
            </div>
        </header>

        <!-- 1. å¸‚åœºé¡µé¢ (Market) -->
        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex gap-2">
                    <span class="badge bg-white text-dark border px-3 py-2 rounded-pill">å…¨éƒ¨èµ„äº§</span>
                    <span class="badge bg-transparent text-muted border px-3 py-2 rounded-pill">HK ä¸“åŒº</span>
                </div>
                <button class="btn btn-light text-primary fw-bold border" onclick="approveHKC()">
                    <i class="fas fa-key me-2"></i> æ¿€æ´»èµ„é‡‘æƒé™ (Approve)
                </button>
            </div>

            <div class="row g-4" id="market-grid">
                <!-- éª¨æ¶å±åŠ è½½åŠ¨ç”» -->
                <div class="col-12 text-center py-5 text-muted">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p>æ­£åœ¨ä»åŒºå—é“¾åŒæ­¥èµ„äº§æ•°æ®...</p>
                </div>
            </div>
        </div>

        <!-- 2. ä¸ªäººä¸­å¿ƒ (Profile) -->
        <div id="view-profile" class="view-section">
            <div class="row mb-5">
                <div class="col-md-8">
                    <div class="card-glass" style="background: linear-gradient(120deg, #2563eb, #1e40af); color: white; border: none;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-white bg-opacity-25 mb-2">DID æ•°å­—èº«ä»½</span>
                                <h1 class="fw-bold mb-1" id="my-role-display">æ¸¸å®¢ / æœªè¿æ¥</h1>
                                <p class="opacity-75" id="my-org-display">è¯·è¿æ¥é’±åŒ…æŸ¥çœ‹è¯¦æƒ…</p>
                            </div>
                            <i class="fas fa-id-badge fa-4x opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-glass text-center d-flex flex-column justify-content-center">
                        <h6 class="text-muted text-uppercase small fw-bold">èµ„äº§æ€»å€¼</h6>
                        <h2 class="text-dark fw-bold my-2">---</h2>
                        <small class="text-success"><i class="fas fa-arrow-up"></i> å®æ—¶ä¼°å€¼</small>
                    </div>
                </div>
            </div>

            <h5 class="fw-bold text-dark mb-4">ğŸ“¦ æˆ‘çš„æŒä»“ (Inventory)</h5>
            <div class="row g-4" id="inventory-grid">
                <div class="col-12 text-center py-5 text-muted bg-white rounded-4 border border-dashed">
                    <i class="fas fa-box-open fa-2x mb-3 opacity-50"></i>
                    <p>æš‚æ— æŒä»“ï¼Œè¯·å‰å¾€å¸‚åœºè´­ä¹°</p>
                </div>
            </div>
        </div>

        <!-- 3. å¤šç­¾å‘è¯ (Issuer) -->
        <div id="view-issuer" class="view-section">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card-glass">
                        <h5 class="fw-bold text-warning mb-4"><i class="fas fa-pen-nib me-2"></i> å‘èµ·ææ¡ˆ</h5>
                        <div class="mb-3">
                            <label class="form-label small text-muted fw-bold">ç›®æ ‡ç”¨æˆ·åœ°å€</label>
                            <input id="targetUser" class="form-control" placeholder="0x...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted fw-bold">æ‰€åœ¨åœ°åŒº</label>
                            <select id="targetRegion" class="form-select"><option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯ (HK)</option><option value="US">ğŸ‡ºğŸ‡¸ ç¾å›½ (US)</option><option value="CN">ğŸ‡¨ğŸ‡³ å†…åœ° (CN)</option></select>
                        </div>
                        <div class="mb-4">
                            <label class="form-label small text-muted fw-bold">èº«ä»½è§’è‰²</label>
                            <select id="targetRole" class="form-select"><option value="Student">å­¦ç”Ÿ (Student)</option><option value="Investor">æŠ•èµ„äºº (Investor)</option></select>
                        </div>
                        <button onclick="proposeID()" class="btn btn-warning w-100 fw-bold text-dark">æäº¤ææ¡ˆ (Submit)</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-glass">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold m-0">ğŸ“‹ å¾…å®¡æ‰¹åˆ—è¡¨ (Checker)</h5>
                            <button onclick="loadProposals()" class="btn btn-sm btn-light border"><i class="fas fa-sync"></i></button>
                        </div>
                        <table class="table-modern">
                            <thead><tr><th>ID</th><th>ç”¨æˆ·</th><th>è§’è‰²</th><th>å‘èµ·äºº</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="proposal-table"><tr><td colspan="5" class="text-center text-muted py-4">æš‚æ— å¾…åŠäº‹é¡¹</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. èµ„äº§ç®¡ç† (Admin) -->
        <div id="view-admin" class="view-section">
            <div class="card-glass mb-4">
                <h5 class="fw-bold text-success mb-4">ä¸Šæ¶æ–°èµ„äº§</h5>
                <div class="row g-3">
                    <div class="col-md-5"><input id="newAssetName" class="form-control" placeholder="èµ„äº§åç§° (e.g. Tokenized Gold)"></div>
                    <div class="col-md-3"><input id="newAssetPrice" type="number" class="form-control" placeholder="ä»·æ ¼ (HKC)"></div>
                    <div class="col-md-2">
                        <select id="newAssetRegion" class="form-select"><option value="">ğŸŒ å…¨çƒ</option><option value="HK">ğŸ‡­ğŸ‡° ä»…é™ HK</option></select>
                    </div>
                    <div class="col-md-2"><button onclick="addAsset()" class="btn btn-success w-100 fw-bold">ä¸Šæ¶</button></div>
                </div>
            </div>
            <div class="card-glass">
                <h5 class="fw-bold mb-4">ç°å­˜èµ„äº§åˆ—è¡¨</h5>
                <table class="table-modern">
                    <thead><tr><th>ID</th><th>åç§°</th><th>ä»·æ ¼</th><th>çŠ¶æ€</th><th>ç®¡ç†</th></tr></thead>
                    <tbody id="admin-table"></tbody>
                </table>
            </div>
        </div>

        <!-- 5. ç›‘ç®¡ (Gov) -->
        <div id="view-gov" class="view-section">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card-glass" style="border-top: 4px solid #ef4444;">
                        <h5 class="fw-bold text-danger mb-4">æœºæ„æˆæƒ</h5>
                        <p class="small text-muted mb-3">è¾“å…¥æœºæ„é’±åŒ…åœ°å€è¿›è¡Œæˆæƒã€‚</p>
                        <input id="issuerAddr" class="form-control mb-3" placeholder="æœºæ„åœ°å€ (0x...)">
                        <input id="issuerName" class="form-control mb-3" placeholder="æœºæ„åç§° (e.g. HKUST)">
                        <button onclick="govAdd()" class="btn btn-danger w-100 fw-bold">ç¡®è®¤æˆæƒ</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-glass">
                        <h5 class="fw-bold mb-4">å·²æˆæƒæœºæ„åå•</h5>
                        <table class="table-modern">
                            <tbody id="issuer-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. æ—¥å¿— (Logs) -->
        <div id="view-logs" class="view-section">
            <div class="card-glass">
                <h5 class="fw-bold mb-4">å…¨ç½‘å®¡è®¡æ—¥å¿—</h5>
                <table class="table-modern">
                    <thead><tr><th>ç±»å‹</th><th>è¯¦æƒ…</th><th>Hash</th></tr></thead>
                    <tbody id="logs-table"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // ==================== âš™ï¸ é…ç½®åŒº ====================
        // è¯·å¡«å…¥ SystemV9 (æˆ–V9.1) çš„åˆçº¦åœ°å€
        const ADDR_HKC    = "å¡«å…¥HKCåœ°å€";
        const ADDR_ID     = "å¡«å…¥èº«ä»½åˆçº¦åœ°å€";
        const ADDR_MARKET = "å¡«å…¥å¸‚åœºåˆçº¦åœ°å€";
        
        const RPC_URL     = "https://ethereum-sepolia.publicnode.com";
        // ==================================================

        // å®Œæ•´ ABI (æ”¯æŒ getAdminOrg, rootIssue, etc)
        const ABI_ID = ["function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function addIssuer(address,string) external", "function revokeIssuer(address) external", "function getAdminOrg(address) view returns (address)", "function owner() view returns (address)", "function rootIssue(address,string,string,uint256) external"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "event TradeExecuted(address,string,uint256,string,uint256,uint256)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC, provider;

        window.onload = async () => {
            // å…é’±åŒ…åˆå§‹åŒ–
            provider = new ethers.providers.JsonRpcProvider(RPC_URL);
            initContracts(provider);
            loadAssets();
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("é”™è¯¯", "è¯·å®‰è£… MetaMask", "error");
            try {
                const p = new ethers.providers.Web3Provider(window.ethereum);
                await p.send("eth_requestAccounts", []);
                signer = p.getSigner();
                myAddr = await signer.getAddress();
                
                // UI æ›´æ–°
                document.getElementById("btn-conn").classList.add("d-none");
                document.getElementById("user-badge").classList.remove("d-none");
                document.getElementById("wallet-display").innerText = myAddr.slice(0,6)+"...";
                
                initContracts(signer);
                await checkRoleAndUI(); // æ£€æŸ¥æƒé™
                refreshAll();
            } catch(e) { console.error(e); }
        }

        // ğŸ”¥ ä¿®å¤åçš„æƒé™æ£€æŸ¥é€»è¾‘ ğŸ”¥
        async function checkRoleAndUI() {
            const roleDisp = document.getElementById("my-role-display");
            const orgDisp = document.getElementById("my-org-display");
            
            try {
                const owner = await cID.owner();
                
                // 1. Root
                if(owner.toLowerCase() === myAddr.toLowerCase()) {
                    roleDisp.innerText = "Root Admin";
                    orgDisp.innerText = "System Owner";
                    showMenus(".root-only, .admin-only");
                    return;
                }

                // 2. Admin (è°ƒç”¨ getAdminOrg)
                // å¦‚æœ SystemV9.sol é‡Œæ²¡æœ‰è¿™ä¸ªå‡½æ•°ï¼Œä¼šæŠ¥é”™è¿›å…¥ catch
                const orgAddr = await cID.getAdminOrg(myAddr);
                if(orgAddr !== "0x0000000000000000000000000000000000000000") {
                    const orgInfo = await cID.issuers(orgAddr);
                    roleDisp.innerText = "æœºæ„ç®¡ç†å‘˜";
                    orgDisp.innerText = "æ‰€å±: " + orgInfo.name;
                    showMenus(".admin-only");
                    hideMenus(".root-only");
                    return;
                }

                // 3. User
                const id = await cID.identities(myAddr);
                if(id.isValid) {
                    roleDisp.innerText = id.role;
                    orgDisp.innerText = "Region: " + id.region;
                } else {
                    roleDisp.innerText = "æœªè®¤è¯ç”¨æˆ·";
                    orgDisp.innerText = "æ— æœ‰æ•ˆ DID";
                }
                hideMenus(".admin-only, .root-only");

            } catch(e) {
                console.warn("æƒé™æ£€æŸ¥éƒ¨åˆ†å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ—§åˆçº¦ä¸åŒ…å« getAdminOrg");
                // é™çº§å¤„ç†ï¼šå¦‚æœæ˜¯ User é€»è¾‘
                hideMenus(".admin-only, .root-only");
            }
        }

        function showMenus(selector) { document.querySelectorAll(selector).forEach(e => e.style.setProperty("display", "block", "important")); }
        function hideMenus(selector) { document.querySelectorAll(selector).forEach(e => e.style.setProperty("display", "none", "important")); }

        async function ensureSigner() {
            if(signer) return true;
            await connectWallet();
            return !!signer;
        }

        async function tx(p, msg) {
            if(!await ensureSigner()) return;
            try {
                Swal.fire({title:'ç­‰å¾…ç¡®è®¤...', didOpen:()=>Swal.showLoading()});
                const t = await p;
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
                await t.wait();
                Swal.fire("æˆåŠŸ", msg, "success");
                refreshAll();
            } catch(e) { Swal.fire("é”™è¯¯", e.reason||e.message, "error"); }
        }

        function refreshAll() { loadAssets(); if(signer) { loadUserData(); loadProposals(); loadIssuerList(); loadLogs(); } }

        // --- Loaders ---
        async function loadAssets() {
            const g=document.getElementById("market-grid"), t=document.getElementById("admin-table");
            if(!cMKT) return; g.innerHTML=""; t.innerHTML="";
            const c = await cMKT.assetCount();
            if(c.toNumber()===0) g.innerHTML="<div class='col-12 text-center text-muted py-5'>æš‚æ— ä¸Šæ¶èµ„äº§</div>";
            for(let i=1; i<=c; i++) {
                const a = await cMKT.assets(i);
                if(a.isActive) {
                    const hue = (i*137)%360;
                    g.innerHTML+=`
                    <div class="col-md-6 col-lg-4">
                        <div class="asset-card">
                            <div class="asset-visual">
                                ${a.name.substring(0,2).toUpperCase()}
                                <span class="asset-tag">${a.requiredRegion||'GLOBAL'}</span>
                            </div>
                            <div class="asset-info">
                                <h5 class="asset-title">${a.name}</h5>
                                <p class="asset-subtitle">RWA Tokenized Asset #${i}</p>
                                <div class="d-flex justify-content-between align-items-end">
                                    <div class="asset-price">${a.price} <small>HKC</small></div>
                                    <button class="btn-buy" onclick="buy(${i})">ç«‹å³è´­ä¹°</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                t.innerHTML+=`<tr><td>${i}</td><td>${a.name}</td><td>${a.price} HKC</td><td>${a.isActive?'<span class="text-success">ä¸Šæ¶</span>':'<span class="text-danger">ä¸‹æ¶</span>'}</td><td><button onclick="toggle(${i},${!a.isActive})" class="btn btn-sm btn-outline-secondary">åˆ‡æ¢çŠ¶æ€</button></td></tr>`;
            }
        }

        async function loadUserData() {
            if(!signer) return;
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];
            
            const g = document.getElementById("inventory-grid"); g.innerHTML="";
            const c = await cMKT.assetCount();
            let has=false;
            for(let i=1; i<=c; i++) {
                const b = await cMKT.userBalances(myAddr, i);
                if(b.gt(0)) {
                    has=true; const a = await cMKT.assets(i);
                    g.innerHTML+=`<div class="col-md-4"><div class="card-glass text-center"><h5 class="fw-bold">${a.name}</h5><div class="my-3"><span class="badge bg-success fs-6">æŒæœ‰: ${b}</span></div><button onclick="sell(${i},'${a.name}',${a.price})" class="btn btn-danger w-100 fw-bold">å–å‡ºå˜ç°</button></div></div>`;
                }
            }
            if(!has) g.innerHTML="<div class='col-12 text-center text-muted py-5'>æš‚æ— æŒä»“</div>";
        }

        async function loadProposals() {
            const t = document.getElementById("proposal-table"); t.innerHTML="";
            try {
                const c = await cID.proposalCount();
                let has=false;
                for(let i=c; i>Math.max(0,c-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) { has=true; t.innerHTML+=`<tr><td>#${p.id}</td><td>${p.targetUser.slice(0,6)}...</td><td><span class="badge bg-info">${p.role}</span></td><td>${p.proposer.slice(0,6)}...</td><td><button onclick="approveID(${p.id})" class="btn btn-sm btn-success">æ‰¹å‡†</button></td></tr>`; }
                }
                if(!has) t.innerHTML="<tr><td colspan='5' class='text-center text-muted py-4'>æ— å¾…åŠäº‹é¡¹</td></tr>";
            } catch(e){}
        }
        
        async function loadIssuerList() {
            const t = document.getElementById("issuer-list-tbody"); t.innerHTML="";
            try {
                const l = await cID.getAllIssuers();
                for(let a of l) { const i = await cID.issuers(a); if(i.name) t.innerHTML+=`<tr><td><strong>${i.name}</strong></td><td class="text-muted font-monospace">${a}</td><td>${i.isActive?'<span class="badge bg-success">Active</span>':'<span class="badge bg-danger">Revoked</span>'}</td></tr>`; }
            } catch(e){}
        }

        async function loadLogs() {
            const t=document.getElementById("logs-table"); t.innerHTML="";
            const l=await cMKT.queryFilter("TradeExecuted", -5000);
            for(let i=l.length-1; i>=0; i--) {
                const e=l[i]; t.innerHTML+=`<tr><td><span class="badge bg-primary">${e.args.type_}</span></td><td>ç”¨æˆ· ${e.args.user.slice(0,6)} æ“ä½œäº† ${e.args.assetName}</td><td><a href="https://sepolia.etherscan.io/tx/${e.transactionHash}" target="_blank" class="text-decoration-none">View</a></td></tr>`;
            }
        }

        // Actions
        function approveHKC() { tx(cHKC.connect(signer).approve(ADDR_MARKET, ethers.constants.MaxUint256), "èµ„é‡‘æˆæƒæˆåŠŸ"); }
        function buy(id) { tx(cMKT.connect(signer).buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
        function sell(id,n,p) { tx(cMKT.connect(signer).sellAsset(id), `æˆåŠŸå–å‡º ${n}ï¼Œè·å¾— ${p} HKC`); }
        function addAsset() { tx(cMKT.connect(signer).addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, "", "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }
        function toggle(id,s) { tx(cMKT.connect(signer).setAssetStatus(id,s), "çŠ¶æ€æ›´æ–°"); }
        function govAdd() { tx(cID.connect(signer).addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value), "æˆæƒæˆåŠŸ"); }
        
        function proposeID() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.connect(signer).proposeIdentity(u,r,role,365), "ææ¡ˆå·²æäº¤ï¼Œè¯·å¤æ ¸");
        }
        async function approveID(id) {
            const p=await cID.getProposal(id);
            if(p.proposer.toLowerCase()===myAddr.toLowerCase()) return Swal.fire("æƒé™é™åˆ¶","ä¸èƒ½å®¡æ‰¹è‡ªå·±å‘èµ·çš„ææ¡ˆ (Maker-Checker)","error");
            tx(cID.connect(signer).approveIdentity(id), "å®¡æ‰¹é€šè¿‡ï¼Œèº«ä»½å·²ç”Ÿæˆ");
        }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
            document.getElementById('page-header-title').innerText = {market:'äº¤æ˜“å¸‚åœº',profile:'æˆ‘çš„èµ„äº§',issuer:'å¤šç­¾å‘è¯',admin:'èµ„äº§ç®¡ç†',gov:'æœºæ„ç›‘ç®¡',logs:'å®¡è®¡æ—¥å¿—'}[p];
            if(signer) {
                if(p==='issuer') loadProposals();
                if(p==='gov') loadIssuerList();
                if(p==='logs') loadLogs();
            }
        }
    </script>
</body>
</html>
