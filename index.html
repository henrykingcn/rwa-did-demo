<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKUST RWA Platform V6</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --sidebar-width: 260px; --primary-color: #2c3e50; --accent-color: #3498db; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { height: 100vh; width: var(--sidebar-width); position: fixed; top: 0; left: 0; background: var(--primary-color); color: white; padding-top: 20px; z-index: 1000; transition: 0.3s; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 0.95rem; color: #bdc3c7; display: block; transition: 0.2s; cursor: pointer; border-left: 4px solid transparent; }
        .sidebar a:hover, .sidebar a.active { background: rgba(0,0,0,0.2); color: #fff; border-left-color: var(--accent-color); }
        .sidebar i { width: 25px; text-align: center; margin-right: 10px; }

        /* ä¸»å†…å®¹åŒº */
        .main-content { margin-left: var(--sidebar-width); padding: 20px; }
        .top-bar { background: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* å¡ç‰‡ä¸è¡¨æ ¼ */
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); background: white; margin-bottom: 20px; overflow: hidden; }
        .card-header-custom { background: white; padding: 20px; border-bottom: 1px solid #f1f1f1; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .table-custom th { background-color: #f8f9fa; font-weight: 600; color: #666; border-top: none; }
        .table-custom td { vertical-align: middle; }

        /* èµ„äº§å¡ç‰‡ */
        .asset-card { transition: 0.3s; border: none; border-radius: 15px; overflow: hidden; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); height: 100%; position: relative; }
        .asset-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .asset-img { height: 180px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: bold; position: relative; }
        .asset-badge { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; backdrop-filter: blur(5px); }

        /* çŠ¶æ€å¾½ç«  */
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-green { background-color: #2ecc71; }
        .dot-red { background-color: #e74c3c; }
        
        /* é¡µé¢åˆ‡æ¢ */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ä¸ªäººä¸­å¿ƒç»Ÿè®¡å¡ */
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .stat-num { font-size: 2.5rem; font-weight: bold; }
        .stat-label { opacity: 0.8; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <h4>ğŸ¦ RWA Lab V6</h4>
            <small class="text-muted" style="font-size:0.7rem">Built for HKUST Demo</small>
        </div>
        <a onclick="nav('market')" class="active" id="nav-market"><i class="fas fa-store"></i> èµ„äº§å¸‚åœº (Market)</a>
        <a onclick="nav('profile')" id="nav-profile"><i class="fas fa-user-circle"></i> ä¸ªäººä¸­å¿ƒ (Profile)</a>
        <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 20px;">
        <small style="padding: 0 25px; color: #666; font-weight:bold; text-transform:uppercase;">Management</small>
        <a onclick="nav('admin-assets')" id="nav-admin-assets"><i class="fas fa-box"></i> èµ„äº§ç®¡ç†</a>
        <a onclick="nav('admin-users')" id="nav-admin-users"><i class="fas fa-users-cog"></i> ç”¨æˆ·ä¸æœºæ„ç®¡ç†</a>
        <a onclick="nav('logs')" id="nav-logs"><i class="fas fa-history"></i> å…¨å±€å®¡è®¡æ—¥å¿—</a>
    </nav>

    <div class="main-content">
        
        <div class="top-bar">
            <div><h4 id="page-title" class="m-0 fw-bold">èµ„äº§äº¤æ˜“å¸‚åœº</h4></div>
            <div class="d-flex align-items-center gap-3">
                <div id="wallet-info-box" class="d-none align-items-center gap-2">
                    <span class="badge bg-light text-dark border"><i class="fas fa-coins text-warning"></i> <span id="hkc-bal">-</span> HKC</span>
                    <span class="badge bg-light text-dark border" id="id-status-badge">æ£€æŸ¥èº«ä»½...</span>
                </div>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary btn-sm shadow-sm"><i class="fas fa-wallet"></i> è¿æ¥é’±åŒ…</button>
                <span id="addr-display" class="text-muted small fw-bold"></span>
            </div>
        </div>

        <div id="view-market" class="view-section active">
            <div class="row" id="market-grid">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">æ­£åœ¨é€šè¿‡ RPC èŠ‚ç‚¹è¯»å–é“¾ä¸Šèµ„äº§...</p>
                </div>
            </div>
        </div>

        <div id="view-profile" class="view-section">
            <div id="profile-lock" class="text-center py-5">
                <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                <h5>è¯·è¿æ¥é’±åŒ…æŸ¥çœ‹ä¸ªäººèµ„äº§</h5>
                <button class="btn btn-primary mt-2" onclick="connectWallet()">ç«‹å³è¿æ¥</button>
            </div>

            <div id="profile-content" class="d-none">
                <div class="row">
                    <div class="col-md-8">
                        <div class="stat-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="stat-label">å½“å‰èº«ä»½ (Identity)</div>
                                    <div class="stat-num" style="font-size:1.8rem" id="my-role">Loading...</div>
                                    <div id="my-region" class="badge bg-white text-primary mt-2">Region: -</div>
                                    <div id="my-issuer" class="mt-2 small text-white-50">Issuer: -</div>
                                </div>
                                <i class="fas fa-id-card fa-4x text-white-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="stat-card" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
                            <div class="stat-label">æŒæœ‰èµ„äº§æ•°</div>
                            <div class="stat-num" id="my-asset-count">0</div>
                            <div class="mt-2 small text-white-50">å·²ç¡®æƒ RWA</div>
                         </div>
                    </div>
                </div>

                <h5 class="mb-3 mt-4 fw-bold"><i class="fas fa-box-open text-primary"></i> æˆ‘çš„èµ„äº§åº“ (Inventory)</h5>
                <div class="card-custom">
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead><tr><th>è´­ä¹°æ—¶é—´</th><th>èµ„äº§åç§°</th><th>æˆäº¤ä»·æ ¼</th><th>äº¤æ˜“å“ˆå¸Œ</th></tr></thead>
                            <tbody id="my-inventory-table">
                                <tr><td colspan="4" class="text-center text-muted py-4">æš‚æ— è´­ä¹°è®°å½•</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin-assets" class="view-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="card-custom p-3">
                        <h5 class="mb-3">ä¸Šæ¶æ–°èµ„äº§</h5>
                        <input type="text" class="form-control mb-2" id="newAssetName" placeholder="èµ„äº§åç§°">
                        <input type="number" class="form-control mb-2" id="newAssetPrice" placeholder="ä»·æ ¼ (HKC)">
                        <select class="form-select mb-2" id="newAssetRegion">
                            <option value="">ğŸŒ å…¨çƒ (Global)</option>
                            <option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯ (HK Only)</option>
                            <option value="US">ğŸ‡ºğŸ‡¸ ç¾å›½ (US Only)</option>
                        </select>
                        <button class="btn btn-success w-100" onclick="addAsset()">ä¸Šæ¶</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-custom">
                        <div class="table-responsive">
                            <table class="table table-custom mb-0">
                                <thead><tr><th>ID</th><th>åç§°</th><th>ä»·æ ¼</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="admin-asset-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin-users" class="view-section">
            
            <div class="card-custom p-3 bg-light border">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="small fw-bold text-muted">ç”¨æˆ·åœ°å€</label>
                        <input type="text" class="form-control form-control-sm" id="targetUser" placeholder="0x...">
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted">åœ°åŒº</label>
                        <select class="form-select form-select-sm" id="targetRegion"><option value="HK">HK</option><option value="CN">CN</option><option value="US">US</option></select>
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted">è§’è‰²</label>
                        <select class="form-select form-select-sm" id="targetRole"><option value="Student">Student</option><option value="Investor">Investor</option></select>
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted">å‘è¯æœºæ„</label>
                        <select class="form-select form-select-sm" id="targetType"><option value="user">å‘ç»™ç”¨æˆ·</option><option value="issuer">è®¾ä¸ºæœºæ„</option></select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-warning btn-sm w-100 fw-bold text-white" onclick="issueAction()">æ‰§è¡Œé¢å‘</button>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <span>ğŸ›ï¸ æœºæ„åå• (Issuers)</span>
                            <button class="btn btn-xs btn-outline-secondary" onclick="refreshAdminData()"><i class="fas fa-sync"></i></button>
                        </div>
                        <table class="table table-custom mb-0 table-sm" style="font-size:0.9rem">
                            <thead><tr><th>åç§°</th><th>åœ°å€</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="issuer-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <span>ğŸ‘¥ å·²å‘è¯ç”¨æˆ· (All Users)</span>
                            <small class="text-muted">åŸºäºé“¾ä¸Šæ—¥å¿—</small>
                        </div>
                        <table class="table table-custom mb-0 table-sm" style="font-size:0.9rem">
                            <thead><tr><th>åœ°å€</th><th>åœ°åŒº/è§’è‰²</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="user-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-logs" class="view-section">
            <ul class="nav nav-tabs mb-3" id="logTabs">
                <li class="nav-item"><a class="nav-link active" onclick="switchLogTab('trade')">RWA äº¤æ˜“è®°å½•</a></li>
                <li class="nav-item"><a class="nav-link" onclick="switchLogTab('identity')">èº«ä»½/åŠé”€è®°å½•</a></li>
            </ul>

            <div class="card-custom">
                <div class="table-responsive">
                    <table class="table table-striped mb-0" id="log-table">
                        </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // âš ï¸ è¯·å¡«å…¥ä½ çš„ V4/V5 åˆçº¦åœ°å€
        // =================================================================
        const ADDR_HKC      = "0xB0B8c886C6e8469C43bB309452a7f3C911681453";
        const ADDR_ID       = "0xA69098Bc7077cB3011D8E6d670A858669Ac3a034";
        const ADDR_MARKET   = "0x1ae6c3DE25A0aDBF01a600E1F960321567020a12";

        // ğŸš€ ä¿®å¤ç‚¹ 1ï¼šä½¿ç”¨æ›´ç¨³å®šçš„å…¬å…±èŠ‚ç‚¹ (Cloudflare æˆ– PublicNode)
        // è¿™äº›èŠ‚ç‚¹é€šå¸¸å…è®¸æµè§ˆå™¨ç›´æ¥è®¿é—®
        const RPC_URLS = [
            "https://ethereum-sepolia.publicnode.com",
            "https://sepolia.drpc.org",
            "https://rpc.sepolia.org"
        ];
        // =================================================================

        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)", "function allowance(address,address) view returns (uint256)"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function setAssetStatus(uint256, bool) external", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "event TradeExecuted(address indexed user, uint256 assetId, string assetName, uint256 price, uint256 timestamp)"];
        const ABI_ID = ["function addIssuer(address,string) external", "function revokeIssuer(address) external", "function issueIdentity(address,string,string,uint256) external", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function checkCompliance(address,string,address) view returns (bool, string)", "event IssuerAdded(address indexed issuer, string name)", "event IssuerRevoked(address indexed issuer)", "event IdentityIssued(address indexed user, address indexed issuer, string region)"];

        let provider, signer, myAddr;
        let cID, cMKT, cHKC;

        // åˆå§‹åŒ–ï¼šå°è¯•è¿æ¥ RPC èŠ‚ç‚¹å®ç°å…é’±åŒ…æµè§ˆ
        window.onload = async () => {
            console.log("æ­£åœ¨å°è¯•å…é’±åŒ…è¿æ¥...");
            // å°è¯•åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªèƒ½ç”¨
            for (let url of RPC_URLS) {
                try {
                    const tempProvider = new ethers.providers.JsonRpcProvider(url);
                    // ç®€å•çš„æµ‹è¯•è°ƒç”¨ï¼Œçœ‹èŠ‚ç‚¹æ´»ä¸æ´»ç€
                    await tempProvider.getBlockNumber(); 
                    console.log("RPC è¿æ¥æˆåŠŸ:", url);
                    
                    // åˆå§‹åŒ–åªè¯»åˆçº¦
                    cID = new ethers.Contract(ADDR_ID, ABI_ID, tempProvider);
                    cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, tempProvider);
                    cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, tempProvider);
                    
                    // åŠ è½½èµ„äº§åˆ—è¡¨
                    loadMarketAssets();
                    return; // æˆåŠŸå°±é€€å‡º
                } catch(e) {
                    console.warn("RPC èŠ‚ç‚¹å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª:", url);
                }
            }
            console.error("æ‰€æœ‰ RPC èŠ‚ç‚¹éƒ½æ— æ³•è¿æ¥ï¼Œè¯·æç¤ºç”¨æˆ·è¿æ¥é’±åŒ…");
            document.getElementById("market-grid").innerHTML = "<div class='text-center py-5 text-muted'>ç½‘ç»œåŠ è½½ç¼“æ…¢ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ <b class='text-primary'>è¿æ¥é’±åŒ…</b> ä»¥æŸ¥çœ‹æ•°æ®</div>";
        };

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("é”™è¯¯", "è¯·å®‰è£… MetaMask", "error");
            const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
            await web3Provider.send("eth_requestAccounts", []);
            signer = web3Provider.getSigner();
            myAddr = await signer.getAddress();

            // è¦†ç›–åˆçº¦å®ä¾‹ (å¸¦ Signer)
            cID = new ethers.Contract(ADDR_ID, ABI_ID, signer);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, signer);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, signer);
            
            // UI æ›´æ–°
            document.getElementById("btn-conn").style.display = "none";
            document.getElementById("wallet-info-box").classList.remove("d-none");
            document.getElementById("wallet-info-box").classList.add("d-flex");
            document.getElementById("addr-display").innerText = myAddr.slice(0,6) + "...";

            // åŠ è½½ç”¨æˆ·æ•°æ®
            loadUserData();
            loadMarketAssets(); // ç”¨é’±åŒ…èŠ‚ç‚¹å†åˆ·ä¸€æ¬¡ï¼Œç¡®ä¿å‡†ç¡®
        }

        // ------------------ æ ¸å¿ƒé€»è¾‘ä¿®å¤ ------------------

        async function loadMarketAssets() {
            const grid = document.getElementById("market-grid");
            const table = document.getElementById("admin-asset-table");
            if(!cMKT) return;

            try {
                const count = await cMKT.assetCount();
                if(count.toNumber() === 0) {
                    grid.innerHTML = "<div class='text-center py-5 text-muted'>æš‚æ— ä¸Šæ¶èµ„äº§</div>";
                    return;
                }
                
                let marketHtml = "";
                let adminHtml = "";

                for(let i=1; i<=count; i++) {
                    const a = await cMKT.assets(i);
                    // Admin View
                    adminHtml += `<tr><td>${i}</td><td>${a.name}</td><td>${a.price}</td>
                        <td>${a.isActive?'<span class="text-success">ä¸Šæ¶</span>':'<span class="text-danger">ä¸‹æ¶</span>'}</td>
                        <td><button class="btn btn-sm btn-outline-dark" onclick="toggleAsset(${i},${!a.isActive})">${a.isActive?'ä¸‹æ¶':'ä¸Šæ¶'}</button></td></tr>`;

                    // Market View
                    if(a.isActive) {
                        const hue = (i * 137) % 360;
                        marketHtml += `
                        <div class="col-md-4 col-lg-3 mb-4">
                            <div class="asset-card">
                                <div class="asset-img" style="background: linear-gradient(45deg, hsl(${hue}, 70%, 60%), hsl(${hue+60}, 70%, 60%))">
                                    ${a.name.substring(0,2).toUpperCase()}
                                    <span class="asset-badge">${a.requiredRegion || 'GLOBAL'}</span>
                                </div>
                                <div class="p-3">
                                    <h5 class="text-truncate fw-bold">${a.name}</h5>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="text-primary fw-bold fs-5">${a.price} HKC</span>
                                        <button class="btn btn-primary btn-sm px-3" onclick="smartBuy(${i}, '${a.name}', ${a.price}, '${a.requiredRegion}', '${a.requiredIssuer}')">Buy</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                }
                grid.innerHTML = marketHtml;
                table.innerHTML = adminHtml;

            } catch(e) { console.error(e); }
        }

        async function loadUserData() {
            // 1. ä½™é¢
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];

            // 2. èº«ä»½
            const id = await cID.identities(myAddr);
            const badge = document.getElementById("id-status-badge");
            const profileLock = document.getElementById("profile-lock");
            const profileContent = document.getElementById("profile-content");

            if(id.isValid && Date.now()/1000 < id.expiry) {
                badge.className = "badge bg-success"; badge.innerHTML = `âœ” ${id.region} ${id.role}`;
                document.getElementById("my-role").innerText = id.role;
                document.getElementById("my-region").innerText = "Region: " + id.region;
                document.getElementById("my-issuer").innerText = "Issuer: " + id.issuedBy.slice(0,8)+"...";
            } else {
                badge.className = "badge bg-danger"; badge.innerHTML = `âŒ æ— æ•ˆèº«ä»½`;
                document.getElementById("my-role").innerText = "No Identity";
            }

            profileLock.classList.add('d-none');
            profileContent.classList.remove('d-none');

            loadMyInventory();
        }

        // ğŸš€ æš´åŠ›ä¿®å¤ç‰ˆï¼šåŠ è½½ä¸ªäººèµ„äº§
        async function loadMyInventory() {
            const table = document.getElementById("my-inventory-table");
            const countDisplay = document.getElementById("my-asset-count");
            
            if (!myAddr) return;

            table.innerHTML = "<tr><td colspan='4' class='text-center'><div class='spinner-border spinner-border-sm text-primary'></div> æ­£åœ¨æš´åŠ›æ£€ç´¢é“¾ä¸Šæ•°æ®...</td></tr>";

            try {
                // 1. æ‰©å¤§æœç´¢èŒƒå›´ï¼šæŸ¥æœ€è¿‘ 100,000 ä¸ªåŒºå— (æ¶µç›–è¿‡å» 3-4 å¤©çš„äº¤æ˜“)
                // ä½¿ç”¨è´Ÿæ•°è¡¨ç¤ºâ€œä»æœ€æ–°åŒºå—å€’æ¨â€
                const fromBlock = -100000; 

                console.log(`æ­£åœ¨æŠ“å–æœ€è¿‘ ${Math.abs(fromBlock)} ä¸ªåŒºå—çš„æ‰€æœ‰äº¤æ˜“...`);

                // 2. å…³é”®ä¿®æ”¹ï¼šä¸å†å‘èŠ‚ç‚¹å‘é€è¿‡æ»¤æ¡ä»¶ï¼Œè€Œæ˜¯æŸ¥è¯¢â€œæ‰€æœ‰äº¤æ˜“â€
                // å…¬å…±èŠ‚ç‚¹å¯¹ "filter(myAddr)" çš„æ”¯æŒå¾ˆå·®ï¼Œä½†å¯¹ "filterAll" æ”¯æŒå¾ˆå¥½
                const filter = cMKT.filters.TradeExecuted(); 
                const allLogs = await cMKT.queryFilter(filter, fromBlock, "latest");
                
                console.log(`å…¨ç½‘å…±æ£€ç´¢åˆ° ${allLogs.length} ç¬”äº¤æ˜“`);

                // 3. åœ¨æœ¬åœ° JS é‡Œè¿‡æ»¤å±äºæˆ‘çš„äº¤æ˜“ (Client-side Filtering)
                // æ³¨æ„ï¼šåœ°å€è¦è½¬å°å†™æ¯”è¾ƒï¼Œé˜²æ­¢å¤§å°å†™æ•æ„Ÿé—®é¢˜
                const myLogs = allLogs.filter(log => 
                    log.args.user.toLowerCase() === myAddr.toLowerCase()
                );

                console.log(`å…¶ä¸­å±äºæˆ‘çš„æœ‰ ${myLogs.length} ç¬”`);
                
                // æ›´æ–°æ•°é‡æ˜¾ç¤º
                countDisplay.innerText = myLogs.length;
                
                if(myLogs.length === 0) {
                    table.innerHTML = `
                        <tr><td colspan='4' class='text-center text-muted py-4'>
                            <p class="mb-1">æœ€è¿‘ 3 å¤©å†…æ— äº¤æ˜“ã€‚</p>
                            <a href="https://sepolia.etherscan.io/address/${myAddr}#tokentxns" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                <i class="fas fa-external-link-alt"></i> æŸ¥çœ‹æ›´æ—©çš„å†å² (Etherscan)
                            </a>
                        </td></tr>`;
                    return;
                }
                
                let html = "";
                // å€’åºæ˜¾ç¤º (æœ€æ–°çš„åœ¨ä¸Šé¢)
                for(let i=myLogs.length-1; i>=0; i--) {
                    const log = myLogs[i];
                    html += `
                        <tr>
                            <td><span class="badge bg-success">Confirmed âœ…</span></td>
                            <td class="fw-bold text-primary">${log.args.assetName}</td>
                            <td>${log.args.price} HKC</td>
                            <td><a href="https://sepolia.etherscan.io/tx/${log.transactionHash}" target="_blank" class="btn btn-xs btn-light border">View â†—</a></td>
                        </tr>
                    `;
                }
                table.innerHTML = html;

            } catch(e) {
                console.error("æ—¥å¿—åŠ è½½å¤±è´¥:", e);
                table.innerHTML = `<tr><td colspan='4' class='text-center text-danger'>æ•°æ®åŒæ­¥å»¶è¿Ÿï¼Œè¯·ç›´æ¥ç‚¹å‡» Etherscan æŸ¥çœ‹</td></tr>`;
            }
        }

        // Admin: åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
        async function refreshAdminData() {
            if(!signer) return Swal.fire("è¯·å…ˆè¿æ¥é’±åŒ…");
            
            // åŠ è½½æœºæ„
            const issuerTbody = document.getElementById("issuer-list-tbody");
            issuerTbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
            try {
                const list = await cID.getAllIssuers();
                let html = "";
                for(let addr of list) {
                    const info = await cID.issuers(addr);
                    if(info.name) {
                        html += `<tr><td>${info.name}</td><td class="small text-muted">${addr.slice(0,8)}...</td>
                                <td>${info.isActive?'<span class="badge bg-success">Active</span>':'<span class="badge bg-danger">Revoked</span>'}</td>
                                <td><button class="btn btn-xs btn-outline-danger" onclick="revokeIssuer('${addr}')">åŠé”€</button></td></tr>`;
                    }
                }
                issuerTbody.innerHTML = html;
            } catch(e){ issuerTbody.innerHTML = ""; }

            // åŠ è½½ç”¨æˆ· (æœ€è¿‘ 5ä¸‡åŒºå—)
            const userTbody = document.getElementById("user-list-tbody");
            userTbody.innerHTML = "<tr><td colspan='4' class='text-center'>æ­£åœ¨ç´¢å¼•...</td></tr>";
            
            try {
                const currentBlock = await cID.provider.getBlockNumber();
                const fromBlock = Math.max(0, currentBlock - 50000); 
                const logs = await cID.queryFilter("IdentityIssued", fromBlock, "latest");
                
                const userMap = new Map();
                for(let log of logs) {
                    userMap.set(log.args.user, { region: log.args.region });
                }

                let uHtml = "";
                for(let [addr, data] of userMap) {
                    const info = await cID.identities(addr);
                    const isExpired = Date.now()/1000 > info.expiry;
                    uHtml += `<tr><td class="small">${addr.slice(0,8)}...</td><td class="small">${data.region} / ${info.role}</td>
                        <td>${(info.isValid && !isExpired)?'<span class="badge bg-success">æœ‰æ•ˆ</span>':'<span class="badge bg-secondary">æ— æ•ˆ</span>'}</td>
                        <td><button class="btn btn-xs btn-outline-danger" onclick="revokeUser('${addr}')">åŠé”€</button></td></tr>`;
                }
                userTbody.innerHTML = uHtml || "<tr><td colspan='4' class='text-center'>æš‚æ— å‘è¯è®°å½•</td></tr>";
            } catch(e) { userTbody.innerHTML = "<tr><td colspan='4' class='text-danger'>ç´¢å¼•è¶…æ—¶</td></tr>"; }
        }

        // å…¨å±€æ—¥å¿—
        async function loadGlobalLogs() {
            const table = document.getElementById("log-trade-table");
            table.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
            // ç®€å•åŠ è½½æœ€è¿‘ 20 æ¡ TradeExecutedï¼Œä¸é™åˆ¶åŒºå—ï¼ˆé»˜è®¤ RPC å¯èƒ½åªç»™æœ€è¿‘çš„ï¼‰
            // å¦‚æœè¿˜æ˜¯æŠ¥é”™ï¼Œå¯ä»¥åŠ ä¸ŠåŒºå—é™åˆ¶
            const logs = await cMKT.queryFilter("TradeExecuted"); 
            let html = "";
            for(let i=logs.length-1; i>=Math.max(0, logs.length-20); i--) {
                const l = logs[i];
                html += `<tr><td>${l.args.user.slice(0,6)}...</td><td>${l.args.assetName}</td><td>${l.args.price}</td><td><a href="https://sepolia.etherscan.io/tx/${l.transactionHash}" target="_blank">View</a></td></tr>`;
            }
            table.innerHTML = html;
        }

        // äº¤äº’ Action
        async function smartBuy(id, name, price, reqRegion, reqIssuer) {
            Swal.fire({ title: 'æ‰§è¡Œåˆè§„æ£€æŸ¥...', html: 'æ­£åœ¨éªŒè¯é“¾ä¸Šèº«ä»½è§„åˆ™...', didOpen:()=>Swal.showLoading() });
            try {
                // Pre-flight check
                const compliant = await cID.checkCompliance(myAddr, reqRegion, reqIssuer);
                if(!compliant[0]) throw new Error("åˆè§„éªŒè¯å¤±è´¥: " + compliant[1]);
                
                const bal = await cHKC.balanceOf(myAddr);
                const priceWei = ethers.utils.parseUnits(price.toString(), 18);
                if(bal.lt(priceWei)) throw new Error("ä½™é¢ä¸è¶³");

                const allowance = await cHKC.allowance(myAddr, ADDR_MARKET);
                if(allowance.lt(priceWei)) throw new Error("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’æˆæƒ HKC");

                const tx = await cMKT.buyAsset(id);
                Swal.fire({ title: 'ä¸Šé“¾ä¸­...', html: 'äº¤æ˜“å¹¿æ’­æˆåŠŸï¼Œç­‰å¾…ç¡®è®¤...', didOpen:()=>Swal.showLoading() });
                await tx.wait();
                
                Swal.fire("æˆåŠŸ", "èµ„äº§è´­ä¹°å®Œæˆ", "success");
                loadUserData(); // åˆ·æ–°
            } catch(e) { Swal.fire("å¤±è´¥", e.reason||e.message, "error"); }
        }

        async function tx(p) {
            try { Swal.fire({title:'ç¡®è®¤...',didOpen:()=>Swal.showLoading()}); const t=await p; await t.wait(); Swal.fire("æˆåŠŸ","å®Œæˆ","success"); loadMarketAssets(); if(signer) loadUserData(); } catch(e){ Swal.fire("é”™è¯¯",e.reason||e.message,"error"); }
        }

        function approveHKC() { tx(cHKC.approve(ADDR_MARKET, ethers.constants.MaxUint256)); }
        function addAsset() { tx(cMKT.addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, document.getElementById("newAssetRegion").value, "0x0000000000000000000000000000000000000000")); }
        function toggleAsset(id,s) { tx(cMKT.setAssetStatus(id,s)); }
        function govAdd() { tx(cID.addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value)); }
        function govRevoke() { tx(cID.revokeIssuer(document.getElementById("issuerAddr").value)); }
        function revokeIssuer(a) { tx(cID.revokeIssuer(a)); }
        function revokeUser(a) { tx(cID.issueIdentity(a, "REVOKED", "Banned", 0)); }
        function issueAction() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value, type=document.getElementById("targetType").value;
            if(type==='user') tx(cID.issueIdentity(u,r,role,365)); else tx(cID.addIssuer(u,role+" Org"));
        }

        // å¯¼èˆª
        function nav(page) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+page).classList.add('active');
            document.querySelectorAll('.sidebar a').forEach(e => e.classList.remove('active'));
            document.getElementById('nav-'+page).classList.add('active');
            
            const map={'market':'èµ„äº§å¸‚åœº','profile':'ä¸ªäººä¸­å¿ƒ','admin-assets':'èµ„äº§ç®¡ç†','admin-users':'ç”¨æˆ·ä¸æœºæ„','logs':'å®¡è®¡æ—¥å¿—'};
            document.getElementById('page-title').innerText=map[page];

            if(page==='admin-users') refreshAdminData();
            if(page==='logs') loadGlobalLogs();
            if(page==='profile' && signer) loadMyInventory();
        }
    </script>
</body>
</html>
