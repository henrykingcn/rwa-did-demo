<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>HKUST RWA Platform V14</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #2563eb; --bg: #f8fafc; --text: #0f172a;
            --sidebar-w: 260px; --card-bg: #fff;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; }
        
        .sidebar { width: var(--sidebar-w); height: 100vh; position: fixed; background: #fff; border-right: 1px solid #e2e8f0; padding-top: 20px; }
        .nav-item { padding: 12px 24px; color: #64748b; cursor: pointer; display: flex; align-items: center; font-weight: 500; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { color: var(--primary); background: #eff6ff; border-left: 3px solid var(--primary); }
        .nav-item i { width: 24px; margin-right: 10px; }
        
        .main { margin-left: var(--sidebar-w); padding: 30px; }
        .top-bar { background: #fff; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        
        .asset-card { background: #fff; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; transition: 0.3s; }
        .asset-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: #bfdbfe; }
        .asset-img { height: 160px; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 800; color: #94a3b8; }
        
        .admin-only, .root-only { display: none !important; }
        .view-section { display: none; animation: fade 0.3s; } .view-section.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<nav class="sidebar">
    <div class="px-4 mb-4"><h4 class="fw-bold text-primary">ğŸ¦ RWA V14</h4><small class="text-muted">Ultimate Logic</small></div>
    <div onclick="nav('market')" class="nav-item active" id="nav-market"><i class="fas fa-store"></i> äº¤æ˜“å¸‚åœº</div>
    <div onclick="nav('profile')" class="nav-item" id="nav-profile"><i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§</div>
    
    <div class="admin-only mt-3">
        <div class="px-4 mb-2"><small class="fw-bold text-uppercase text-muted" style="font-size:0.7rem">Admin</small></div>
        <div onclick="nav('issuer')" class="nav-item" id="nav-issuer"><i class="fas fa-file-signature"></i> å‘è¯ (Multi-Sig)</div>
    </div>
    
    <div class="root-only mt-3">
        <div class="px-4 mb-2"><small class="fw-bold text-uppercase text-muted" style="font-size:0.7rem">Governance</small></div>
        <div onclick="nav('admin')" class="nav-item" id="nav-admin"><i class="fas fa-layer-group"></i> èµ„äº§ä¸Šæ¶</div>
        <div onclick="nav('gov')" class="nav-item" id="nav-gov"><i class="fas fa-building"></i> æœºæ„ç›‘ç®¡</div>
    </div>
</nav>

<div class="main">
    <div class="top-bar">
        <h5 class="m-0 fw-bold" id="page-title">å¸‚åœº</h5>
        <div class="d-flex gap-3 align-items-center">
            <span class="badge bg-light text-dark border px-3 py-2" id="user-role">Checking...</span>
            <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2" id="hkc-bal">- HKC</span>
            <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary btn-sm rounded-pill px-4">è¿æ¥é’±åŒ…</button>
        </div>
    </div>

    <!-- 1. å¸‚åœº -->
    <div id="view-market" class="view-section active">
        <div class="text-end mb-3"><button class="btn btn-dark btn-sm" onclick="approveHKC()">ğŸ” èµ„é‡‘æˆæƒ</button></div>
        <div class="row g-4" id="market-grid"><div class="text-center py-5">Loading...</div></div>
    </div>

    <!-- 2. ä¸ªäºº -->
    <div id="view-profile" class="view-section">
        <div class="card p-4 bg-primary text-white border-0 mb-4 rounded-4">
            <h5 class="opacity-75">æˆ‘çš„èº«ä»½</h5>
            <h2 class="fw-bold" id="my-role-display">æœªè¿æ¥</h2>
            <span class="badge bg-white bg-opacity-25" id="my-org-display">-</span>
        </div>
        <h5 class="fw-bold mb-3">ğŸ“¦ æŒä»“</h5>
        <div class="row g-4" id="inventory-grid"></div>
    </div>

    <!-- 3. å‘è¯ -->
    <div id="view-issuer" class="view-section">
        <div class="row">
            <div class="col-md-5">
                <div class="card p-4 border-0 shadow-sm rounded-4">
                    <h5 class="text-warning fw-bold" id="issue-title">å‘è¯</h5>
                    <p class="small text-muted" id="issue-desc">...</p>
                    <input id="targetUser" class="form-control mb-2" placeholder="ç”¨æˆ·åœ°å€">
                    <select id="targetRegion" class="form-select mb-2"><option value="HK">HK</option><option value="US">US</option></select>
                    <select id="targetRole" class="form-select mb-3"><option value="Investor">Investor</option><option value="Student">Student</option></select>
                    <div id="issue-btn-area"><button class="btn btn-secondary w-100" disabled>è¯·è¿æ¥</button></div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card p-4 border-0 shadow-sm rounded-4">
                    <h5>å¾…å®¡æ‰¹</h5>
                    <table class="table"><tbody id="proposal-table"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Admin -->
    <div id="view-admin" class="view-section">
        <div class="card p-4 border-0 shadow-sm rounded-4">
            <h5>ä¸Šæ¶èµ„äº§</h5>
            <div class="d-flex gap-2 mb-4">
                <input id="newAssetName" class="form-control" placeholder="åç§°">
                <input id="newAssetPrice" class="form-control" placeholder="ä»·æ ¼">
                <button onclick="addAsset()" class="btn btn-success">ä¸Šæ¶</button>
            </div>
            <table class="table"><tbody id="admin-table"></tbody></table>
        </div>
    </div>

    <!-- 5. Gov -->
    <div id="view-gov" class="view-section">
        <div class="row g-4">
            <div class="col-md-5">
                <div class="card p-4 border-0 shadow-sm rounded-4">
                    <h5 class="text-danger fw-bold">æœºæ„æˆæƒ</h5>
                    <input id="issuerAddr" class="form-control mb-2" placeholder="æœºæ„åœ°å€">
                    <input id="issuerName" class="form-control mb-2" placeholder="åç§°">
                    <div class="d-flex gap-2 mb-4">
                        <button onclick="govAdd()" class="btn btn-danger w-100">æˆæƒ</button>
                        <button onclick="govRevoke()" class="btn btn-outline-danger w-100">åŠé”€</button>
                    </div>
                    <h6 class="fw-bold">ç»‘å®šç®¡ç†å‘˜</h6>
                    <input id="adminAddr" class="form-control mb-2" placeholder="å‘˜å·¥åœ°å€">
                    <input id="bindOrgAddr" class="form-control mb-2" placeholder="æ‰€å±æœºæ„åœ°å€">
                    <button onclick="govAddAdmin()" class="btn btn-primary w-100">ç»‘å®š</button>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card p-4 border-0 shadow-sm rounded-4">
                    <h5>å·²æˆæƒæœºæ„</h5>
                    <table class="table"><tbody id="issuer-list-tbody"></tbody></table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // ==================== âš ï¸ å¡«å…¥ V9.Final åœ°å€ ====================
    const ADDR_HKC      = "0x93E9aDd27FA2D73645954e3dE6fe0D82D640658c";
    const ADDR_ID       = "0xDE8A30dBDF83CE5C96017C433A984609B9dC10B8";
    const ADDR_MARKET   = "0x6c5529aA37A5B678B0fb573d0aC8Aa527F26A1F7";
    const RPC_URL     = "https://ethereum-sepolia.publicnode.com";

    const ABI_ID = ["function rootIssue(address,string,string,uint256) external", "function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function addIssuer(address,string) external", "function revokeIssuer(address) external", "function addAdmin(address,address) external", "function getAdminOrg(address) view returns (address)", "function owner() view returns (address)"];
    const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "event TradeExecuted(address,string,uint256,string,uint256,uint256)"];
    const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

    let signer, myAddr, cID, cMKT, cHKC, provider;

    window.onload = async () => {
        provider = new ethers.providers.JsonRpcProvider(RPC_URL);
        initContracts(provider);
        loadAssets();
    };

    function initContracts(p) {
        cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
        cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
        cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
    }

    async function connectWallet() {
        if(!window.ethereum) return Swal.fire("Error", "MetaMask?", "error");
        const p = new ethers.providers.Web3Provider(window.ethereum);
        await p.send("eth_requestAccounts", []);
        signer = p.getSigner();
        myAddr = await signer.getAddress();
        
        document.getElementById("btn-conn").style.display="none";
        initContracts(signer);
        checkRole();
        refresh();
    }

    async function checkRole() {
        try {
            const owner = await cID.owner();
            const roleBadge = document.getElementById("user-role");
            
            // 1. Root
            if(owner.toLowerCase() === myAddr.toLowerCase()) {
                roleBadge.innerText = "Root Admin";
                document.querySelectorAll(".root-only, .admin-only").forEach(e => e.style.setProperty("display", "block", "important"));
                
                // Root æé€Ÿå‘è¯æŒ‰é’®
                document.getElementById("issue-title").innerHTML = "<span class='text-danger'>ğŸš€ Root æé€Ÿå‘è¯</span>";
                document.getElementById("issue-desc").innerText = "ä¸Šå¸æ¨¡å¼ï¼šæ— éœ€å®¡æ ¸ï¼Œç›´æ¥ç»™è‡ªå·±å‘è¯ã€‚";
                document.getElementById("targetUser").value = myAddr; // è‡ªåŠ¨å¡«è‡ªå·±
                document.getElementById("issue-btn-area").innerHTML = `<button onclick="rootIssue()" class="btn btn-danger w-100 fw-bold">ç»™è‡ªå·±å‘è¯ (Root)</button>`;
                return;
            }

            // 2. Admin
            const orgAddr = await cID.getAdminOrg(myAddr);
            if(orgAddr !== "0x0000000000000000000000000000000000000000") {
                roleBadge.innerText = "Admin";
                document.querySelectorAll(".admin-only").forEach(e => e.style.setProperty("display", "block", "important"));
                
                document.getElementById("issue-title").innerText = "å‘èµ·ææ¡ˆ (Maker)";
                document.getElementById("issue-desc").innerText = "éœ€å¤æ ¸ã€‚";
                document.getElementById("issue-btn-area").innerHTML = `<button onclick="proposeID()" class="btn btn-warning w-100 fw-bold">å‘èµ·ææ¡ˆ</button>`;
                return;
            }

            // 3. User
            const id = await cID.identities(myAddr);
            roleBadge.innerText = id.isValid ? id.role : "æ— èº«ä»½";
            
        } catch(e) { console.log(e); }
    }

    async function ensureSigner() {
        if(signer) return true;
        await connectWallet();
        return !!signer;
    }

    async function tx(p, msg) {
        if(!await ensureSigner()) return;
        try {
            Swal.fire({title:'ç¡®è®¤...', didOpen:()=>Swal.showLoading()});
            const t = await p;
            Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
            await t.wait();
            Swal.fire("æˆåŠŸ", msg, "success");
            refresh();
        } catch(e) { 
            let err = e.reason || e.message;
            if(err.includes("Identity Invalid")) err = "è´­ä¹°å¤±è´¥ï¼šä½ çš„èº«ä»½æ— æ•ˆï¼è¯·å»å‘è¯é¡µé¢ç»™è‡ªå·±å‘ä¸€ä¸ªè¯ã€‚";
            Swal.fire("é”™è¯¯", err, "error"); 
        }
    }

    function refresh() { loadAssets(); if(signer) { loadUserData(); loadProposals(); loadIssuerList(); } }

    // Actions
    function rootIssue() { 
        const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
        tx(cID.connect(signer).rootIssue(u,r,role,365), "Rootå‘è¯æˆåŠŸï¼ç°åœ¨ä½ å¯ä»¥å»ä¹°èµ„äº§äº†ã€‚");
    }
    function proposeID() { 
        const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
        tx(cID.connect(signer).proposeIdentity(u,r,role,365), "ææ¡ˆå·²æäº¤");
    }
    
    function approveHKC() { tx(cHKC.connect(signer).approve(ADDR_MARKET, ethers.constants.MaxUint256), "æˆæƒæˆåŠŸ"); }
    function buy(id) { tx(cMKT.connect(signer).buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
    function sell(id,n,p) { tx(cMKT.connect(signer).sellAsset(id), "å–å‡ºæˆåŠŸ"); }
    function addAsset() { tx(cMKT.connect(signer).addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, "", "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }
    function toggle(id,s) { tx(cMKT.connect(signer).setAssetStatus(id,s), "çŠ¶æ€æ›´æ–°"); }
    function govAdd() { tx(cID.connect(signer).addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value), "æˆæƒæˆåŠŸ"); }
    function govAddAdmin() { tx(cID.connect(signer).addAdmin(document.getElementById("adminAddr").value, document.getElementById("bindOrgAddr").value), "ç»‘å®šæˆåŠŸ"); }
    async function approveID(id) { tx(cID.connect(signer).approveIdentity(id), "å®¡æ‰¹é€šè¿‡"); }

    async function loadAssets() {
        const g=document.getElementById("market-grid"), t=document.getElementById("admin-table");
        if(!cMKT) return; g.innerHTML=""; t.innerHTML="";
        try {
            const c = await cMKT.assetCount();
            for(let i=1; i<=c; i++) {
                const a = await cMKT.assets(i);
                if(a.isActive) {
                    const hue = (i*137)%360;
                    g.innerHTML+=`
                    <div class="col-md-4 mb-4">
                        <div class="asset-card">
                            <div class="asset-img" style="background:linear-gradient(135deg, hsl(${hue},70%,90%), hsl(${hue},70%,80%)); color:hsl(${hue},60%,40%)">
                                ${a.name.substring(0,2).toUpperCase()}
                            </div>
                            <div class="p-3">
                                <h5 class="fw-bold text-dark">${a.name}</h5>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="fw-bold text-primary fs-5">${a.price} HKC</span>
                                    <button class="btn btn-primary btn-sm px-3" onclick="buy(${i})">è´­ä¹°</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                t.innerHTML+=`<tr><td>${i}</td><td>${a.name}</td><td>${a.isActive?'âœ…':'âŒ'}</td><td><button onclick="toggle(${i},${!a.isActive})" class="btn btn-sm btn-light border">åˆ‡æ¢</button></td></tr>`;
            }
        } catch(e){}
    }

    async function loadUserData() {
        if(!signer) return;
        const bal = await cHKC.balanceOf(myAddr);
        document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];
        
        const id = await cID.identities(myAddr);
        if(id.isValid) {
            document.getElementById("my-role-display").innerText = id.role;
            document.getElementById("my-org-display").innerText = "Region: "+id.region;
        } else {
            document.getElementById("my-role-display").innerText = "æ— æœ‰æ•ˆèº«ä»½";
        }

        const g = document.getElementById("inventory-grid"); g.innerHTML="";
        const c = await cMKT.assetCount();
        let has=false;
        for(let i=1; i<=c; i++) {
            const b = await cMKT.userBalances(myAddr, i);
            if(b.gt(0)) {
                has=true; const a = await cMKT.assets(i);
                g.innerHTML+=`<div class="col-md-3"><div class="card border-success text-center p-3"><h6>${a.name}</h6><span class="badge bg-success mb-2">æŒæœ‰: ${b}</span><button onclick="sell(${i},'${a.name}',${a.price})" class="btn btn-outline-danger btn-sm w-100">å–å‡º</button></div></div>`;
            }
        }
        if(!has) g.innerHTML="<div class='col-12 text-center text-muted py-5'>æš‚æ— æŒä»“</div>";
    }

    async function loadProposals() {
        const t = document.getElementById("proposal-table"); t.innerHTML="";
        try {
            const c = await cID.proposalCount();
            for(let i=c; i>Math.max(0,c-5); i--) {
                const p = await cID.getProposal(i);
                if(!p.executed) t.innerHTML+=`<tr><td>#${p.id}</td><td>${p.targetUser.slice(0,6)}...</td><td>${p.role}</td><td><button onclick="approveID(${p.id})" class="btn btn-success btn-sm">æ‰¹å‡†</button></td></tr>`;
            }
        } catch(e){}
    }
    
    async function loadIssuerList() {
        const t = document.getElementById("issuer-list-tbody"); t.innerHTML="";
        try {
            const l = await cID.getAllIssuers();
            for(let a of l) { const i = await cID.issuers(a); if(i.name) t.innerHTML+=`<tr><td>${i.name}</td><td>${a.slice(0,6)}...</td><td>${i.isActive?'âœ…':'âŒ'}</td></tr>`; }
        } catch(e){}
    }

    function nav(p) {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
        document.getElementById('page-title').innerText = {market:'äº¤æ˜“å¸‚åœº',profile:'æˆ‘çš„èµ„äº§',issuer:'å‘è¯ç®¡ç†',admin:'èµ„äº§ç®¡ç†',gov:'æœºæ„ç›‘ç®¡'}[p];
        if(signer) refresh();
    }
</script>
</body>
</html>
