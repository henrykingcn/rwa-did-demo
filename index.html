<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKUST RWA/DID æ§åˆ¶å° (V10 Light + V9 Logic)</title>
    <!-- å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- å¼•å…¥ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* âšª V10 ç™½è‰²ä¸»é¢˜é…è‰² */
            --bg-color: #f3f4f6;          
            --sidebar-bg: #ffffff;        
            --card-bg: #ffffff;           
            --text-primary: #111827;      
            --text-secondary: #6b7280;    
            --border-color: #e5e7eb;      
            
            --accent-color: #2563eb;      /* ç§‘æŠ€è“ */
            --accent-hover: #1d4ed8;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            
            --sidebar-width: 260px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* ä¾§è¾¹æ  (ç™½è‰²ç£¨ç ‚) */
        .sidebar {
            height: 100vh;
            width: var(--sidebar-width);
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--border-color);
            padding-top: 20px;
            z-index: 1000;
            transition: 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-brand {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .sidebar-brand h4 {
            font-weight: 800;
            color: var(--accent-color);
            margin: 0;
            letter-spacing: -0.5px;
        }

        .nav-link {
            padding: 12px 25px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-link:hover {
            color: var(--accent-color);
            background: #eff6ff;
        }

        .nav-link.active {
            color: var(--accent-color);
            background: #eff6ff;
            border-left-color: var(--accent-color);
            font-weight: 600;
        }

        .nav-link i {
            width: 24px;
            margin-right: 10px;
            text-align: center;
        }

        /* æƒé™æ§åˆ¶ç±» */
        .admin-only, .root-only { display: none !important; }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card-custom {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            transition: 0.3s;
        }
        
        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title { font-size: 1.1rem; font-weight: 700; margin: 0; color: var(--text-primary); }

        /* NFT èµ„äº§å¡ç‰‡ */
        .asset-card {
            background: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--accent-color);
        }

        .asset-img {
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            position: relative;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .region-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .price-tag {
            color: var(--accent-color);
            font-weight: 800;
            font-size: 1.2rem;
        }

        /* æŒ‰é’® */
        .btn-primary-custom {
            background-color: var(--accent-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 8px;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }
        .btn-primary-custom:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }

        /* è¡¨å•æ§ä»¶ */
        .form-control, .form-select {
            background-color: #f9fafb;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 15px;
        }
        .form-control:focus, .form-select:focus {
            background-color: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
        .view-section { display: none; animation: fadeIn 0.3s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼ */
        .table-light-custom { color: var(--text-primary); margin-bottom: 0; }
        .table-light-custom th {
            background-color: #f9fafb;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        .table-light-custom td {
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            padding: 12px 10px;
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-brand">
            <h4>ğŸ¦ RWA LAB <span style="font-size:0.6em; color:#999; display:block; margin-top:5px; font-weight:500">V10 Ultimate</span></h4>
        </div>
        
        <div class="nav flex-column">
            <small class="px-4 text-uppercase text-muted fw-bold mb-2" style="font-size:0.7rem">User Zone</small>
            <a onclick="nav('market')" class="nav-link active" id="nav-market"><i class="fas fa-store"></i> äº¤æ˜“å¸‚åœº</a>
            <a onclick="nav('profile')" class="nav-link" id="nav-profile"><i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§</a>
            
            <!-- ç®¡ç†å‘˜å¯è§åŒºåŸŸ -->
            <div class="admin-only">
                <div style="margin: 20px 25px; border-top: 1px solid var(--border-color);"></div>
                <small class="px-4 text-uppercase text-muted fw-bold mb-2" style="font-size:0.7rem">Management</small>
                <a onclick="nav('issuer')" class="nav-link" id="nav-issuer"><i class="fas fa-file-signature"></i> å‘è¯ (Multi-Sig)</a>
                <a onclick="nav('logs')" class="nav-link" id="nav-logs"><i class="fas fa-clipboard-list"></i> å®¡è®¡æ—¥å¿—</a>
            </div>

            <!-- Root å¯è§åŒºåŸŸ -->
            <div class="root-only">
                <a onclick="nav('admin')" class="nav-link" id="nav-admin"><i class="fas fa-boxes"></i> èµ„äº§ä¸Šæ¶</a>
                <a onclick="nav('gov')" class="nav-link" id="nav-gov"><i class="fas fa-building"></i> æœºæ„ç›‘ç®¡</a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="top-bar">
            <h4 class="m-0 fw-bold text-dark">èµ„äº§äº¤æ˜“å¸‚åœº</h4>
            <div class="d-flex align-items-center gap-3">
                <div id="user-status" class="badge bg-secondary-subtle text-secondary border px-3 py-2">
                    <i class="fas fa-circle-notch fa-spin"></i> æ£€æŸ¥èº«ä»½...
                </div>
                <div class="badge bg-primary-subtle text-primary border border-primary-subtle px-3 py-2"><i class="fas fa-coins me-2"></i><span id="hkc-bal">-</span> HKC</div>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary-custom shadow-sm">è¿æ¥é’±åŒ…</button>
                <span id="wallet-addr" class="text-muted small fw-bold font-monospace d-none bg-white px-2 py-1 rounded border"></span>
            </div>
        </div>

        <!-- 1. å¸‚åœº (Public) -->
        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <p class="text-muted m-0">æµè§ˆå…¨çƒåˆè§„ RWA èµ„äº§ã€‚</p>
                <button class="btn btn-dark btn-sm" onclick="approveHKC()">
                    <i class="fas fa-key me-2"></i> èµ„é‡‘æˆæƒ
                </button>
            </div>
            <div class="row" id="market-grid"><div class="text-center py-5 text-muted">Loading...</div></div>
        </div>

        <!-- 2. ä¸ªäººä¸­å¿ƒ (Public) -->
        <div id="view-profile" class="view-section">
            <div class="card-custom bg-primary text-white" style="background: linear-gradient(135deg, #2563eb, #1d4ed8);">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="opacity-75">æˆ‘çš„æ•°å­—èº«ä»½</h6>
                        <h2 class="fw-bold my-2" id="my-role-display">æœªè¿æ¥</h2>
                        <span class="badge bg-white text-primary" id="my-org-display">-</span>
                    </div>
                    <i class="fas fa-id-card fa-4x opacity-25"></i>
                </div>
            </div>
            <h5 class="mb-3 mt-4 fw-bold text-secondary">ğŸ“¦ æˆ‘çš„æŒä»“</h5>
            <div class="row" id="inventory-grid"></div>
        </div>

        <!-- 3. å‘è¯ (Admin Only) -->
        <div id="view-issuer" class="view-section">
            <div class="row">
                <div class="col-md-5">
                    <div class="card-custom border-top border-warning border-4">
                        <h5 class="text-warning">å‘èµ·ææ¡ˆ (Maker)</h5>
                        <input id="targetUser" class="form-control mb-2" placeholder="ç”¨æˆ·åœ°å€">
                        <select id="targetRegion" class="form-select mb-2"><option value="HK">HK é¦™æ¸¯</option><option value="US">US ç¾å›½</option></select>
                        <select id="targetRole" class="form-select mb-3"><option value="Student">Student</option><option value="Investor">Investor</option></select>
                        <button onclick="proposeID()" class="btn btn-warning text-white w-100 fw-bold">å‘èµ·</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-custom">
                        <h5>å¾…å®¡æ‰¹åˆ—è¡¨ (Checker)</h5>
                        <table class="table table-light-custom"><tbody id="proposal-table"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. èµ„äº§ç®¡ç† (Root Only) -->
        <div id="view-admin" class="view-section">
            <div class="card-custom">
                <h5>ä¸Šæ¶æ–°èµ„äº§</h5>
                <div class="input-group mb-3">
                    <input id="newAssetName" class="form-control" placeholder="åç§°">
                    <input id="newAssetPrice" class="form-control" placeholder="ä»·æ ¼">
                    <select id="newAssetRegion" class="form-select" style="max-width:120px"><option value="">å…¨çƒ</option><option value="HK">HK</option></select>
                    <button onclick="addAsset()" class="btn btn-success">ä¸Šæ¶</button>
                </div>
                <table class="table table-light-custom"><tbody id="admin-table"></tbody></table>
            </div>
        </div>

        <!-- 5. ç›‘ç®¡ (Root Only) -->
        <div id="view-gov" class="view-section">
            <div class="card-custom border-danger border-top border-4">
                <h5 class="text-danger">æœºæ„ç›‘ç®¡</h5>
                <p class="small text-muted">æ³¨æ„ï¼šæ·»åŠ ç®¡ç†å‘˜(Admin)è¯·å‰å¾€ Remix è°ƒç”¨ addAdmin(user, org)ã€‚</p>
                <div class="input-group mb-3">
                    <input id="issuerAddr" class="form-control" placeholder="æœºæ„åœ°å€">
                    <input id="issuerName" class="form-control" placeholder="æœºæ„åç§°">
                    <button onclick="govAdd()" class="btn btn-danger">æˆæƒæœºæ„</button>
                </div>
                <table class="table table-light-custom"><tbody id="issuer-list-tbody"></tbody></table>
            </div>
        </div>
        
        <!-- 6. æ—¥å¿— (Admin) -->
        <div id="view-logs" class="view-section">
            <div class="card-custom"><h5>ç³»ç»Ÿæ—¥å¿—</h5><table class="table table-light-custom table-striped"><tbody id="logs-table"></tbody></table></div>
        </div>

    </div>

    <script>
        // âš ï¸ å¡«å…¥ V9 åˆçº¦åœ°å€
        const ADDR_HKC      = "0x93E9aDd27FA2D73645954e3dE6fe0D82D640658c";
        const ADDR_ID       = "0xDE8A30dBDF83CE5C96017C433A984609B9dC10B8";
        const ADDR_MARKET   = "0x6c5529aA37A5B678B0fb573d0aC8Aa527F26A1F7";
        const RPC_URL     = "https://ethereum-sepolia.publicnode.com";

        const ABI_ID = ["function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function addIssuer(address,string) external", "function revokeIssuer(address) external", "function getAdminOrg(address) view returns (address)", "function owner() view returns (address)"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "event TradeExecuted(address,string,uint256,string,uint256,uint256)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC, provider;

        window.onload = async () => {
            provider = new ethers.providers.JsonRpcProvider(RPC_URL);
            initContracts(provider);
            loadAssets(); // å…é’±åŒ…çœ‹å¸‚åœº
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("Err", "MetaMask?", "error");
            const p = new ethers.providers.Web3Provider(window.ethereum);
            await p.send("eth_requestAccounts", []);
            signer = p.getSigner();
            myAddr = await signer.getAddress();
            
            document.getElementById("btn-conn").style.display="none";
            document.getElementById("wallet-addr").classList.remove("d-none");
            document.getElementById("wallet-addr").innerText = myAddr.slice(0,6)+"...";
            
            initContracts(signer);
            await checkRoleAndUI(); // ğŸ”¥ å…³é”®ï¼šæ£€æŸ¥æƒé™ï¼Œå†³å®šæ˜¾ç¤ºä»€ä¹ˆèœå•
            refreshAll();
        }

        // ğŸ”¥ æƒé™åˆ¤æ–­é€»è¾‘ (ä¿®å¤ç‰ˆ) ğŸ”¥
        async function checkRoleAndUI() {
            const badge = document.getElementById("user-status");
            const roleDisp = document.getElementById("my-role-display");
            const orgDisp = document.getElementById("my-org-display");
            
            try {
                // 1. æŸ¥æ˜¯ä¸æ˜¯ Root
                const owner = await cID.owner();
                if(owner.toLowerCase() === myAddr.toLowerCase()) {
                    badge.innerHTML = `<i class="fas fa-crown text-warning"></i> Root Admin`;
                    roleDisp.innerText = "Root Admin";
                    orgDisp.innerText = "System Owner";
                    document.querySelectorAll(".admin-only, .root-only").forEach(e => e.style.setProperty("display", "block", "important"));
                    return;
                }

                // 2. æŸ¥æ˜¯ä¸æ˜¯æœºæ„ Admin
                // æ³¨æ„ï¼šå¿…é¡»åœ¨ SystemV9.sol é‡Œå®ç° getAdminOrg
                const orgAddr = await cID.getAdminOrg(myAddr);
                if(orgAddr !== "0x0000000000000000000000000000000000000000") {
                    const orgInfo = await cID.issuers(orgAddr);
                    badge.innerHTML = `<i class="fas fa-user-shield text-primary"></i> Admin`;
                    roleDisp.innerText = "æœºæ„ç®¡ç†å‘˜";
                    orgDisp.innerText = "æ‰€å±: " + orgInfo.name;
                    document.querySelectorAll(".admin-only").forEach(e => e.style.setProperty("display", "block", "important"));
                    document.querySelectorAll(".root-only").forEach(e => e.style.display="none");
                    return;
                }

                // 3. æ™®é€šç”¨æˆ·
                const id = await cID.identities(myAddr);
                if(id.isValid) {
                    badge.innerHTML = `<i class="fas fa-user text-success"></i> åˆè§„ç”¨æˆ·`;
                    roleDisp.innerText = id.role;
                    orgDisp.innerText = "Region: " + id.region;
                } else {
                    badge.innerHTML = `æ¸¸å®¢ / æ— èº«ä»½`;
                    roleDisp.innerText = "æœªè®¤è¯";
                    orgDisp.innerText = "-";
                }
                document.querySelectorAll(".admin-only, .root-only").forEach(e => e.style.display="none");

            } catch(e) {
                console.error("æƒé™æ£€æŸ¥å¤±è´¥:", e);
                badge.innerText = "æƒé™æœªçŸ¥";
            }
        }

        async function ensureSigner() {
            if(signer) return true;
            await connectWallet();
            return !!signer;
        }

        async function tx(p, msg) {
            if(!await ensureSigner()) return;
            try {
                Swal.fire({title:'ç¡®è®¤...', didOpen:()=>Swal.showLoading()});
                const t = await p;
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
                await t.wait();
                Swal.fire("æˆåŠŸ", msg, "success");
                refreshAll();
            } catch(e) { Swal.fire("Error", e.reason||e.message, "error"); }
        }

        function refreshAll() { loadAssets(); if(signer) { loadUserData(); loadProposals(); loadIssuerList(); loadLogs(); } }

        // --- Loaders ---
        async function loadAssets() {
            const g=document.getElementById("market-grid"), t=document.getElementById("admin-table");
            if(!cMKT) return; g.innerHTML=""; t.innerHTML="";
            const c = await cMKT.assetCount();
            if(c.toNumber()===0) g.innerHTML="<div class='text-center text-muted py-5'>æš‚æ— èµ„äº§</div>";
            for(let i=1; i<=c; i++) {
                const a = await cMKT.assets(i);
                if(a.isActive) {
                    const hue = (i*137)%360;
                    g.innerHTML+=`<div class="col-md-3 mb-3"><div class="asset-card"><div class="asset-img" style="background:linear-gradient(135deg, hsl(${hue},70%,70%), hsl(${hue},70%,50%))">${a.name.substring(0,2).toUpperCase()}<span class="region-badge">${a.requiredRegion||'GLOBAL'}</span></div><div class="asset-body"><h5>${a.name}</h5><div class="d-flex justify-content-between mt-2"><b class="price-tag">${a.price} HKC</b><button onclick="buy(${i})" class="btn btn-sm btn-primary-custom">Buy</button></div></div></div></div>`;
                }
                t.innerHTML+=`<tr><td>${i}</td><td>${a.name}</td><td>${a.isActive?'âœ…':'âŒ'}</td><td><button onclick="toggle(${i},${!a.isActive})" class="btn btn-sm btn-light border">åˆ‡æ¢</button></td></tr>`;
            }
        }

        async function loadUserData() {
            if(!signer) return;
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];
            
            const g = document.getElementById("inventory-grid"); g.innerHTML="";
            const c = await cMKT.assetCount();
            let has=false;
            for(let i=1; i<=c; i++) {
                const b = await cMKT.userBalances(myAddr, i);
                if(b.gt(0)) {
                    has=true; const a = await cMKT.assets(i);
                    g.innerHTML+=`<div class="col-md-3"><div class="asset-card border-success"><div class="p-3 text-center"><h6>${a.name}</h6><span class="badge bg-success mb-2">x${b}</span><button onclick="sell(${i},'${a.name}',${a.price})" class="btn btn-danger-custom btn-sm w-100">å–å‡ºå˜ç°</button></div></div></div>`;
                }
            }
            if(!has) g.innerHTML="<div class='text-center text-muted w-100 py-5'>æš‚æ— èµ„äº§</div>";
        }

        async function loadProposals() {
            const t = document.getElementById("proposal-table"); t.innerHTML="";
            try {
                const c = await cID.proposalCount();
                let has=false;
                for(let i=c; i>Math.max(0,c-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) {
                        has=true;
                        t.innerHTML+=`<tr><td>#${p.id}</td><td>${p.targetUser.slice(0,6)}...</td><td>${p.role}</td><td>${p.proposer.slice(0,6)}...</td><td><button onclick="approveID(${p.id})" class="btn btn-success btn-sm">æ‰¹å‡†</button></td></tr>`;
                    }
                }
                if(!has) t.innerHTML="<tr><td colspan='5' class='text-center text-muted py-3'>æ— å¾…åŠ</td></tr>";
            } catch(e){}
        }
        
        async function loadIssuerList() {
            const t = document.getElementById("issuer-list-tbody"); t.innerHTML="";
            try {
                const l = await cID.getAllIssuers();
                for(let a of l) { const i = await cID.issuers(a); if(i.name) t.innerHTML+=`<tr><td>${i.name}</td><td>${a.slice(0,6)}...</td><td>${i.isActive?'Active':'Revoked'}</td></tr>`; }
            } catch(e){}
        }

        async function loadLogs() {
            const t=document.getElementById("logs-table"); t.innerHTML="";
            const l=await cMKT.queryFilter("TradeExecuted", -5000);
            for(let i=l.length-1; i>=0; i--) {
                const e=l[i]; t.innerHTML+=`<tr><td>${e.args.type_}</td><td>${e.args.assetName}</td><td><a href="https://sepolia.etherscan.io/tx/${e.transactionHash}" target="_blank">View</a></td></tr>`;
            }
        }

        // Actions
        function approveHKC() { tx(cHKC.connect(signer).approve(ADDR_MARKET, ethers.constants.MaxUint256), "æˆæƒæˆåŠŸ"); }
        function buy(id) { tx(cMKT.connect(signer).buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
        function sell(id,n,p) { tx(cMKT.connect(signer).sellAsset(id), "å–å‡ºæˆåŠŸ"); }
        function addAsset() { tx(cMKT.connect(signer).addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, "", "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }
        function toggle(id,s) { tx(cMKT.connect(signer).setAssetStatus(id,s), "çŠ¶æ€æ›´æ–°"); }
        function govAdd() { tx(cID.connect(signer).addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value), "æˆæƒæˆåŠŸ"); }
        
        function proposeID() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.connect(signer).proposeIdentity(u,r,role,365), "ææ¡ˆæäº¤");
        }
        async function approveID(id) {
            const p=await cID.getProposal(id);
            if(p.proposer.toLowerCase()===myAddr.toLowerCase()) return Swal.fire("æƒé™é™åˆ¶","ä¸èƒ½å®¡æ‰¹è‡ªå·±å‘èµ·çš„ææ¡ˆ","error");
            tx(cID.connect(signer).approveIdentity(id), "å®¡æ‰¹é€šè¿‡");
        }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
            if(signer) refreshAll();
        }
    </script>
</body>
</html>
