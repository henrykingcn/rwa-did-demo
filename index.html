<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKUST RWA/DID æ§åˆ¶å° (V10 Light)</title>
    <!-- å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- å¼•å…¥ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* âšª ç™½è‰²ä¸»é¢˜é…è‰²å˜é‡ */
            --bg-color: #f3f4f6;          /* æµ…ç°èƒŒæ™¯ */
            --sidebar-bg: #ffffff;        /* çº¯ç™½ä¾§è¾¹æ  */
            --card-bg: #ffffff;           /* çº¯ç™½å¡ç‰‡ */
            --text-primary: #111827;      /* æ·±é»‘å­— */
            --text-secondary: #6b7280;    /* ç°å­— */
            --border-color: #e5e7eb;      /* æµ…ç°è¾¹æ¡† */
            
            --accent-color: #2563eb;      /* ç§‘æŠ€è“ */
            --accent-hover: #1d4ed8;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            
            --sidebar-width: 260px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* ä¾§è¾¹æ  (ç™½è‰²ç£¨ç ‚) */
        .sidebar {
            height: 100vh;
            width: var(--sidebar-width);
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--border-color);
            padding-top: 20px;
            z-index: 1000;
            transition: 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-brand {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .sidebar-brand h4 {
            font-weight: 800;
            color: var(--accent-color);
            margin: 0;
            letter-spacing: -0.5px;
        }

        .nav-link {
            padding: 12px 25px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-link:hover {
            color: var(--accent-color);
            background: #eff6ff; /* ææ·¡è“ */
        }

        .nav-link.active {
            color: var(--accent-color);
            background: #eff6ff;
            border-left-color: var(--accent-color);
            font-weight: 600;
        }

        .nav-link i {
            width: 24px;
            margin-right: 10px;
            text-align: center;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card-custom {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            transition: 0.3s;
        }
        
        .card-custom:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title { font-size: 1.1rem; font-weight: 700; margin: 0; color: var(--text-primary); }

        /* NFT èµ„äº§å¡ç‰‡ */
        .asset-card {
            background: #ffffff;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-color);
        }

        .asset-img {
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            position: relative;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .region-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .asset-body { padding: 20px; }
        
        .price-tag {
            color: var(--accent-color);
            font-weight: 800;
            font-size: 1.2rem;
        }

        /* æŒ‰é’® */
        .btn-primary-custom {
            background-color: var(--accent-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 8px;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }
        .btn-primary-custom:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }

        .btn-danger-custom {
            background-color: var(--danger-color);
            border: none;
            color: white;
            border-radius: 8px;
            font-weight: 600;
        }
        .btn-danger-custom:hover { background-color: #dc2626; }

        /* è¡¨å•æ§ä»¶ */
        .form-control, .form-select {
            background-color: #f9fafb;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 15px;
        }
        .form-control:focus, .form-select:focus {
            background-color: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* çŠ¶æ€ç‚¹ */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .bg-success-glow { background-color: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
        .bg-danger-glow { background-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }

        /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
        .view-section { display: none; animation: fadeIn 0.3s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼ */
        .table-light-custom { color: var(--text-primary); margin-bottom: 0; }
        .table-light-custom th {
            background-color: #f9fafb;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        .table-light-custom td {
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            padding: 12px 10px;
        }
        .table-light-custom tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>

    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar">
        <div class="sidebar-brand">
            <h4>ğŸ¦ RWA LAB <span style="font-size:0.6em; color:#999; display:block; margin-top:5px; font-weight:500">V10 Light</span></h4>
        </div>
        
        <div class="nav flex-column">
            <a onclick="nav('market')" class="nav-link active" id="nav-market">
                <i class="fas fa-store"></i> äº¤æ˜“å¸‚åœº (Market)
            </a>
            <a onclick="nav('profile')" class="nav-link" id="nav-profile">
                <i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§ (Sell)
            </a>
            <a onclick="nav('issuer')" class="nav-link" id="nav-issuer">
                <i class="fas fa-file-signature"></i> å¤šç­¾å‘è¯ (Multi-Sig)
            </a>
            
            <div style="margin: 20px 25px; border-top: 1px solid var(--border-color);"></div>
            <small style="padding: 0 25px; color: #9ca3af; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; display: block;">Admin Zone</small>
            
            <a onclick="nav('admin')" class="nav-link" id="nav-admin">
                <i class="fas fa-boxes"></i> èµ„äº§ç®¡ç†
            </a>
            <a onclick="nav('gov')" class="nav-link" id="nav-gov">
                <i class="fas fa-building"></i> ç›‘ç®¡æœºæ„
            </a>
            <a onclick="nav('logs')" class="nav-link" id="nav-logs">
                <i class="fas fa-clipboard-list"></i> å®¡è®¡æ—¥å¿—
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="top-bar">
            <div>
                <h4 id="page-title" class="m-0" style="font-weight: 700; color: var(--text-primary);">èµ„äº§äº¤æ˜“å¸‚åœº</h4>
                <small class="text-muted" id="network-status"><i class="fas fa-circle text-success small me-1"></i> RPC åœ¨çº¿</small>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <!-- èº«ä»½å¾½ç«  -->
                <div id="id-badge" class="d-none px-3 py-2 rounded-3" style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d;">
                    <span id="id-text" class="small fw-bold">æ£€æŸ¥ä¸­...</span>
                </div>

                <!-- ä½™é¢ -->
                <div class="px-3 py-2 rounded-3" style="background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8;">
                    <i class="fas fa-coins me-2"></i><span id="hkc-bal" class="fw-bold">-</span> HKC
                </div>

                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary-custom shadow-sm">
                    <i class="fas fa-wallet me-2"></i> è¿æ¥é’±åŒ…
                </button>
                <span id="wallet-addr" class="text-muted small fw-bold font-monospace d-none bg-white px-2 py-1 rounded border"></span>
            </div>
        </div>

        <!-- ==================== 1. å¸‚åœº (Market) ==================== -->
        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <p class="text-muted m-0">æµè§ˆå…¨çƒåˆè§„ RWA èµ„äº§ã€‚è´­ä¹°å‰è¯·ç¡®ä¿å·²é€šè¿‡ KYCã€‚</p>
                <button class="btn btn-dark btn-sm" onclick="approveHKC()">
                    <i class="fas fa-key me-2"></i> èµ„é‡‘æˆæƒ (Approve)
                </button>
            </div>

            <div class="row" id="market-grid">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-3">æ­£åœ¨åŠ è½½èµ„äº§...</p>
                </div>
            </div>
        </div>

        <!-- ==================== 2. ä¸ªäººä¸­å¿ƒ (Profile & Sell) ==================== -->
        <div id="view-profile" class="view-section">
            <!-- èº«ä»½å¡ç‰‡ -->
            <div class="card-custom" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border:none; color: white;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="opacity-75 mb-2">å½“å‰æ•°å­—èº«ä»½ (DID)</h6>
                        <h2 class="fw-bold mb-1" id="profile-role">è¯·è¿æ¥é’±åŒ…</h2>
                        <div class="d-flex gap-2 mt-3">
                            <span class="badge bg-white text-primary" id="profile-region">Region: -</span>
                            <span class="badge bg-white bg-opacity-25" id="profile-issuer">Issuer: -</span>
                        </div>
                    </div>
                    <div class="d-none d-md-block">
                        <i class="fas fa-id-card fa-6x opacity-25"></i>
                    </div>
                </div>
            </div>

            <h5 class="mb-3 mt-4 fw-bold text-secondary"><i class="fas fa-box-open me-2"></i> æˆ‘çš„èµ„äº§åº“ (Inventory)</h5>
            <div class="row" id="inventory-grid">
                <div class="text-center text-muted py-5">æš‚æ— æŒä»“ï¼Œè¯·å‰å¾€å¸‚åœºè´­ä¹°</div>
            </div>
        </div>

        <!-- ==================== 3. å‘è¯ç®¡ç† (è‡ªåŠ¨è¯†åˆ« Root/Multi-Sig) ==================== -->
        <div id="view-issuer" class="view-section">
            <div class="row">
                <!-- å·¦ä¾§ï¼šæ“ä½œé¢æ¿ -->
                <div class="col-md-5">
                    <div class="card-custom border-top border-warning border-4">
                        <div class="card-header-custom">
                            <h5 class="card-title text-warning" id="issue-title">å‘è¯æ“ä½œ</h5>
                        </div>
                        <p class="small text-muted" id="issue-desc">æ­£åœ¨æ£€æµ‹æƒé™...</p>
                        
                        <div class="mb-3">
                            <label class="small text-muted mb-1 fw-bold">ç”¨æˆ·åœ°å€</label>
                            <input id="targetUser" class="form-control" placeholder="0x...">
                        </div>
                        <div class="mb-3">
                            <label class="small text-muted mb-1 fw-bold">åœ°åŒº</label>
                            <select id="targetRegion" class="form-select"><option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯ (HK)</option><option value="US">ğŸ‡ºğŸ‡¸ ç¾å›½ (US)</option><option value="CN">ğŸ‡¨ğŸ‡³ å†…åœ° (CN)</option></select>
                        </div>
                        <div class="mb-4">
                            <label class="small text-muted mb-1 fw-bold">è§’è‰²</label>
                            <select id="targetRole" class="form-select"><option value="Student">Student</option><option value="Investor">Investor</option></select>
                        </div>
                        
                        <div id="issue-btn-area">
                            <button class="btn btn-secondary w-100" disabled>è¯·è¿æ¥é’±åŒ…</button>
                        </div>
                    </div>
                </div>
                <!-- å³ä¾§ï¼šå®¡æ‰¹åˆ—è¡¨ -->
                <div class="col-md-7">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <h5 class="card-title">ğŸ“‹ å¾…å®¡æ‰¹ææ¡ˆ (Checker)</h5>
                            <button onclick="loadProposals()" class="btn btn-sm btn-light border"><i class="fas fa-sync"></i></button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-light-custom">
                                <thead><tr><th>ID</th><th>ç”¨æˆ·</th><th>è§’è‰²</th><th>å‘èµ·äºº</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="proposal-table"><tr><td colspan="5" class="text-center text-muted py-3">æ— å¾…åŠ</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== 4. èµ„äº§ç®¡ç† (Admin) ==================== -->
        <div id="view-admin" class="view-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="card-custom border-top border-success border-4">
                        <div class="card-header-custom"><h5 class="card-title text-success">ä¸Šæ¶æ–°èµ„äº§</h5></div>
                        <input id="newAssetName" class="form-control mb-2" placeholder="èµ„äº§åç§°">
                        <input id="newAssetPrice" type="number" class="form-control mb-2" placeholder="ä»·æ ¼ (HKC)">
                        <select id="newAssetRegion" class="form-select mb-3"><option value="">ğŸŒ å…¨çƒ</option><option value="HK">ğŸ‡­ğŸ‡° HK Only</option><option value="US">ğŸ‡ºğŸ‡¸ US Only</option></select>
                        <button onclick="addAsset()" class="btn btn-success w-100 fw-bold">ä¸Šæ¶</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-custom">
                        <div class="card-header-custom"><h5 class="card-title">ç°å­˜èµ„äº§åˆ—è¡¨</h5></div>
                        <table class="table table-light-custom">
                            <thead><tr><th>ID</th><th>åç§°</th><th>ä»·æ ¼</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="admin-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== 5. ç›‘ç®¡ (Gov) ==================== -->
        <div id="view-gov" class="view-section">
            <div class="row">
                <div class="col-md-5">
                    <div class="card-custom border-top border-danger border-4">
                        <h5 class="card-title text-danger mb-3">æœºæ„æˆæƒ</h5>
                        <input id="issuerAddr" class="form-control mb-2" placeholder="æœºæ„åœ°å€ (0x...)">
                        <input id="issuerName" class="form-control mb-3" placeholder="æœºæ„åç§°">
                        <div class="d-flex gap-2">
                            <button onclick="govAdd()" class="btn btn-danger flex-fill">æˆæƒ</button>
                            <button onclick="govRevoke()" class="btn btn-outline-danger flex-fill">åŠé”€</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-custom">
                        <h5 class="card-title mb-3">å·²æˆæƒæœºæ„</h5>
                        <table class="table table-light-custom table-sm">
                            <tbody id="issuer-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== 6. Logs ==================== -->
        <div id="view-logs" class="view-section">
            <div class="card-custom">
                <div class="card-header-custom"><h5 class="card-title">å…¨ç½‘å®¡è®¡æ—¥å¿—</h5></div>
                <table class="table table-light-custom table-striped">
                    <thead><tr><th>ç±»å‹</th><th>æ‘˜è¦</th><th>Hash</th></tr></thead>
                    <tbody id="logs-table"><tr><td colspan="3" class="text-center text-muted">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- è„šæœ¬åŒº -->
    <script>
        // ==================== âš™ï¸ é…ç½®åŒº (V7 åœ°å€) ====================
        const ADDR_HKC    = "å¡«å…¥HKCåœ°å€";
        const ADDR_ID     = "å¡«å…¥èº«ä»½åˆçº¦åœ°å€";
        const ADDR_MARKET = "å¡«å…¥å¸‚åœºåˆçº¦åœ°å€";
        
        const RPC_NODES = [
            "https://ethereum-sepolia.publicnode.com",
            "https://sepolia.drpc.org",
            "https://rpc.sepolia.org"
        ];
        // ====================================================================

        const ABI_ID = ["function rootIssue(address,string,string,uint256) external", "function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function owner() view returns (address)", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function addIssuer(address,string) external", "function revokeIssuer(address) external", "function checkCompliance(address,string,address) view returns (bool, string)", "event IssuerAdded(address,string)", "event IssuerRevoked(address)", "event IdentityIssued(address,address,string)"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "event TradeExecuted(address,string,uint256,string,uint256,uint256)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC, provider;

        window.onload = async () => {
            for(let url of RPC_NODES) {
                try {
                    provider = new ethers.providers.JsonRpcProvider(url);
                    await provider.getBlockNumber();
                    console.log("RPC Connected:", url);
                    initContracts(provider);
                    loadAssets(); 
                    return;
                } catch(e) {}
            }
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("é”™è¯¯", "è¯·å®‰è£… MetaMask", "error");
            try {
                const p = new ethers.providers.Web3Provider(window.ethereum);
                await p.send("eth_requestAccounts", []);
                signer = p.getSigner();
                myAddr = await signer.getAddress();
                
                document.getElementById("btn-conn").classList.add("d-none");
                document.getElementById("wallet-addr").classList.remove("d-none");
                document.getElementById("wallet-addr").innerText = myAddr.slice(0,6)+"..."+myAddr.slice(-4);
                document.getElementById("id-badge").classList.remove("d-none");
                
                initContracts(signer);
                checkPermission();
                refreshAll();
                return true;
            } catch(e) { console.error(e); return false; }
        }

        function refreshAll() {
            loadAssets(); loadUserData();
            if(document.getElementById("view-issuer").classList.contains("active")) loadProposals();
            if(document.getElementById("view-gov").classList.contains("active")) loadIssuerList();
            if(document.getElementById("view-logs").classList.contains("active")) loadLogs();
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶è¿æ¥ Signer ---
        async function ensureSigner() {
            if(signer) return true;
            return await connectWallet();
        }

        async function executeAction(actionFn) {
            if (!await ensureSigner()) return;
            try {
                Swal.fire({title:'ç­‰å¾…ç¡®è®¤...', didOpen:()=>Swal.showLoading()});
                const tx = await actionFn(); 
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
                await tx.wait();
                Swal.fire({icon:'success', title:'æˆåŠŸ'});
                refreshAll();
            } catch(e) { 
                console.error(e);
                Swal.fire({icon:'error', title:'é”™è¯¯', text:e.reason||e.message}); 
            }
        }

        // --- Actions ---
        async function checkPermission() {
            try {
                const owner = await cID.owner();
                const area = document.getElementById("issue-btn-area");
                const title = document.getElementById("issue-title");
                const desc = document.getElementById("issue-desc");

                if(owner.toLowerCase() === myAddr.toLowerCase()) {
                    title.innerHTML = "<span class='text-danger'>ğŸ‘‘ Root æé€Ÿå‘è¯ (God Mode)</span>";
                    desc.innerText = "ä½ æ˜¯æœ€é«˜ç®¡ç†å‘˜ï¼Œæ— éœ€å®¡æ ¸ï¼Œç›´æ¥å‘è¯ã€‚";
                    area.innerHTML = `<button onclick="rootIssue()" class="btn btn-danger w-100 fw-bold">ğŸš€ ç«‹å³å‘è¯ (Root)</button>`;
                } else {
                    title.innerHTML = "<span class='text-warning'>ğŸ“‹ å‘èµ·ææ¡ˆ (Maker)</span>";
                    desc.innerText = "ä½ éœ€è¦å‘èµ·ææ¡ˆï¼Œå¹¶ç”±å¦ä¸€ä½ç®¡ç†å‘˜å¤æ ¸ (Checker)ã€‚";
                    area.innerHTML = `<button onclick="proposeID()" class="btn btn-warning w-100 fw-bold text-dark">ğŸ“ å‘èµ·ææ¡ˆ</button>`;
                }
            } catch(e) {}
        }

        function rootIssue() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            executeAction(() => cID.connect(signer).rootIssue(u,r,role,365));
        }
        function proposeID() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            executeAction(() => cID.connect(signer).proposeIdentity(u,r,role,365));
        }
        async function approveID(id) {
            const p = await cID.getProposal(id);
            if(p.proposer.toLowerCase() === myAddr.toLowerCase()) return Swal.fire({icon:'error',title:'æƒé™é”™è¯¯',text:'ä¸èƒ½å®¡æ‰¹è‡ªå·±å‘èµ·çš„ææ¡ˆ'});
            executeAction(() => cID.connect(signer).approveIdentity(id));
        }

        function approveHKC() { executeAction(() => cHKC.connect(signer).approve(ADDR_MARKET, ethers.constants.MaxUint256)); }
        function buy(id) { executeAction(() => cMKT.connect(signer).buyAsset(id)); }
        function sell(id, n, p) { executeAction(() => cMKT.connect(signer).sellAsset(id)); }
        function addAsset() { executeAction(() => cMKT.connect(signer).addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, document.getElementById("newAssetRegion").value, "0x0000000000000000000000000000000000000000")); }
        function toggle(id, s) { executeAction(() => cMKT.connect(signer).setAssetStatus(id, s)); }
        function govAdd() { executeAction(() => cID.connect(signer).addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value)); }
        function govRevoke() { executeAction(() => cID.connect(signer).revokeIssuer(document.getElementById("issuerAddr").value)); }

        // --- Readers ---
        async function loadAssets() {
            const g = document.getElementById("market-grid"); const t = document.getElementById("admin-table");
            if(!cMKT) return; g.innerHTML=""; t.innerHTML="";
            try {
                const c = await cMKT.assetCount();
                if(c.toNumber()===0) g.innerHTML = "<div class='text-center text-muted py-5'>æš‚æ— èµ„äº§</div>";
                for(let i=1; i<=c; i++) {
                    const a = await cMKT.assets(i);
                    if(a.isActive) {
                        // éšæœºç”ŸæˆæŸ”å’Œçš„æ¸å˜è‰² (Light Mode)
                        const hue = (i*137)%360;
                        g.innerHTML += `<div class="col-md-4 col-lg-3 mb-4"><div class="asset-card"><div class="asset-img" style="background:linear-gradient(135deg, hsl(${hue},70%,70%), hsl(${hue},70%,50%))">${a.name.substring(0,2).toUpperCase()}<span class="region-badge">${a.requiredRegion || 'GLOBAL'}</span></div><div class="asset-body"><h5 class="fw-bold mb-1">${a.name}</h5><div class="d-flex justify-content-between align-items-center mt-3"><span class="price-tag">${a.price} HKC</span><button class="btn btn-sm btn-primary-custom" onclick="buy(${i})">è´­ä¹°</button></div></div></div></div>`;
                    }
                    t.innerHTML += `<tr><td>${i}</td><td>${a.name}</td><td>${a.price} HKC</td><td>${a.isActive?'<span class="text-success">ä¸Šæ¶</span>':'<span class="text-danger">ä¸‹æ¶</span>'}</td><td><button class="btn btn-sm btn-outline-secondary" onclick="toggle(${i},${!a.isActive})">åˆ‡æ¢</button></td></tr>`;
                }
            } catch(e){}
        }

        async function loadUserData() {
            if(!myAddr) return;
            
            // 1. ä¿®æ­£ï¼šèº«ä»½çŠ¶æ€æ£€æµ‹é€»è¾‘
            document.getElementById("id-text").innerText = "æ£€æŸ¥ä¸­...";
            try {
                const bal = await cHKC.balanceOf(myAddr);
                document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];
                
                const id = await cID.identities(myAddr);
                const statusBadge = document.getElementById("id-badge");
                const statusText = document.getElementById("id-text");

                if(id.isValid && Date.now()/1000 < id.expiry) {
                    document.getElementById("profile-role").innerText = id.role;
                    document.getElementById("profile-region").innerText = "Region: "+id.region;
                    document.getElementById("profile-issuer").innerText = "By: "+id.issuedBy.slice(0,6)+"...";
                    
                    statusBadge.style.background = "#f0fdf4";
                    statusBadge.style.color = "#15803d";
                    statusText.innerHTML = `<span class="status-dot bg-success-glow"></span> ${id.region}/${id.role}`;
                } else {
                    document.getElementById("profile-role").innerText = "æ— æœ‰æ•ˆèº«ä»½";
                    statusBadge.style.background = "#fef2f2";
                    statusBadge.style.color = "#b91c1c";
                    statusText.innerHTML = `<span class="status-dot bg-danger-glow"></span> æ— èº«ä»½`;
                }
            } catch(e) {
                console.error("èº«ä»½è¯»å–å¤±è´¥:", e);
                document.getElementById("id-text").innerText = "çŠ¶æ€æœªçŸ¥";
            }

            // 2. æŒä»“
            const grid = document.getElementById("inventory-grid"); grid.innerHTML = "";
            const c = await cMKT.assetCount();
            let has = false;
            for(let i=1; i<=c; i++) {
                const b = await cMKT.userBalances(myAddr, i);
                if(b.gt(0)) {
                    has = true;
                    const a = await cMKT.assets(i);
                    const hue = (i*137)%360;
                    grid.innerHTML += `<div class="col-md-3 mb-4"><div class="asset-card" style="border-color:var(--success-color)"><div class="asset-img" style="height:120px; background:hsl(${hue},60%,60%)">${a.name.substring(0,2)}<span class="badge bg-success position-absolute top-0 end-0 m-2">æŒæœ‰: ${b}</span></div><div class="p-3 text-center"><h6 class="mb-2 fw-bold">${a.name}</h6><button class="btn btn-sm btn-danger-custom w-100" onclick="sell(${i}, '${a.name}', ${a.price})">å–å‡º (å˜ç°)</button></div></div></div>`;
                }
            }
            if(!has) grid.innerHTML = "<div class='text-center text-muted w-100 py-5'>æš‚æ— èµ„äº§</div>";
        }

        async function loadProposals() {
            const t = document.getElementById("proposal-table"); t.innerHTML="";
            try {
                const c = await cID.proposalCount();
                for(let i=c; i>Math.max(0,c-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) t.innerHTML += `<tr><td>#${p.id}</td><td class="font-monospace small">${p.targetUser.slice(0,6)}...</td><td><span class="badge bg-info text-dark">${p.role}</span></td><td class="small">${p.proposer.slice(0,6)}...</td><td><button class="btn btn-sm btn-primary-custom" onclick="approveID(${p.id})">æ‰¹å‡†</button></td></tr>`;
                }
            } catch(e){}
        }

        async function loadLogs() {
            const t = document.getElementById("logs-table");
            const logs = await cMKT.queryFilter("TradeExecuted", -10000); 
            let html = "";
            for(let i=logs.length-1; i>=0; i--) {
                const l = logs[i];
                const type = l.args.type_ === 'BUY' ? '<span class="badge bg-success">ä¹°å…¥</span>' : '<span class="badge bg-danger">å–å‡º</span>';
                html += `<tr><td>${type}</td><td>ç”¨æˆ· ${l.args.user.slice(0,6)} æ“ä½œäº† ${l.args.assetName}</td><td><a href="https://sepolia.etherscan.io/tx/${l.transactionHash}" target="_blank" class="text-decoration-none text-primary">View</a></td></tr>`;
            }
            t.innerHTML = html;
        }

        async function loadIssuerList() {
            const t = document.getElementById("issuer-list-tbody"); t.innerHTML="";
            const l = await cID.getAllIssuers();
            for(let a of l) { const i = await cID.issuers(a); if(i.name) t.innerHTML+=`<tr><td>${i.name}</td><td class="font-monospace text-muted">${a.slice(0,8)}...</td><td>${i.isActive?'<span class="text-success">â—</span>':'<span class="text-danger">â—</span>'}</td></tr>`; }
        }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
            if(signer) refreshAll();
        }
    </script>
</body>
</html>
