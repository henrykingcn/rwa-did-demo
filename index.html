<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKUST RWA Exchange | V12.1 Fixed</title>
    
    <!-- æ ¸å¿ƒåº“ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --bg-body: #f8fafc;
            --bg-card: #ffffff; --text-main: #0f172a; --text-sub: #64748b;
            --sidebar-width: 280px; --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-hover: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--bg-card); border-right: 1px solid #e2e8f0; z-index: 1000; padding: 24px 0; }
        .brand { padding: 0 32px 32px; display: flex; gap: 12px; align-items: center; }
        .brand-icon { width: 40px; height: 40px; background: var(--primary); border-radius: 10px; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .nav-label { padding: 0 24px 8px; font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; font-weight: 700; margin-top: 20px; }
        .nav-item { padding: 12px 24px; color: var(--text-sub); display: flex; align-items: center; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover { background: #f1f5f9; color: var(--primary); }
        .nav-item.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
        .nav-item i { width: 24px; margin-right: 12px; text-align: center; }
        
        /* Main */
        .main-content { margin-left: var(--sidebar-width); padding: 32px 48px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .user-controls { display: flex; gap: 16px; align-items: center; background: white; padding: 8px 16px; border-radius: 50px; box-shadow: var(--shadow-sm); border: 1px solid #f1f5f9; }
        .balance-pill { background: #eff6ff; color: var(--primary); padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }
        
        /* Cards */
        .card-glass { background: white; border: 1px solid #f1f5f9; border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow-sm); height: 100%; transition: 0.2s; }
        .card-glass:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        
        /* Assets */
        .asset-card { background: white; border-radius: 20px; overflow: hidden; border: 1px solid #f1f5f9; transition: 0.3s; position: relative; }
        .asset-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-hover); border-color: #bfdbfe; }
        .asset-visual { height: 180px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 900; color: rgba(0,0,0,0.1); }
        .asset-tag { position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .asset-info { padding: 24px; }
        .asset-price { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        
        /* Elements */
        .btn-buy { width: 100%; margin-top: 16px; padding: 12px; border-radius: 12px; border: none; background: #0f172a; color: white; font-weight: 600; transition:0.2s; }
        .btn-buy:hover { background: var(--primary); }
        .form-control, .form-select { border: 1px solid #e2e8f0; padding: 12px; border-radius: 10px; background: #f8fafc; }
        .form-control:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .table-modern th { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; border: none; padding-bottom: 12px; }
        .table-modern td { padding: 16px 0; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .view-section { display: none; animation: fadeUp 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æƒé™æ§åˆ¶ */
        .admin-only, .root-only { display: none !important; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-cube"></i></div>
            <div><h5 style="margin:0;font-weight:800">RWA.Fi</h5><small style="color:#94a3b8">V12.1 Fixed</small></div>
        </div>

        <div class="nav-label">Marketplace</div>
        <div onclick="nav('market')" class="nav-item active" id="nav-market"><i class="fas fa-store-alt"></i> èµ„äº§å¸‚åœº</div>
        <div onclick="nav('profile')" class="nav-item" id="nav-profile"><i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§</div>

        <div class="nav-label admin-only">Administration</div>
        <div onclick="nav('issuer')" class="nav-item admin-only" id="nav-issuer"><i class="fas fa-file-signature"></i> å‘è¯ç®¡ç†</div>
        <div onclick="nav('logs')" class="nav-item admin-only" id="nav-logs"><i class="fas fa-history"></i> å®¡è®¡æ—¥å¿—</div>

        <div class="nav-label root-only">Governance</div>
        <div onclick="nav('admin')" class="nav-item root-only" id="nav-admin"><i class="fas fa-layer-group"></i> èµ„äº§ä¸Šæ¶</div>
        <div onclick="nav('gov')" class="nav-item root-only" id="nav-gov"><i class="fas fa-building-columns"></i> æœºæ„ç›‘ç®¡</div>
    </nav>

    <div class="main-content">
        <header class="header">
            <div><h2 style="font-weight:800; color:#1e293b" id="page-title">èµ„äº§äº¤æ˜“å¸‚åœº</h2><p>å…¨çƒåˆè§„ç°å®èµ„äº§äº¤æ˜“å¹³å°</p></div>
            <div class="user-controls">
                <div class="d-flex align-items-center gap-2 border-end pe-3 me-2">
                    <div id="net-dot" style="width:8px;height:8px;border-radius:50%;background:#10b981"></div>
                    <small class="fw-bold text-muted">RPC Online</small>
                </div>
                <div class="balance-pill"><span id="hkc-bal">0.00</span> HKC</div>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary rounded-pill px-4 fw-bold">è¿æ¥é’±åŒ…</button>
                <div id="user-badge" class="d-none d-flex align-items-center gap-2">
                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:32px;height:32px"><i class="fas fa-user"></i></div>
                    <span class="fw-bold small" id="wallet-display">0x...</span>
                </div>
            </div>
        </header>

        <!-- 1. å¸‚åœº -->
        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-between mb-4">
                <div class="d-flex gap-2">
                    <span class="badge bg-white text-dark border px-3 py-2 rounded-pill">å…¨éƒ¨</span>
                    <span class="badge bg-white text-muted border px-3 py-2 rounded-pill">HK ä¸“åŒº</span>
                </div>
                <button class="btn btn-light text-primary fw-bold border" onclick="approveHKC()"><i class="fas fa-key me-2"></i> èµ„é‡‘æˆæƒ</button>
            </div>
            <div class="row g-4" id="market-grid">
                <div class="col-12 text-center py-5 text-muted"><div class="spinner-border text-primary mb-2"></div><p>Loading Assets...</p></div>
            </div>
        </div>

        <!-- 2. ä¸ªäºº -->
        <div id="view-profile" class="view-section">
            <div class="row mb-5">
                <div class="col-md-8">
                    <div class="card-glass text-white" style="background: linear-gradient(120deg, #2563eb, #1e40af); border:none">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="badge bg-white bg-opacity-25 mb-2">æ•°å­—èº«ä»½ (DID)</span>
                                <h2 class="fw-bold mb-1" id="my-role-display">æœªè¿æ¥</h2>
                                <div class="mt-3 d-flex gap-2">
                                    <span class="badge bg-white text-primary" id="my-region-display">-</span>
                                    <span class="badge bg-white bg-opacity-25" id="my-org-display">-</span>
                                </div>
                            </div>
                            <i class="fas fa-id-card fa-5x opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-glass d-flex flex-column justify-content-center text-center">
                        <h6 class="text-muted text-uppercase fw-bold small">èµ„äº§æ€»æ•°</h6>
                        <h2 class="fw-bold text-dark" id="my-asset-count">0</h2>
                    </div>
                </div>
            </div>
            <h5 class="fw-bold text-dark mb-4">ğŸ“¦ æˆ‘çš„æŒä»“</h5>
            <div class="row g-4" id="inventory-grid"><div class="col-12 text-center py-5 text-muted">æš‚æ— æŒä»“</div></div>
        </div>

        <!-- 3. å‘è¯ (æ™ºèƒ½æŒ‰é’®ï¼šRoot / Maker) -->
        <div id="view-issuer" class="view-section">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card-glass" style="border-top: 4px solid #f59e0b">
                        <h5 class="fw-bold text-warning mb-4" id="issue-card-title">å‘è¯æ“ä½œ</h5>
                        <p class="small text-muted" id="issue-desc">æ­£åœ¨æ£€æµ‹æƒé™...</p>
                        
                        <input id="targetUser" class="form-control mb-3" placeholder="ç”¨æˆ·åœ°å€ (0x...)">
                        <div class="row mb-3">
                            <div class="col"><select id="targetRegion" class="form-select"><option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯</option><option value="US">ğŸ‡ºğŸ‡¸ ç¾å›½</option></select></div>
                            <div class="col"><select id="targetRole" class="form-select"><option value="Student">å­¦ç”Ÿ</option><option value="Investor">æŠ•èµ„äºº</option></select></div>
                        </div>
                        
                        <!-- ğŸ”¥ åŠ¨æ€æŒ‰é’®åŒºåŸŸ ğŸ”¥ -->
                        <div id="issue-btn-area">
                            <button class="btn btn-secondary w-100" disabled>è¯·è¿æ¥é’±åŒ…</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-glass">
                        <div class="d-flex justify-content-between mb-4"><h5 class="fw-bold m-0">å¾…å®¡æ‰¹åˆ—è¡¨</h5><button onclick="loadProposals()" class="btn btn-sm btn-light border"><i class="fas fa-sync"></i></button></div>
                        <table class="table-modern" style="width:100%"><thead><tr><th>ID</th><th>ç”¨æˆ·</th><th>è§’è‰²</th><th>æ“ä½œ</th></tr></thead><tbody id="proposal-table"><tr><td colspan="4" class="text-center text-muted">æ— å¾…åŠ</td></tr></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Admin & Gov -->
        <div id="view-admin" class="view-section">
            <div class="card-glass mb-4">
                <h5 class="fw-bold text-success mb-4">ä¸Šæ¶èµ„äº§</h5>
                <div class="row g-2">
                    <div class="col-5"><input id="newAssetName" class="form-control" placeholder="åç§°"></div>
                    <div class="col-3"><input id="newAssetPrice" class="form-control" placeholder="ä»·æ ¼"></div>
                    <div class="col-2"><select id="newAssetRegion" class="form-select"><option value="">å…¨çƒ</option><option value="HK">HK</option></select></div>
                    <div class="col-2"><button onclick="addAsset()" class="btn btn-success w-100 fw-bold">ä¸Šæ¶</button></div>
                </div>
            </div>
            <div class="card-glass"><h5 class="fw-bold mb-4">èµ„äº§åˆ—è¡¨</h5><table class="table-modern" style="width:100%"><tbody id="admin-table"></tbody></table></div>
        </div>

        <div id="view-gov" class="view-section">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card-glass" style="border-top:4px solid #ef4444">
                        <h5 class="text-danger fw-bold mb-4">æœºæ„æˆæƒ</h5>
                        <input id="issuerAddr" class="form-control mb-3" placeholder="æœºæ„åœ°å€">
                        <input id="issuerName" class="form-control mb-3" placeholder="æœºæ„åç§°">
                        <button onclick="govAdd()" class="btn btn-danger w-100 fw-bold">æˆæƒ</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-glass"><h5 class="fw-bold mb-4">å·²æˆæƒæœºæ„</h5><table class="table-modern" style="width:100%"><tbody id="issuer-list-tbody"></tbody></table></div>
                </div>
            </div>
        </div>
        
        <!-- 6. Logs -->
        <div id="view-logs" class="view-section">
            <div class="card-glass"><h5 class="fw-bold mb-4">å®¡è®¡æ—¥å¿—</h5><table class="table-modern" style="width:100%"><tbody id="logs-table"></tbody></table></div>
        </div>

    </div>

    <script>
        // ==================== âš™ï¸ é…ç½®åŒº (V9 åœ°å€) ====================
        const ADDR_HKC      = "0x93E9aDd27FA2D73645954e3dE6fe0D82D640658c";
        const ADDR_ID       = "0xDE8A30dBDF83CE5C96017C433A984609B9dC10B8";
        const ADDR_MARKET   = "0x6c5529aA37A5B678B0fb573d0aC8Aa527F26A1F7";
        const RPC_URL     = "https://ethereum-sepolia.publicnode.com";
        // ============================================================

        const ABI_ID = ["function rootIssue(address,string,string,uint256) external", "function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function owner() view returns (address)", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function addIssuer(address,string) external", "function revokeIssuer(address) external", "function getAdminOrg(address) view returns (address)"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "event TradeExecuted(address,string,uint256,string,uint256,uint256)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC, provider;

        window.onload = async () => {
            provider = new ethers.providers.JsonRpcProvider(RPC_URL);
            initContracts(provider);
            loadAssets();
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("Error", "MetaMask?", "error");
            try {
                const p = new ethers.providers.Web3Provider(window.ethereum);
                await p.send("eth_requestAccounts", []);
                signer = p.getSigner();
                myAddr = await signer.getAddress();
                
                document.getElementById("btn-conn").style.display="none";
                document.getElementById("user-badge").classList.remove("d-none");
                document.getElementById("wallet-display").innerText = myAddr.slice(0,6)+"...";
                
                initContracts(signer);
                await checkPermission(); // ğŸ”¥ æ¢å¤æƒé™æ£€æŸ¥
                refreshAll();
            } catch(e) { console.error(e); }
        }

        // ğŸ”¥ ä¿®å¤ï¼šæƒé™æ£€æŸ¥ä¸æŒ‰é’®åŠ¨æ€æ¸²æŸ“ ğŸ”¥
        async function checkPermission() {
            const roleDisp = document.getElementById("my-role-display");
            const orgDisp = document.getElementById("my-org-display");
            const title = document.getElementById("issue-card-title");
            const desc = document.getElementById("issue-desc");
            const area = document.getElementById("issue-btn-area");

            try {
                const owner = await cID.owner();
                
                // 1. Root (ä¸Šå¸æ¨¡å¼)
                if(owner.toLowerCase() === myAddr.toLowerCase()) {
                    roleDisp.innerText = "Root Admin"; orgDisp.innerText = "System Owner";
                    showMenus(".root-only, .admin-only");
                    
                    // åŠ¨æ€æ¸²æŸ“æŒ‰é’®
                    title.innerHTML = "<span class='text-danger'>ğŸš€ Root æé€Ÿå‘è¯</span>";
                    desc.innerText = "æœ€é«˜æƒé™ï¼šæ— éœ€å®¡æ ¸ï¼Œç›´æ¥å‘è¯ã€‚";
                    area.innerHTML = `<button onclick="rootIssue()" class="btn btn-danger w-100 fw-bold py-2">ç«‹å³å‘è¯ (Root)</button>`;
                    return;
                }

                // 2. Admin (æœºæ„æ¨¡å¼)
                const orgAddr = await cID.getAdminOrg(myAddr);
                if(orgAddr !== "0x0000000000000000000000000000000000000000") {
                    const orgInfo = await cID.issuers(orgAddr);
                    roleDisp.innerText = "æœºæ„ç®¡ç†å‘˜"; orgDisp.innerText = orgInfo.name;
                    showMenus(".admin-only"); hideMenus(".root-only");
                    
                    title.innerText = "å‘èµ·ææ¡ˆ (Maker)";
                    desc.innerText = "éœ€ Checker å¤æ ¸ã€‚";
                    area.innerHTML = `<button onclick="proposeID()" class="btn btn-warning w-100 fw-bold text-dark py-2">å‘èµ·ææ¡ˆ</button>`;
                    return;
                }

                // 3. User
                const id = await cID.identities(myAddr);
                if(id.isValid) {
                    roleDisp.innerText = id.role; orgDisp.innerText = id.region;
                } else {
                    roleDisp.innerText = "æ¸¸å®¢ / æ— èº«ä»½"; orgDisp.innerText = "-";
                }
                hideMenus(".admin-only, .root-only");

            } catch(e) { console.warn("Permission check failed", e); }
        }

        function showMenus(s) { document.querySelectorAll(s).forEach(e => e.style.setProperty("display", "block", "important")); }
        function hideMenus(s) { document.querySelectorAll(s).forEach(e => e.style.setProperty("display", "none", "important")); }

        async function ensureSigner() {
            if(signer) return true;
            await connectWallet();
            return !!signer;
        }

        async function tx(p, msg) {
            if(!await ensureSigner()) return;
            try {
                Swal.fire({title:'ç­‰å¾…ç¡®è®¤...', didOpen:()=>Swal.showLoading()});
                const t = await p;
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
                await t.wait();
                Swal.fire("æˆåŠŸ", msg, "success");
                refreshAll();
            } catch(e) { Swal.fire("Error", e.reason||e.message, "error"); }
        }

        function refreshAll() { loadAssets(); if(signer) { loadUserData(); loadProposals(); loadIssuerList(); loadLogs(); } }

        // Actions
        function rootIssue() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.connect(signer).rootIssue(u,r,role,365), "Rootå‘è¯æˆåŠŸ");
        }
        function proposeID() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.connect(signer).proposeIdentity(u,r,role,365), "ææ¡ˆæäº¤");
        }
        
        function approveHKC() { tx(cHKC.connect(signer).approve(ADDR_MARKET, ethers.constants.MaxUint256), "æˆæƒæˆåŠŸ"); }
        function buy(id) { tx(cMKT.connect(signer).buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
        function sell(id,n,p) { tx(cMKT.connect(signer).sellAsset(id), "å–å‡ºæˆåŠŸ"); }
        function addAsset() { tx(cMKT.connect(signer).addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, "", "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }
        function toggle(id,s) { tx(cMKT.connect(signer).setAssetStatus(id,s), "çŠ¶æ€æ›´æ–°"); }
        function govAdd() { tx(cID.connect(signer).addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value), "æˆæƒæˆåŠŸ"); }
        async function approveID(id) { tx(cID.connect(signer).approveIdentity(id), "å®¡æ‰¹é€šè¿‡"); }

        async function loadAssets() {
            const g=document.getElementById("market-grid"), t=document.getElementById("admin-table");
            if(!cMKT) return; g.innerHTML=""; t.innerHTML="";
            const c = await cMKT.assetCount();
            if(c.toNumber()===0) g.innerHTML="<div class='col-12 text-center text-muted py-5'>æš‚æ— èµ„äº§</div>";
            for(let i=1; i<=c; i++) {
                const a = await cMKT.assets(i);
                if(a.isActive) {
                    const hue = (i*137)%360;
                    g.innerHTML+=`
                    <div class="col-md-6 col-lg-4">
                        <div class="asset-card">
                            <div class="asset-visual" style="background:linear-gradient(135deg, hsl(${hue},70%,80%), hsl(${hue},70%,90%)); color:hsl(${hue},70%,40%)">
                                ${a.name.substring(0,2).toUpperCase()}
                                <span class="asset-tag">${a.requiredRegion||'GLOBAL'}</span>
                            </div>
                            <div class="asset-body">
                                <h5 class="fw-bold text-dark">${a.name}</h5>
                                <div class="d-flex justify-content-between align-items-end mt-3">
                                    <span class="asset-price">${a.price} <small>HKC</small></span>
                                    <button class="btn-buy" onclick="buy(${i})">è´­ä¹°</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                t.innerHTML+=`<tr><td>${i}</td><td>${a.name}</td><td>${a.price} HKC</td><td>${a.isActive?'âœ…':'âŒ'}</td><td><button onclick="toggle(${i},${!a.isActive})" class="btn btn-sm btn-light border">Toggle</button></td></tr>`;
            }
        }

        async function loadUserData() {
            if(!signer) return;
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];
            const g = document.getElementById("inventory-grid"); g.innerHTML="";
            const c = await cMKT.assetCount();
            let has=false, count=0;
            for(let i=1; i<=c; i++) {
                const b = await cMKT.userBalances(myAddr, i);
                if(b.gt(0)) {
                    has=true; count+=b.toNumber(); const a = await cMKT.assets(i);
                    g.innerHTML+=`<div class="col-md-4"><div class="card-modern border text-center"><h5 class="fw-bold">${a.name}</h5><span class="badge bg-success my-2">æŒæœ‰: ${b}</span><button onclick="sell(${i},'${a.name}',${a.price})" class="btn btn-outline-danger w-100 btn-sm">å–å‡ºå˜ç°</button></div></div>`;
                }
            }
            if(!has) g.innerHTML="<div class='col-12 text-center text-muted py-5'>æš‚æ— æŒä»“</div>";
            document.getElementById("my-asset-count").innerText = count;
        }

        async function loadProposals() {
            const t = document.getElementById("proposal-table"); t.innerHTML="";
            try {
                const c = await cID.proposalCount();
                let has=false;
                for(let i=c; i>Math.max(0,c-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) { has=true; t.innerHTML+=`<tr><td>#${p.id}</td><td>${p.targetUser.slice(0,6)}...</td><td><span class="badge bg-info">${p.role}</span></td><td><button onclick="approveID(${p.id})" class="btn btn-sm btn-success">æ‰¹å‡†</button></td></tr>`; }
                }
                if(!has) t.innerHTML="<tr><td colspan='5' class='text-center text-muted py-4'>æ— å¾…åŠäº‹é¡¹</td></tr>";
            } catch(e){}
        }
        
        async function loadIssuerList() {
            const t = document.getElementById("issuer-list-tbody"); t.innerHTML="";
            try {
                const l = await cID.getAllIssuers();
                for(let a of l) { const i = await cID.issuers(a); if(i.name) t.innerHTML+=`<tr><td><strong>${i.name}</strong></td><td class="text-muted font-monospace small">${a.slice(0,8)}...</td><td>${i.isActive?'<span class="badge bg-success">Active</span>':'<span class="badge bg-danger">Revoked</span>'}</td></tr>`; }
            } catch(e){}
        }

        async function loadLogs() {
            const t=document.getElementById("logs-table"); t.innerHTML="";
            const l=await cMKT.queryFilter("TradeExecuted", -5000);
            for(let i=l.length-1; i>=0; i--) {
                const e=l[i]; t.innerHTML+=`<tr><td><span class="badge bg-primary">${e.args.type_}</span></td><td>ç”¨æˆ· ${e.args.user.slice(0,6)} æ“ä½œäº† ${e.args.assetName}</td><td><a href="https://sepolia.etherscan.io/tx/${e.transactionHash}" target="_blank" class="text-decoration-none">View</a></td></tr>`;
            }
        }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
            document.getElementById('page-title').innerText = {market:'èµ„äº§äº¤æ˜“å¸‚åœº',profile:'æˆ‘çš„èµ„äº§ä¸­å¿ƒ',issuer:'å‘è¯ä¸ææ¡ˆ',admin:'RWA èµ„äº§ç®¡ç†',gov:'æœºæ„ç›‘ç®¡åå°',logs:'å…¨ç½‘å®¡è®¡æ—¥å¿—'}[p];
            if(signer) refreshAll();
        }
    </script>
</body>
</html>
