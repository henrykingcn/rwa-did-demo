<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>HKUST RWA Exchange</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <nav class="sidebar">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-cube"></i></div>
            <div class="brand-text">
                <h4>RWA.Fi</h4>
                <small>HKUST Demo</small>
            </div>
        </div>
        
        <div class="nav-section-label">Marketplace</div>
        <div onclick="nav('market')" class="nav-item active" id="nav-market"><i class="fas fa-store"></i> äº¤æ˜“å¸‚åœº</div>
        <div onclick="nav('profile')" class="nav-item" id="nav-profile"><i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§ (Sell)</div>
        <div onclick="nav('logs')" class="nav-item" id="nav-logs"><i class="fas fa-list-ul"></i> å®¡è®¡æ—¥å¿—</div>

        <div class="admin-only" style="display:none;">
            <div class="nav-section-label">Admin Console</div>
            <div onclick="nav('issuer')" class="nav-item" id="nav-issuer"><i class="fas fa-stamp"></i> å‘è¯ç®¡ç† (Maker)</div>
            <div onclick="nav('admin')" class="nav-item" id="nav-admin"><i class="fas fa-layer-group"></i> èµ„äº§ç®¡ç†</div>
            <div onclick="nav('userlist')" class="nav-item" id="nav-userlist"><i class="fas fa-users"></i> å·²å‘è¯ç”¨æˆ·</div>
        </div>

        <div class="admin-only" style="display:none;">
            <div class="nav-section-label">Governance</div>
            <div onclick="nav('gov')" class="nav-item" id="nav-gov"><i class="fas fa-building-columns"></i> æœºæ„æ²»ç†</div>
        </div>
    </nav>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">
                <h2 id="page-header-title">äº¤æ˜“å¸‚åœº</h2>
                <p>åŸºäºåŒºå—é“¾çš„å»ä¸­å¿ƒåŒ–å®ç‰©èµ„äº§äº¤æ˜“å¹³å°ã€‚</p>
            </div>
            <div class="user-bar">
                <div class="d-flex align-items-center gap-2 text-success fw-bold" style="font-size:0.8rem">
                    <i class="fas fa-circle" style="font-size:8px"></i> RPC Online
                </div>
                <div class="balance-badge"><span id="hkc-bal">0.00</span> HKC</div>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary-custom btn-sm">è¿æ¥é’±åŒ…</button>
                <div id="wallet-badge" class="wallet-badge d-none">0x...</div>
            </div>
        </div>

        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-end mb-4">
                <button class="btn-outline" onclick="approveHKC()"><i class="fas fa-key me-2"></i> èµ„é‡‘æˆæƒ</button>
            </div>
            <div class="row g-4" id="market-grid"></div>
        </div>

        <div id="view-profile" class="view-section">
            <div class="row mb-5">
                <div class="col-md-8">
                    <div class="card-box bg-primary text-white border-0" style="background:linear-gradient(135deg, #2563eb, #1e40af)">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-grey bg-opacity-20 mb-2">æ•°å­—èº«ä»½ (DID)</span>
                                <h2 class="fw-bold mb-1" id="my-role-display">æœªè¿æ¥</h2>
                                <div class="mt-3 opacity-75" id="my-org-display">è¯·è¿æ¥é’±åŒ…</div>
                            </div>
                            <i class="fas fa-id-card fa-5x opacity-20"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-box h-100 d-flex flex-column justify-content-center align-items-center">
                        <h6 class="text-uppercase text-muted fw-bold small">æŒæœ‰èµ„äº§</h6>
                        <h1 class="fw-bold text-dark m-0" id="my-asset-count">-</h1>
                    </div>
                </div>
            </div>
            <h5 class="fw-bold mb-4">ğŸ“¦ æˆ‘çš„æŒä»“</h5>
            <div class="row g-4" id="inventory-grid"></div>
        </div>

        <div id="view-issuer" class="view-section">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card-box" style="border-top:4px solid #f59e0b">
                        <h5 class="card-label text-warning" id="issue-title">å‘è¯æ“ä½œ</h5>
                        <p class="text-muted small mb-3" id="issue-desc">æ£€æµ‹æƒé™ä¸­...</p>
                        <div class="input-group mb-3">
                            <input id="targetUser" class="form-control" placeholder="ç”¨æˆ·åœ°å€ (0x...)">
                            <button class="btn btn-outline-secondary" onclick="fillMyAddress()">Me</button>
                        </div>
                        <div class="row g-2 mb-4">
                            <div class="col"><select id="targetRegion" class="form-select"><option value="HK">HK é¦™æ¸¯</option><option value="US">US ç¾å›½</option><option value="NK">NK åŒ—éŸ© (Ban)</option></select></div>
                            <div class="col"><select id="targetRole" class="form-select"><option value="Student">Student</option><option value="Investor">Investor</option></select></div>
                        </div>
                        <div id="issue-btn-area"><button class="btn btn-secondary w-100" disabled>Connect Wallet</button></div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-box">
                        <h5 class="card-label">èº«ä»½ææ¡ˆåˆ—è¡¨ (ID Proposals)</h5>
                        <button class="btn btn-sm btn-outline float-end" onclick="loadIDProposals()"><i class="fas fa-sync"></i></button>
                        <table class="table-clean mt-3">
                            <thead><tr><th>User</th><th>Region</th><th>Proposer</th><th>Action</th></tr></thead>
                            <tbody id="id-proposal-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-section">
            <div class="card-box">
                <h5 class="card-label mb-4 text-success">ä¸Šæ¶æ–°èµ„äº§</h5>
                <div class="row g-3 align-items-end">
                    <div class="col-md-5"><label class="small text-muted">åç§°</label><input id="newAssetName" class="form-control" placeholder="Token Name"></div>
                    <div class="col-md-3"><label class="small text-muted">ä»·æ ¼ (HKC)</label><input id="newAssetPrice" type="number" class="form-control" placeholder="100"></div>
                    <div class="col-md-2"><label class="small text-muted">é™åˆ¶åœ°åŒº</label>
                        <select id="newAssetRegion" class="form-select">
                            <option value="">Global</option>
                            <option value="HK">HK Only</option>
                            <option value="US">US Only</option>
                        </select>
                    </div>
                    <div class="col-md-2"><button onclick="addAsset()" class="btn btn-primary-custom w-100">ä¸Šæ¶</button></div>
                </div>
            </div>
            <div class="card-box">
                <h5 class="card-label mb-4">ç®¡ç†èµ„äº§åˆ—è¡¨</h5>
                <table class="table-clean">
                    <thead><tr><th>ID</th><th>Name</th><th>Region</th><th>Issuer</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="admin-table"></tbody>
                </table>
            </div>
        </div>

        <div id="view-gov" class="view-section">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card-box root-only mb-4" style="border-top:4px solid #dc2626; display:none;">
                        <h5 class="card-label text-danger">Root ç‹¬è£æ“ä½œ (God Mode)</h5>
                        <div class="mb-3">
                            <label class="small text-muted">å¼ºåˆ¶åˆ›å»º/æš‚åœæœºæ„</label>
                            <input id="rootIssuerAddr" class="form-control mt-1 mb-2" placeholder="æœºæ„åœ°å€">
                            <input id="rootIssuerName" class="form-control mb-2" placeholder="åç§°">
                            <div class="d-flex gap-2 mb-2">
                                <select id="rootIssuerScope" class="form-select form-select-sm">
                                    <option value="Global">Global</option><option value="HK">HK</option><option value="US">US</option><option value="NK">NK (Ban)</option>
                                </select>
                                <button onclick="rootAddOrg()" class="btn btn-sm btn-danger w-50">Create</button>
                            </div>
                            <div class="d-flex gap-2">
                                <button onclick="rootToggle(true)" class="btn btn-sm btn-outline-warning w-50">Pause</button>
                                <button onclick="rootToggle(false)" class="btn btn-sm btn-outline-success w-50">Resume</button>
                            </div>
                        </div>
                    </div>

                    <div class="card-box" style="border-top:4px solid #4f46e5">
                        <h5 class="card-label text-primary">å‘èµ·æ²»ç†ææ¡ˆ (MultiSig)</h5>
                        <ul class="nav nav-tabs mb-3" id="govTab" role="tablist">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-org">å»ºä¸‹å±æœºæ„</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-admin">ä»»å‘½Admin</button></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-org">
                                <input id="propOrgAddr" class="form-control mb-2" placeholder="æ–°æœºæ„åœ°å€">
                                <input id="propOrgName" class="form-control mb-2" placeholder="æœºæ„åç§°">
                                <select id="propOrgScope" class="form-select mb-2">
                                    <option value="HK">HK</option><option value="US">US</option><option value="NK">NK (Ban)</option>
                                </select>
                                <button onclick="proposeGov(2)" class="btn btn-primary-custom w-100">å‘èµ·å»ºæœºæ„ææ¡ˆ</button>
                            </div>
                            <div class="tab-pane fade" id="tab-admin">
                                <input id="propAdminAddr" class="form-control mb-2" placeholder="æ–°ç®¡ç†å‘˜åœ°å€">
                                <input id="propAdminTargetOrg" class="form-control mb-2" placeholder="ç›®æ ‡æœºæ„åœ°å€ (ç©º=æœ¬æœºæ„)">
                                <button onclick="proposeGov(1)" class="btn btn-primary-custom w-100">å‘èµ·ä»»å‘½ææ¡ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="card-box mb-4">
                        <h5 class="card-label">å¾…æ‰¹å‡†æ²»ç†ææ¡ˆ (Gov Proposals)</h5>
                        <button class="btn btn-sm btn-outline float-end" onclick="loadGovProposals()"><i class="fas fa-sync"></i></button>
                        <table class="table-clean mt-3">
                            <thead><tr><th>Type</th><th>Target</th><th>Detail</th><th>Action</th></tr></thead>
                            <tbody id="gov-proposal-table"></tbody>
                        </table>
                    </div>
                    <div class="card-box">
                        <h5 class="card-label">å…¨ç½‘æœºæ„åˆ—è¡¨ & Admin</h5>
                        <table class="table-clean">
                            <thead><tr><th>Name</th><th>Scope</th><th>Parent</th><th>Status</th></tr></thead>
                            <tbody id="all-issuers-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-userlist" class="view-section">
            <div class="card-box">
                <h5 class="card-label mb-4">æœ¬æœºæ„ä¸‹å‘çš„ç”¨æˆ·åˆ—è¡¨</h5>
                <p class="text-muted" id="my-org-info-text">æ­£åœ¨åŠ è½½...</p>
                <table class="table-clean">
                    <thead><tr><th>User Address</th><th>Region</th><th>Role</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="org-user-tbody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="view-logs" class="view-section">
            <div class="card-box text-center py-5">
                <h4 class="fw-bold mb-4">Blockchain Explorer</h4>
                <div class="row justify-content-center g-3">
                    <div class="col-md-3"><a href="#" id="link-hkc" target="_blank" class="btn btn-outline-primary w-100 py-3">HKC Token</a></div>
                    <div class="col-md-3"><a href="#" id="link-id" target="_blank" class="btn btn-outline-success w-100 py-3">Identity Contract</a></div>
                    <div class="col-md-3"><a href="#" id="link-mkt" target="_blank" class="btn btn-outline-danger w-100 py-3">Market Contract</a></div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==================== âš ï¸ å¡«å…¥æ–°éƒ¨ç½²çš„åœ°å€ ====================
        const ADDR_HKC      = "0xf070Ef78e0c4683E0af44dF29D9aDB2366646c95"; // ä½ çš„ Token
        const ADDR_ID       = "0x646a7cD03dA4f1F6b90A9B92c320712AA55158b5"; // ğŸ”¥ æ–° Identity åœ°å€
        const ADDR_MARKET   = "0x07D9F1A3E407258Ecb37E0fc5d383b2da6094f58"; // ğŸ”¥ æ–° Market åœ°å€
        const RPC_URL       = "https://ethereum-sepolia.publicnode.com"; 
        // ==========================================================

        const ABI_ID = [
            "function rootIssue(address,string,string,uint256) external", 
            "function rootAddIssuer(address,string,string,address) external",
            "function toggleIssuerPause(address,bool) external",
            "function proposeIdentity(address,string,string,uint256) external", 
            "function approveIdentity(uint256) external", 
            "function proposeGovAction(uint8,address,address,string,string) external",
            "function approveGovAction(uint256) external",
            "function revokeIdentity(address) external", // ğŸ”¥ Added Revoke
            "function owner() view returns (address)", 
            "function govProposalCount() view returns (uint256)", 
            "function idProposalCount() view returns (uint256)", 
            "function getGovProposal(uint256) view returns (tuple(uint256 id, uint8 actionType, address targetAddr, address targetOrg, string payloadName, string payloadScope, address proposer, bool executed))", 
            "function getIDProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))",
            "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", 
            "function issuers(address) view returns (bool isActive, bool isPaused, string name, string scope, address parent)", 
            "function getAllIssuers() view returns (address[])", 
            "function getOrgUsers(address) view returns (address[])",
            "function adminOrg(address) view returns (address)",
            "function checkCompliance(address,string,address) view returns (bool, string)"
        ];

        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "function paymentToken() view returns (address)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC;
        let myOrgAddr = ethers.constants.AddressZero;

        window.onload = async () => {
            document.getElementById("link-hkc").href = `https://sepolia.etherscan.io/address/${ADDR_HKC}`;
            document.getElementById("link-id").href = `https://sepolia.etherscan.io/address/${ADDR_ID}`;
            document.getElementById("link-mkt").href = `https://sepolia.etherscan.io/address/${ADDR_MARKET}`;
            const p = new ethers.providers.JsonRpcProvider(RPC_URL);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            loadAssets();
        };

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("Error", "MetaMask needed", "error");
            const p = new ethers.providers.Web3Provider(window.ethereum);
            await p.send("eth_requestAccounts", []);
            signer = p.getSigner();
            myAddr = await signer.getAddress();
            
            cID = new ethers.Contract(ADDR_ID, ABI_ID, signer);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, signer);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, signer);

            document.getElementById("btn-conn").style.display="none";
            document.getElementById("wallet-badge").innerText = myAddr.slice(0,6)+"...";
            document.getElementById("wallet-badge").classList.remove("d-none");
            
            await checkRole();
            refreshAll();
        }

        async function checkRole() {
            try {
                const owner = await cID.owner();
                myOrgAddr = await cID.adminOrg(myAddr);
                const isRoot = (owner.toLowerCase() === myAddr.toLowerCase());
                const isAdmin = (myOrgAddr !== ethers.constants.AddressZero);

                let roleText = "User";
                let orgText = "No Org";

                if (isRoot) {
                    roleText = "Root (God Mode)";
                    orgText = "System Owner";
                    document.querySelectorAll(".root-only, .admin-only").forEach(e=>e.style.setProperty("display","block","important"));
                    document.getElementById("issue-title").innerHTML = "Root ç‹¬è£å‘è¯";
                    document.getElementById("issue-btn-area").innerHTML = `<button onclick="rootIssue()" class="btn btn-danger w-100">Root Issue (Instant)</button>`;
                } else if (isAdmin) {
                    const orgInfo = await cID.issuers(myOrgAddr);
                    roleText = `Admin`;
                    orgText = `${orgInfo.name} (${orgInfo.scope})`;
                    document.querySelectorAll(".admin-only").forEach(e=>e.style.setProperty("display","block","important"));
                    document.getElementById("issue-title").innerHTML = "å‘èµ·èº«ä»½ææ¡ˆ";
                    document.getElementById("issue-btn-area").innerHTML = `<button onclick="proposeID()" class="btn btn-primary-custom w-100">å‘èµ·ææ¡ˆ (Propose)</button>`;
                    document.getElementById("my-org-info-text").innerText = `æœºæ„: ${orgInfo.name} | åœ°åŒº: ${orgInfo.scope}`;
                } else {
                    const id = await cID.identities(myAddr);
                    if(id.isValid) {
                        roleText = id.role;
                        orgText = `Region: ${id.region}`;
                    } else {
                        roleText = "æœªè®¤è¯ç”¨æˆ·";
                    }
                }

                document.getElementById("my-role-display").innerText = roleText;
                document.getElementById("my-org-display").innerText = orgText;

            } catch(e) { console.error(e); }
        }

        async function refreshAll() {
            loadAssets();
            if(signer) {
                loadUserData();
                loadIDProposals();
                loadGovProposals();
                loadAllIssuers();
                if(myOrgAddr !== ethers.constants.AddressZero) loadOrgUsers();
            }
        }

        async function tx(p, msg) {
            try {
                Swal.fire({title:'Sign in Wallet', didOpen:()=>Swal.showLoading()});
                const t = await p;
                Swal.fire({title:'Mining...', didOpen:()=>Swal.showLoading()});
                await t.wait();
                Swal.fire("Success", msg, "success");
                refreshAll();
            } catch(e) { 
                let err = e.reason || e.message;
                if(err.includes("Sanctioned")) err = "åˆ¶è£ï¼šNK (åŒ—éŸ©) åœ°åŒºç¦æ­¢æ­¤æ“ä½œ";
                if(err.includes("Insufficient Allowance")) err = "æˆæƒä¸è¶³ï¼šè¯·å…ˆç‚¹å‡»'èµ„é‡‘æˆæƒ'";
                if(err.includes("Insufficient Balance")) err = "ä½™é¢ä¸è¶³ï¼šä½ çš„ HKC ä¸å¤Ÿ";
                if(err.includes("Identity Invalid")) err = "èº«ä»½æ— æ•ˆï¼šå¯èƒ½å·²è¢«åŠé”€æˆ–è¿‡æœŸ";
                Swal.fire("Error", err, "error"); 
            }
        }

        // Actions
        function rootIssue() { 
            const u=document.getElementById("targetUser").value || myAddr;
            tx(cID.rootIssue(u, document.getElementById("targetRegion").value, document.getElementById("targetRole").value, 365), "Issued");
        }
        function rootAddOrg() {
            tx(cID.rootAddIssuer(document.getElementById("rootIssuerAddr").value, document.getElementById("rootIssuerName").value, document.getElementById("rootIssuerScope").value, ethers.constants.AddressZero), "Org Created");
        }
        function rootToggle(pause) {
            tx(cID.toggleIssuerPause(document.getElementById("rootIssuerAddr").value, pause), "Status Changed");
        }
        function proposeGov(type) {
            const target = (type==1) ? document.getElementById("propAdminAddr").value : document.getElementById("propOrgAddr").value;
            const name = (type==2) ? document.getElementById("propOrgName").value : "";
            const scope = (type==2) ? document.getElementById("propOrgScope").value : "";
            let targetOrg = document.getElementById("propAdminTargetOrg") ? document.getElementById("propAdminTargetOrg").value : "";
            if(targetOrg === "") targetOrg = ethers.constants.AddressZero;
            tx(cID.proposeGovAction(type, target, targetOrg, name, scope), "Proposal Created");
        }
        function approveGov(id) { tx(cID.approveGovAction(id), "Approved"); }
        function proposeID() {
            const u=document.getElementById("targetUser").value;
            tx(cID.proposeIdentity(u, document.getElementById("targetRegion").value, document.getElementById("targetRole").value, 365), "ID Proposed");
        }
        function approveID(id) { tx(cID.approveIdentity(id), "ID Approved"); }
        function revokeID(u) { tx(cID.revokeIdentity(u), "Identity Revoked"); } // ğŸ”¥ Call Revoke

        function approveHKC() { tx(cHKC.approve(ADDR_MARKET, ethers.constants.MaxUint256), "Approved"); }
        function buy(id) { tx(cMKT.buyAsset(id), "Bought"); }
        function sell(id) { tx(cMKT.sellAsset(id), "Sold"); }
        function addAsset() {
            tx(cMKT.addAsset(
                document.getElementById("newAssetName").value, 
                document.getElementById("newAssetPrice").value, 
                document.getElementById("newAssetRegion").value, 
                myOrgAddr
            ), "Asset Added");
        }
        function toggleAsset(id, status) { tx(cMKT.setAssetStatus(id, status), "Status Updated"); }

        // Loaders
        async function loadAssets() {
            const g=document.getElementById("market-grid"), t=document.getElementById("admin-table");
            g.innerHTML=""; t.innerHTML="";
            try {
                const c = await cMKT.assetCount();
                for(let i=1; i<=c; i++) {
                    const a = await cMKT.assets(i);
                    if(a.isActive) {
                        g.innerHTML += `
                        <div class="col-md-4">
                            <div class="asset-card">
                                <div class="asset-visual"><i class="fas fa-cube asset-icon-lg"></i><span class="asset-tag">${a.requiredRegion||'Global'}</span></div>
                                <div class="asset-content">
                                    <div class="asset-title">${a.name}</div>
                                    <div class="asset-price-row"><div class="price-val">${a.price} HKC</div><button onclick="buy(${i})" class="btn btn-sm btn-primary-custom">Buy</button></div>
                                </div>
                            </div>
                        </div>`;
                    }
                    t.innerHTML+=`<tr><td>${i}</td><td>${a.name}</td><td>${a.requiredRegion||'Global'}</td><td>${a.requiredIssuer.slice(0,6)}...</td><td>${a.isActive?'âœ…':'âŒ'}</td><td><button onclick="toggleAsset(${i},${!a.isActive})" class="btn btn-sm btn-outline">Toggle</button></td></tr>`;
                }
            } catch(e){}
        }

        async function loadUserData() {
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];
            const g = document.getElementById("inventory-grid"); g.innerHTML="";
            const c = await cMKT.assetCount();
            let count = 0;
            for(let i=1; i<=c; i++) {
                const b = await cMKT.userBalances(myAddr, i);
                if(b.gt(0)) {
                    const a = await cMKT.assets(i);
                    count += b.toNumber();
                    g.innerHTML+=`<div class="col-md-4"><div class="card-box text-center border-success"><h5 class="text-success">${a.name}</h5><span class="badge bg-success mb-2">Own: ${b}</span><button onclick="sell(${i})" class="btn btn-outline-danger w-100 btn-sm">Sell</button></div></div>`;
                }
            }
            document.getElementById("my-asset-count").innerText = count || "-";
        }

        async function loadIDProposals() {
            const t = document.getElementById("id-proposal-table"); t.innerHTML="";
            const c = await cID.idProposalCount();
            for(let i=c; i>Math.max(0,c-5); i--) {
                const p = await cID.getIDProposal(i);
                if(!p.executed) t.innerHTML+=`<tr><td>${p.targetUser.slice(0,6)}...</td><td>${p.region}</td><td>${p.proposer.slice(0,6)}...</td><td><button onclick="approveID(${p.id})" class="btn btn-sm btn-primary-custom">Approve</button></td></tr>`;
            }
        }

        async function loadGovProposals() {
            const t = document.getElementById("gov-proposal-table"); t.innerHTML="";
            const c = await cID.govProposalCount();
            for(let i=c; i>Math.max(0,c-5); i--) {
                const p = await cID.getGovProposal(i);
                if(!p.executed) {
                    let desc = p.actionType===1 ? "Add Admin" : `New Org: ${p.payloadName}`;
                    t.innerHTML+=`<tr><td>${p.actionType===1?'Admin':'Org'}</td><td>${p.targetAddr.slice(0,6)}...</td><td>${desc}</td><td><button onclick="approveGov(${p.id})" class="btn btn-sm btn-primary-custom">Approve</button></td></tr>`;
                }
            }
        }

        async function loadAllIssuers() {
            const t = document.getElementById("all-issuers-table"); t.innerHTML="";
            const list = await cID.getAllIssuers();
            for(let a of list) {
                const i = await cID.issuers(a);
                let badge = i.isActive ? (i.isPaused ? '<span class="badge bg-warning text-dark">Paused</span>' : '<span class="badge bg-success">Active</span>') : '<span class="badge bg-danger">Revoked</span>';
                t.innerHTML+=`<tr><td>${i.name}</td><td>${i.scope}</td><td>${i.parent.slice(0,4)}...</td><td>${badge}</td></tr>`;
            }
        }

        async function loadOrgUsers() {
            const t = document.getElementById("org-user-tbody"); t.innerHTML="";
            try {
                const list = await cID.getOrgUsers(myOrgAddr);
                for(let u of list) {
                    const id = await cID.identities(u);
                    // ğŸ”¥ Add Revoked Status Check
                    let status = id.isValid ? 'âœ… Valid' : 'âŒ Revoked';
                    let btn = id.isValid ? `<button onclick="revokeID('${u}')" class="btn btn-sm btn-outline-danger">åŠé”€</button>` : `<span class="text-muted">-</span>`;
                    
                    t.innerHTML+=`<tr><td>${u.slice(0,10)}...</td><td>${id.region}</td><td>${id.role}</td><td>${status}</td><td>${btn}</td></tr>`;
                }
            } catch(e){}
        }

        function fillMyAddress() { document.getElementById("targetUser").value = myAddr; }
        
        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); 
            document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); 
            document.getElementById('nav-'+p).classList.add('active');
            if(signer) refreshAll();
        }
    </script>
</body>
</html>
