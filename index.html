<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKUST RWA Platform (V13 Restored)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; 
            --bg-body: #f8fafc; --bg-card: #ffffff; 
            --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0;
            --sidebar-width: 260px;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-hover: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-x: hidden; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--bg-card); border-right: 1px solid var(--border); z-index: 1000; padding-top: 24px; }
        .brand { padding: 0 24px 24px; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
        .brand h4 { font-weight: 800; color: var(--primary); margin: 0; letter-spacing: -0.5px; }
        .nav-item { padding: 12px 24px; color: var(--text-sub); display: flex; align-items: center; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; font-weight: 500; }
        .nav-item:hover { background: #f1f5f9; color: var(--primary); }
        .nav-item.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
        .nav-item i { width: 24px; margin-right: 12px; text-align: center; font-size: 1.1rem; }
        
        /* ä¸»åŒºåŸŸ */
        .main-content { margin-left: var(--sidebar-width); padding: 32px 40px; }
        .top-bar { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; box-shadow: var(--shadow-sm); }
        
        /* å¡ç‰‡é€šç”¨ */
        .card-modern { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-sm); transition: 0.3s; margin-bottom: 24px; }
        
        /* ğŸ† è¿˜åŸå›ä½ å–œæ¬¢çš„ NFT å¡ç‰‡æ ·å¼ (V9 ç»“æ„ + V10 é…è‰²) */
        .asset-card { background: white; border-radius: 16px; overflow: hidden; border: 1px solid var(--border); transition: all 0.3s ease; position: relative; box-shadow: var(--shadow-sm); }
        .asset-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); border-color: #bfdbfe; }
        
        .asset-img { 
            height: 180px; 
            /* è¿™æ˜¯ä¸€ä¸ªæ¼‚äº®çš„å¾®æ¸å˜ï¼Œè¿˜åŸé«˜çº§æ„Ÿ */
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 2.5rem; font-weight: 800; color: #94a3b8; 
            position: relative; 
        }
        
        .asset-badge { 
            position: absolute; top: 12px; right: 12px; 
            background: rgba(255,255,255,0.95); color: #0f172a; 
            padding: 4px 10px; border-radius: 20px; 
            font-size: 0.75rem; font-weight: 700; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        
        .asset-body { padding: 20px; }
        .asset-title { font-size: 1.1rem; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
        .asset-price { font-size: 1.25rem; font-weight: 800; color: var(--primary); }
        
        .btn-action { width: 100%; padding: 10px; border-radius: 10px; border: none; font-weight: 600; transition: 0.2s; margin-top: 15px; }
        .btn-buy { background: var(--text-main); color: white; }
        .btn-buy:hover { background: var(--primary); }
        .btn-sell { background: white; border: 1px solid #ef4444; color: #ef4444; }
        .btn-sell:hover { background: #ef4444; color: white; }

        /* çŠ¶æ€ä¸æƒé™ */
        .admin-only, .root-only { display: none !important; }
        .view-section { display: none; animation: fadeUp 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .form-control, .form-select { padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: #f8fafc; }
        .form-control:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand">
            <h4>ğŸ¦ RWA.Fi</h4>
            <small style="color:#64748b">V13.0 Restored</small>
        </div>
        
        <div class="px-3 mb-2"><small class="text-uppercase text-muted fw-bold" style="font-size:0.7rem">Marketplace</small></div>
        <div onclick="nav('market')" class="nav-item active" id="nav-market"><i class="fas fa-store-alt"></i> äº¤æ˜“å¸‚åœº</div>
        <div onclick="nav('profile')" class="nav-item" id="nav-profile"><i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§ (Sell)</div>

        <div class="admin-only">
            <div class="px-3 mt-4 mb-2"><small class="text-uppercase text-muted fw-bold" style="font-size:0.7rem">Admin Zone</small></div>
            <div onclick="nav('issuer')" class="nav-item" id="nav-issuer"><i class="fas fa-file-signature"></i> å‘è¯ç®¡ç† (Multi-Sig)</div>
            <div onclick="nav('logs')" class="nav-item" id="nav-logs"><i class="fas fa-history"></i> å®¡è®¡æ—¥å¿—</div>
        </div>

        <div class="root-only">
            <div class="px-3 mt-4 mb-2"><small class="text-uppercase text-muted fw-bold" style="font-size:0.7rem">Governance</small></div>
            <div onclick="nav('admin')" class="nav-item" id="nav-admin"><i class="fas fa-layer-group"></i> èµ„äº§ä¸Šæ¶</div>
            <div onclick="nav('gov')" class="nav-item" id="nav-gov"><i class="fas fa-building-columns"></i> æœºæ„ç›‘ç®¡</div>
        </div>
    </nav>

    <div class="main-content">
        <header class="top-bar">
            <div><h4 class="m-0 fw-bold text-dark">èµ„äº§äº¤æ˜“å¹³å°</h4><small class="text-muted" id="net-status">RPC Online</small></div>
            <div class="d-flex align-items-center gap-3">
                <div id="id-badge" class="d-none px-3 py-2 rounded-3 bg-success bg-opacity-10 text-success border border-success fw-bold small">å·²è®¤è¯</div>
                <div class="px-3 py-2 rounded-3 bg-primary bg-opacity-10 text-primary border border-primary fw-bold small">
                    <i class="fas fa-coins me-2"></i><span id="hkc-bal">-</span> HKC
                </div>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary rounded-pill px-4 fw-bold">è¿æ¥é’±åŒ…</button>
                <span id="wallet-addr" class="text-muted small fw-bold font-monospace d-none bg-white px-2 py-1 rounded border"></span>
            </div>
        </header>

        <!-- 1. å¸‚åœº (Market) -->
        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-between mb-4">
                <p class="text-muted m-0 align-self-center">æµè§ˆå…¨çƒåˆè§„ RWA èµ„äº§ã€‚</p>
                <button class="btn btn-dark btn-sm fw-bold px-3" onclick="approveHKC()"><i class="fas fa-key me-2"></i> èµ„é‡‘æˆæƒ</button>
            </div>
            <div class="row g-4" id="market-grid">
                <div class="col-12 text-center py-5 text-muted"><div class="spinner-border text-primary mb-2"></div><p>Loading Assets...</p></div>
            </div>
        </div>

        <!-- 2. ä¸ªäººä¸­å¿ƒ (Profile) -->
        <div id="view-profile" class="view-section">
            <div class="row mb-5">
                <div class="col-md-8">
                    <div class="card-modern bg-primary text-white border-0" style="background: linear-gradient(120deg, #2563eb 0%, #1e40af 100%);">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-white bg-opacity-25 mb-2">DID æ•°å­—èº«ä»½</span>
                                <h2 class="fw-bold mb-1" id="my-role-display">æœªè¿æ¥</h2>
                                <div class="mt-3 d-flex gap-2">
                                    <span class="badge bg-white text-primary" id="my-region-display">-</span>
                                    <span class="badge bg-white bg-opacity-25" id="my-org-display">-</span>
                                </div>
                            </div>
                            <i class="fas fa-id-card fa-5x opacity-25"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-modern h-100 d-flex flex-column justify-content-center align-items-center text-center">
                        <h6 class="text-muted text-uppercase fw-bold small mb-2">æŒæœ‰èµ„äº§æ€»æ•°</h6>
                        <h1 class="fw-bold text-dark m-0" id="my-asset-count">0</h1>
                    </div>
                </div>
            </div>
            <h5 class="fw-bold text-dark mb-4">ğŸ“¦ æˆ‘çš„æŒä»“ (Inventory)</h5>
            <div class="row g-4" id="inventory-grid"><div class="col-12 text-center py-5 text-muted">æš‚æ— æŒä»“</div></div>
        </div>

        <!-- 3. å‘è¯ (Issuer) -->
        <div id="view-issuer" class="view-section">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card-modern border-top border-4 border-warning">
                        <h5 class="fw-bold text-warning mb-4" id="issue-card-title">å‘è¯æ“ä½œ</h5>
                        <p class="small text-muted" id="issue-desc">æ­£åœ¨æ£€æµ‹æƒé™...</p>
                        <input id="targetUser" class="form-control mb-3" placeholder="ç”¨æˆ·åœ°å€ (0x...)">
                        <div class="row mb-3">
                            <div class="col"><select id="targetRegion" class="form-select"><option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯</option><option value="US">ğŸ‡ºğŸ‡¸ ç¾å›½</option></select></div>
                            <div class="col"><select id="targetRole" class="form-select"><option value="Student">å­¦ç”Ÿ</option><option value="Investor">æŠ•èµ„äºº</option></select></div>
                        </div>
                        <div id="issue-btn-area"><button class="btn btn-secondary w-100" disabled>è¯·è¿æ¥é’±åŒ…</button></div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-modern">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold m-0">å¾…å®¡æ‰¹åˆ—è¡¨ (Checker)</h5>
                            <button onclick="loadProposals()" class="btn btn-sm btn-light border"><i class="fas fa-sync"></i></button>
                        </div>
                        <table class="table table-hover"><tbody id="proposal-table"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. èµ„äº§ç®¡ç† (Admin) -->
        <div id="view-admin" class="view-section">
            <div class="card-modern">
                <h5 class="fw-bold text-success mb-4">ä¸Šæ¶æ–°èµ„äº§</h5>
                <div class="row g-2">
                    <div class="col-5"><input id="newAssetName" class="form-control" placeholder="åç§°"></div>
                    <div class="col-3"><input id="newAssetPrice" type="number" class="form-control" placeholder="ä»·æ ¼"></div>
                    <div class="col-2"><select id="newAssetRegion" class="form-select"><option value="">ğŸŒ Global</option><option value="HK">ğŸ‡­ğŸ‡° HK</option></select></div>
                    <div class="col-2"><button onclick="addAsset()" class="btn btn-success w-100 fw-bold">ä¸Šæ¶</button></div>
                </div>
                <hr class="opacity-25 my-4">
                <h5 class="fw-bold mb-3">ç°å­˜èµ„äº§</h5>
                <table class="table table-hover align-middle"><tbody id="admin-table"></tbody></table>
            </div>
        </div>

        <!-- 5. ç›‘ç®¡ (Gov) -->
        <div id="view-gov" class="view-section">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="card-modern border-top border-4 border-danger">
                        <h5 class="fw-bold text-danger mb-4">æœºæ„æˆæƒ</h5>
                        <input id="issuerAddr" class="form-control mb-3" placeholder="æœºæ„åœ°å€ (0x...)">
                        <input id="issuerName" class="form-control mb-3" placeholder="æœºæ„åç§° (e.g. HKUST)">
                        <div class="d-flex gap-2">
                            <button onclick="govAdd()" class="btn btn-danger w-100 fw-bold">æˆæƒ</button>
                            <button onclick="govRevoke()" class="btn btn-outline-danger w-100 fw-bold">åŠé”€</button>
                        </div>
                        <hr>
                        <h6 class="fw-bold text-primary mb-3">ç®¡ç†å‘˜ç»‘å®š</h6>
                        <input id="adminAddr" class="form-control mb-2" placeholder="ç®¡ç†å‘˜åœ°å€">
                        <input id="bindOrgAddr" class="form-control mb-2" placeholder="æ‰€å±æœºæ„åœ°å€">
                        <button onclick="govAddAdmin()" class="btn btn-primary w-100">ç»‘å®š (Add Admin)</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-modern">
                        <h5 class="fw-bold mb-4">å·²æˆæƒæœºæ„</h5>
                        <table class="table table-hover"><tbody id="issuer-list-tbody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 6. æ—¥å¿— -->
        <div id="view-logs" class="view-section">
            <div class="card-modern"><h5 class="fw-bold mb-4">å®¡è®¡æ—¥å¿—</h5><table class="table table-striped"><tbody id="logs-table"></tbody></table></div>
        </div>

    </div>

    <script>
        // ==================== âš™ï¸ é…ç½®åŒº (SystemV9 åœ°å€) ====================
        const ADDR_HKC      = "0x93E9aDd27FA2D73645954e3dE6fe0D82D640658c";
        const ADDR_ID       = "0xDE8A30dBDF83CE5C96017C433A984609B9dC10B8";
        const ADDR_MARKET   = "0x6c5529aA37A5B678B0fb573d0aC8Aa527F26A1F7";
        
        const RPC_NODES = ["https://ethereum-sepolia.publicnode.com", "https://sepolia.drpc.org", "https://rpc.sepolia.org"];
        // =================================================================

        const ABI_ID = ["function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function addIssuer(address,string) external", "function revokeIssuer(address) external", "function addAdmin(address,address) external", "function getAdminOrg(address) view returns (address)", "function owner() view returns (address)", "function rootIssue(address,string,string,uint256) external"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "event TradeExecuted(address,string,uint256,string,uint256,uint256)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC, provider;

        window.onload = async () => {
            for(let url of RPC_NODES) {
                try {
                    provider = new ethers.providers.JsonRpcProvider(url);
                    await provider.getBlockNumber();
                    console.log("RPC Connected:", url);
                    initContracts(provider);
                    loadAssets();
                    return;
                } catch(e){}
            }
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("Error", "MetaMask?", "error");
            try {
                const p = new ethers.providers.Web3Provider(window.ethereum);
                await p.send("eth_requestAccounts", []);
                signer = p.getSigner();
                myAddr = await signer.getAddress();
                
                document.getElementById("btn-conn").classList.add("d-none");
                document.getElementById("wallet-addr").classList.remove("d-none");
                document.getElementById("wallet-addr").innerText = myAddr.slice(0,6)+"...";
                document.getElementById("id-badge").classList.remove("d-none");
                
                initContracts(signer);
                checkRoleAndUI();
                refreshAll();
            } catch(e) { console.error(e); }
        }

        // ğŸ”¥ é€»è¾‘ä¿®å¤ï¼šæ·»åŠ äº†æƒé™åˆ¤æ–­ ğŸ”¥
        async function checkRoleAndUI() {
            const roleDisp = document.getElementById("my-role-display");
            const orgDisp = document.getElementById("my-org-display");
            const title = document.getElementById("issue-card-title");
            const desc = document.getElementById("issue-desc");
            const area = document.getElementById("issue-btn-area");

            try {
                const owner = await cID.owner();
                
                if(owner.toLowerCase() === myAddr.toLowerCase()) {
                    roleDisp.innerText = "Root Admin"; orgDisp.innerText = "System Owner";
                    showMenus(".root-only, .admin-only");
                    title.innerHTML = "<span class='text-danger'>ğŸš€ Root æé€Ÿå‘è¯</span>";
                    desc.innerText = "Root æƒé™ï¼šæ— éœ€å®¡æ ¸ã€‚";
                    area.innerHTML = `<button onclick="rootIssue()" class="btn-action btn-buy" style="background:#dc2626">ç«‹å³å‘è¯ (Root)</button>`;
                    return;
                }

                const orgAddr = await cID.getAdminOrg(myAddr);
                if(orgAddr !== "0x0000000000000000000000000000000000000000") {
                    const orgInfo = await cID.issuers(orgAddr);
                    roleDisp.innerText = "æœºæ„ç®¡ç†å‘˜"; orgDisp.innerText = orgInfo.name;
                    showMenus(".admin-only"); hideMenus(".root-only");
                    title.innerText = "å‘èµ·ææ¡ˆ (Maker)";
                    desc.innerText = "éœ€å¤æ ¸ã€‚";
                    area.innerHTML = `<button onclick="proposeID()" class="btn-action btn-buy" style="background:#f59e0b; color:black">å‘èµ·ææ¡ˆ</button>`;
                    return;
                }

                const id = await cID.identities(myAddr);
                if(id.isValid) {
                    roleDisp.innerText = id.role; orgDisp.innerText = "Region: " + id.region;
                } else {
                    roleDisp.innerText = "æ¸¸å®¢ / æ— èº«ä»½"; orgDisp.innerText = "-";
                }
                hideMenus(".admin-only, .root-only");

            } catch(e) { console.warn("Permission check failed", e); }
        }

        function showMenus(s) { document.querySelectorAll(s).forEach(e => e.style.setProperty("display", "block", "important")); }
        function hideMenus(s) { document.querySelectorAll(s).forEach(e => e.style.setProperty("display", "none", "important")); }

        async function ensureSigner() {
            if(signer) return true;
            await connectWallet();
            return !!signer;
        }

        async function tx(p, msg) {
            if(!await ensureSigner()) return;
            try {
                Swal.fire({title:'ç¡®è®¤äº¤æ˜“...', didOpen:()=>Swal.showLoading()});
                const t = await p;
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
                await t.wait();
                Swal.fire("æˆåŠŸ", msg, "success");
                refreshAll();
            } catch(e) { 
                // ğŸ”¥ é”™è¯¯ä¿¡æ¯ä¼˜åŒ– ğŸ”¥
                let err = e.reason || e.message;
                if(err.includes("Ownable")) err = "æƒé™ä¸è¶³ï¼šä½ ä¸æ˜¯ Owner (Root)";
                if(err.includes("Identity Invalid")) err = "èº«ä»½æ— æ•ˆï¼šä½ æ²¡æœ‰æœ‰æ•ˆè¯ä»¶";
                Swal.fire("é”™è¯¯", err, "error"); 
            }
        }

        function refreshAll() { loadAssets(); if(signer) { loadUserData(); loadProposals(); loadIssuerList(); loadLogs(); } }

        // Actions
        function rootIssue() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.connect(signer).rootIssue(u,r,role,365), "Rootå‘è¯æˆåŠŸ");
        }
        function proposeID() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.connect(signer).proposeIdentity(u,r,role,365), "ææ¡ˆæäº¤");
        }
        
        function approveHKC() { tx(cHKC.connect(signer).approve(ADDR_MARKET, ethers.constants.MaxUint256), "æˆæƒæˆåŠŸ"); }
        function buy(id) { tx(cMKT.connect(signer).buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
        function sell(id,n,p) { tx(cMKT.connect(signer).sellAsset(id), "å–å‡ºæˆåŠŸ"); }
        function addAsset() { tx(cMKT.connect(signer).addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, "", "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }
        function toggle(id,s) { tx(cMKT.connect(signer).setAssetStatus(id,s), "çŠ¶æ€æ›´æ–°"); }
        
        // Gov Actions (åŒ…å«é¢„åˆ¤é€»è¾‘ï¼Œé˜²æ­¢ä¹±ç‚¹)
        async function govAdd() {
            const owner = await cID.owner();
            if(owner.toLowerCase() !== myAddr.toLowerCase()) return Swal.fire("æƒé™", "åªæœ‰ Root å¯ä»¥æ·»åŠ æœºæ„", "error");
            tx(cID.connect(signer).addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value), "æˆæƒæˆåŠŸ"); 
        }
        function govAddAdmin() { tx(cID.connect(signer).addAdmin(document.getElementById("adminAddr").value, document.getElementById("bindOrgAddr").value), "ç»‘å®šæˆåŠŸ"); }
        function govRevoke() { tx(cID.connect(signer).revokeIssuer(document.getElementById("issuerAddr").value), "åŠé”€æˆåŠŸ"); }
        
        async function approveID(id) { tx(cID.connect(signer).approveIdentity(id), "å®¡æ‰¹é€šè¿‡"); }

        async function loadAssets() {
            const g=document.getElementById("market-grid"), t=document.getElementById("admin-table");
            if(!cMKT) return; g.innerHTML=""; t.innerHTML="";
            try {
                const c = await cMKT.assetCount();
                if(c.toNumber()===0) g.innerHTML="<div class='col-12 text-center text-muted py-5'>æš‚æ— èµ„äº§</div>";
                for(let i=1; i<=c; i++) {
                    const a = await cMKT.assets(i);
                    if(a.isActive) {
                        const hue = (i*137)%360;
                        g.innerHTML+=`
                        <div class="col-md-6 col-lg-4">
                            <div class="asset-card">
                                <div class="asset-img" style="background:linear-gradient(135deg, hsl(${hue},70%,90%), hsl(${hue},70%,80%)); color:hsl(${hue},60%,40%)">
                                    ${a.name.substring(0,2).toUpperCase()}
                                    <span class="asset-badge">${a.requiredRegion||'GLOBAL'}</span>
                                </div>
                                <div class="asset-body">
                                    <h5 class="asset-title">${a.name}</h5>
                                    <div class="d-flex justify-content-between align-items-end mt-3">
                                        <span class="asset-price">${a.price} <small>HKC</small></span>
                                        <button class="btn-action btn-buy" style="width:auto; margin:0" onclick="buy(${i})">è´­ä¹°</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                    t.innerHTML+=`<tr><td>${i}</td><td>${a.name}</td><td>${a.price} HKC</td><td>${a.isActive?'âœ…':'âŒ'}</td><td><button onclick="toggle(${i},${!a.isActive})" class="btn btn-sm btn-light border">åˆ‡æ¢</button></td></tr>`;
                }
            } catch(e){}
        }

        async function loadUserData() {
            if(!signer) return;
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];
            
            const g = document.getElementById("inventory-grid"); g.innerHTML="";
            const c = await cMKT.assetCount();
            let has=false, count=0;
            for(let i=1; i<=c; i++) {
                const b = await cMKT.userBalances(myAddr, i);
                if(b.gt(0)) {
                    has=true; count+=b.toNumber(); const a = await cMKT.assets(i);
                    g.innerHTML+=`<div class="col-md-4"><div class="card-modern text-center border"><h5 class="fw-bold mb-2">${a.name}</h5><span class="badge bg-success mb-3">æŒæœ‰: ${b}</span><button onclick="sell(${i},'${a.name}',${a.price})" class="btn-action btn-sell">å–å‡ºå˜ç°</button></div></div>`;
                }
            }
            if(!has) g.innerHTML="<div class='col-12 text-center text-muted py-5'>æš‚æ— æŒä»“</div>";
            document.getElementById("my-asset-count").innerText = count;
        }

        async function loadProposals() {
            const t = document.getElementById("proposal-table"); t.innerHTML="";
            try {
                const c = await cID.proposalCount();
                let has=false;
                for(let i=c; i>Math.max(0,c-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) { has=true; t.innerHTML+=`<tr><td>#${p.id}</td><td>${p.targetUser.slice(0,6)}...</td><td><span class="badge bg-info">${p.role}</span></td><td><button onclick="approveID(${p.id})" class="btn btn-sm btn-success">æ‰¹å‡†</button></td></tr>`; }
                }
                if(!has) t.innerHTML="<tr><td colspan='5' class='text-center text-muted py-4'>æ— å¾…åŠäº‹é¡¹</td></tr>";
            } catch(e){}
        }
        
        async function loadIssuerList() {
            const t = document.getElementById("issuer-list-tbody"); t.innerHTML="";
            try {
                const l = await cID.getAllIssuers();
                for(let a of l) { const i = await cID.issuers(a); if(i.name) t.innerHTML+=`<tr><td><strong>${i.name}</strong></td><td class="text-muted font-monospace small">${a}</td><td>${i.isActive?'<span class="badge bg-success">Active</span>':'<span class="badge bg-danger">Revoked</span>'}</td></tr>`; }
            } catch(e){}
        }

        async function loadLogs() {
            const t=document.getElementById("logs-table"); t.innerHTML="";
            const l=await cMKT.queryFilter("TradeExecuted", -2000);
            for(let i=l.length-1; i>=0; i--) {
                const e=l[i]; t.innerHTML+=`<tr><td><span class="badge bg-primary">${e.args.type_}</span></td><td>ç”¨æˆ· ${e.args.user.slice(0,6)} æ“ä½œäº† ${e.args.assetName}</td><td><a href="https://sepolia.etherscan.io/tx/${e.transactionHash}" target="_blank" class="text-decoration-none">View</a></td></tr>`;
            }
        }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
            if(signer) refreshAll();
        }
    </script>
</body>
</html>
