<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>HKUST RWA Platform V11</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg: #f8fafc; --text: #334155; --sidebar: #ffffff; --accent: #2563eb;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: 260px; height: 100vh; position: fixed; background: var(--sidebar); border-right: 1px solid #e2e8f0; padding-top: 20px; z-index: 1000; transition: 0.3s; }
        .sidebar-brand { padding: 0 25px 20px; border-bottom: 1px solid #f1f5f9; margin-bottom: 10px; }
        .nav-link { color: #64748b; padding: 12px 25px; cursor: pointer; display: flex; align-items: center; font-weight: 500; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { color: var(--accent); background: #eff6ff; border-right: 3px solid var(--accent); }
        .nav-link i { width: 24px; margin-right: 10px; }
        
        /* æƒé™æ§åˆ¶ç±»ï¼šé»˜è®¤éšè— */
        .admin-only { display: none !important; }
        .root-only { display: none !important; }

        /* ä¸»ä½“ */
        .main { margin-left: 260px; padding: 30px; }
        .top-bar { background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .card-custom { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); margin-bottom: 20px; }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        
        .asset-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: 0.3s; }
        .asset-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: var(--accent); }
        .asset-img { height: 160px; background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 800; color: #0ea5e9; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-brand">
            <h4 class="fw-bold text-primary">ğŸ¦ RWA LAB</h4>
            <small class="text-muted" style="font-size:0.75rem">Enterprise Edition V9</small>
        </div>
        
        <div class="nav flex-column">
            <small class="px-4 text-uppercase text-muted fw-bold mb-2" style="font-size:0.7rem">User Zone</small>
            <a onclick="nav('market')" class="nav-link active" id="nav-market"><i class="fas fa-store"></i> äº¤æ˜“å¸‚åœº</a>
            <a onclick="nav('profile')" class="nav-link" id="nav-profile"><i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§</a>
            
            <!-- ç®¡ç†å‘˜å¯è§åŒºåŸŸ -->
            <div class="admin-only">
                <div style="margin: 20px 25px; border-top: 1px solid #f1f5f9;"></div>
                <small class="px-4 text-uppercase text-muted fw-bold mb-2" style="font-size:0.7rem">Management</small>
                <a onclick="nav('issuer')" class="nav-link" id="nav-issuer"><i class="fas fa-file-signature"></i> å‘è¯ (Multi-Sig)</a>
                <a onclick="nav('logs')" class="nav-link" id="nav-logs"><i class="fas fa-history"></i> å®¡è®¡æ—¥å¿—</a>
            </div>

            <!-- Root å¯è§åŒºåŸŸ -->
            <div class="root-only">
                <a onclick="nav('admin')" class="nav-link" id="nav-admin"><i class="fas fa-boxes"></i> èµ„äº§ä¸Šæ¶</a>
                <a onclick="nav('gov')" class="nav-link" id="nav-gov"><i class="fas fa-building"></i> æœºæ„ç›‘ç®¡</a>
            </div>
        </div>
    </nav>

    <div class="main">
        <div class="top-bar">
            <h5 class="m-0 fw-bold" id="page-title">äº¤æ˜“å¸‚åœº</h5>
            <div class="d-flex align-items-center gap-3">
                <!-- èº«ä»½æ˜¾ç¤º -->
                <div id="user-status" class="badge bg-light text-dark border px-3 py-2">
                    <i class="fas fa-circle-notch fa-spin"></i> æ£€æŸ¥ä¸­...
                </div>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary btn-sm">è¿æ¥é’±åŒ…</button>
            </div>
        </div>

        <!-- 1. å¸‚åœº (Public) -->
        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-between mb-3">
                <p class="text-muted">åˆè§„ RWA èµ„äº§äº¤æ˜“ã€‚</p>
                <button class="btn btn-dark btn-sm" onclick="approveHKC()">æˆæƒèµ„é‡‘</button>
            </div>
            <div class="row" id="market-grid"><div class="text-center py-5">Loading...</div></div>
        </div>

        <!-- 2. ä¸ªäººä¸­å¿ƒ (Public) -->
        <div id="view-profile" class="view-section">
            <div class="card-custom bg-primary text-white">
                <h5 class="opacity-75">æˆ‘çš„æ•°å­—èº«ä»½</h5>
                <h2 class="fw-bold my-2" id="my-role-display">æœªè¿æ¥</h2>
                <span class="badge bg-white bg-opacity-25" id="my-org-display"></span>
            </div>
            <h5 class="mt-4 mb-3">æˆ‘çš„æŒä»“</h5>
            <div class="row" id="inventory-grid"></div>
        </div>

        <!-- 3. å‘è¯ (Admin Only) -->
        <div id="view-issuer" class="view-section">
            <div class="row">
                <div class="col-md-5">
                    <div class="card-custom border-top border-warning border-4">
                        <h5 class="text-warning">å‘èµ·ææ¡ˆ (Maker)</h5>
                        <input id="targetUser" class="form-control mb-2" placeholder="ç”¨æˆ·åœ°å€">
                        <select id="targetRegion" class="form-select mb-2"><option value="HK">HK é¦™æ¸¯</option><option value="US">US ç¾å›½</option></select>
                        <select id="targetRole" class="form-select mb-3"><option value="Student">Student</option><option value="Investor">Investor</option></select>
                        <button onclick="proposeID()" class="btn btn-warning w-100 fw-bold">å‘èµ·</button>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-custom">
                        <h5>å¾…å®¡æ‰¹åˆ—è¡¨ (Checker)</h5>
                        <table class="table"><tbody id="proposal-table"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. èµ„äº§ç®¡ç† (Root Only) -->
        <div id="view-admin" class="view-section">
            <div class="card-custom">
                <h5>ä¸Šæ¶æ–°èµ„äº§</h5>
                <div class="input-group mb-3">
                    <input id="newAssetName" class="form-control" placeholder="åç§°">
                    <input id="newAssetPrice" class="form-control" placeholder="ä»·æ ¼">
                    <button onclick="addAsset()" class="btn btn-success">ä¸Šæ¶</button>
                </div>
                <table class="table"><tbody id="admin-table"></tbody></table>
            </div>
        </div>

        <!-- 5. ç›‘ç®¡ (Root Only) -->
        <div id="view-gov" class="view-section">
            <div class="card-custom border-danger border-top border-4">
                <h5 class="text-danger">æœºæ„ç›‘ç®¡</h5>
                <p class="small text-muted">æ·»åŠ ç®¡ç†å‘˜(Admin)è¯·å‰å¾€ Remix æ“ä½œåˆçº¦ã€‚</p>
                <div class="input-group mb-3">
                    <input id="issuerAddr" class="form-control" placeholder="æœºæ„åœ°å€">
                    <input id="issuerName" class="form-control" placeholder="æœºæ„åç§°">
                    <button onclick="govAdd()" class="btn btn-danger">æˆæƒæœºæ„</button>
                </div>
                <table class="table"><tbody id="issuer-list-tbody"></tbody></table>
            </div>
        </div>
        
        <!-- 6. æ—¥å¿— (Admin) -->
        <div id="view-logs" class="view-section">
            <div class="card-custom"><h5>ç³»ç»Ÿæ—¥å¿—</h5><table class="table table-striped"><tbody id="logs-table"></tbody></table></div>
        </div>

    </div>

    <script>
        // âš ï¸ å¡«å…¥ V9 åˆçº¦åœ°å€
        const ADDR_HKC      = "0x93E9aDd27FA2D73645954e3dE6fe0D82D640658c";
        const ADDR_ID       = "0xDE8A30dBDF83CE5C96017C433A984609B9dC10B8";
        const ADDR_MARKET   = "0x6c5529aA37A5B678B0fb573d0aC8Aa527F26A1F7";
        const RPC_URL     = "https://ethereum-sepolia.publicnode.com";

        const ABI_ID = ["function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function addIssuer(address,string) external", "function revokeIssuer(address) external", "function getAdminOrg(address) view returns (address)", "function owner() view returns (address)"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "event TradeExecuted(address,string,uint256,string,uint256,uint256)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC, provider;

        window.onload = async () => {
            provider = new ethers.providers.JsonRpcProvider(RPC_URL);
            initContracts(provider);
            loadAssets(); // å…é’±åŒ…çœ‹å¸‚åœº
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("Err", "MetaMask?", "error");
            const p = new ethers.providers.Web3Provider(window.ethereum);
            await p.send("eth_requestAccounts", []);
            signer = p.getSigner();
            myAddr = await signer.getAddress();
            
            document.getElementById("btn-conn").style.display="none";
            initContracts(signer);
            checkRoleAndUI();
            refreshAll();
        }

        // ğŸ”¥ æ ¸å¿ƒæƒé™åˆ¤æ–­é€»è¾‘ ğŸ”¥
        async function checkRoleAndUI() {
            const statusBadge = document.getElementById("user-status");
            const roleDisplay = document.getElementById("my-role-display");
            const orgDisplay = document.getElementById("my-org-display");
            
            // 1. æŸ¥æ˜¯ä¸æ˜¯ Root Owner
            const owner = await cID.owner();
            if(owner.toLowerCase() === myAddr.toLowerCase()) {
                statusBadge.innerHTML = `<i class="fas fa-crown text-warning"></i> Root Admin`;
                roleDisplay.innerText = "è¶…çº§ç®¡ç†å‘˜ (Root)";
                orgDisplay.innerText = "System Owner";
                // æ˜¾ç¤ºæ‰€æœ‰ç®¡ç†èœå•
                document.querySelectorAll(".admin-only, .root-only").forEach(e => e.style.display="block");
                return;
            }

            // 2. æŸ¥æ˜¯ä¸æ˜¯ Admin (å±äºæŸä¸ªæœºæ„)
            const orgAddr = await cID.getAdminOrg(myAddr);
            if(orgAddr !== "0x0000000000000000000000000000000000000000") {
                // å†æŸ¥æœºæ„åå­—
                const orgInfo = await cID.issuers(orgAddr);
                statusBadge.innerHTML = `<i class="fas fa-user-shield text-primary"></i> Admin`;
                roleDisplay.innerText = "æœºæ„ç®¡ç†å‘˜ (Admin)";
                orgDisplay.innerText = "æ‰€å±: " + orgInfo.name;
                // æ˜¾ç¤º Admin èœå•ï¼Œéšè— Root èœå•
                document.querySelectorAll(".admin-only").forEach(e => e.style.display="block");
                document.querySelectorAll(".root-only").forEach(e => e.style.display="none");
                return;
            }

            // 3. æ™®é€šç”¨æˆ·
            const id = await cID.identities(myAddr);
            if(id.isValid) {
                statusBadge.innerHTML = `<i class="fas fa-user text-success"></i> åˆè§„ç”¨æˆ·`;
                roleDisplay.innerText = id.role;
                orgDisplay.innerText = "Region: " + id.region;
            } else {
                statusBadge.innerHTML = `æ¸¸å®¢ / æ— èº«ä»½`;
                roleDisplay.innerText = "æœªè®¤è¯";
                orgDisplay.innerText = "-";
            }
            // éšè—æ‰€æœ‰ç®¡ç†èœå•
            document.querySelectorAll(".admin-only, .root-only").forEach(e => e.style.display="none");
        }

        async function ensureSigner() {
            if(signer) return true;
            await connectWallet();
            return !!signer;
        }

        async function tx(p, msg) {
            if(!await ensureSigner()) return;
            try {
                Swal.fire({title:'ç¡®è®¤...', didOpen:()=>Swal.showLoading()});
                const t = await p;
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
                await t.wait();
                Swal.fire("æˆåŠŸ", msg, "success");
                refreshAll();
            } catch(e) { Swal.fire("Error", e.reason||e.message, "error"); }
        }

        function refreshAll() { loadAssets(); if(signer) { loadUserData(); loadProposals(); loadIssuerList(); loadLogs(); } }

        // --- æ•°æ®åŠ è½½ ---
        async function loadAssets() {
            const g=document.getElementById("market-grid"), t=document.getElementById("admin-table");
            if(!cMKT) return; g.innerHTML=""; t.innerHTML="";
            const c = await cMKT.assetCount();
            for(let i=1; i<=c; i++) {
                const a = await cMKT.assets(i);
                if(a.isActive) g.innerHTML+=`<div class="col-md-3 mb-3"><div class="asset-card"><div class="asset-img">${a.name.substring(0,2)}</div><div class="p-3"><h6>${a.name}</h6><div class="d-flex justify-content-between mt-2"><b class="text-primary">${a.price} HKC</b><button onclick="buy(${i})" class="btn btn-sm btn-primary">Buy</button></div></div></div></div>`;
                t.innerHTML+=`<tr><td>${i}</td><td>${a.name}</td><td>${a.isActive?'âœ…':'âŒ'}</td><td><button onclick="toggle(${i},${!a.isActive})" class="btn btn-sm btn-light border">Toggle</button></td></tr>`;
            }
        }

        async function loadUserData() {
            if(!signer) return;
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];
            
            const g = document.getElementById("inventory-grid"); g.innerHTML="";
            const c = await cMKT.assetCount();
            let has=false;
            for(let i=1; i<=c; i++) {
                const b = await cMKT.userBalances(myAddr, i);
                if(b.gt(0)) {
                    has=true; const a = await cMKT.assets(i);
                    g.innerHTML+=`<div class="col-md-3"><div class="asset-card border-success"><div class="p-3 text-center"><h6>${a.name}</h6><span class="badge bg-success mb-2">x${b}</span><button onclick="sell(${i},'${a.name}',${a.price})" class="btn btn-danger btn-sm w-100">å–å‡ºå˜ç°</button></div></div></div>`;
                }
            }
            if(!has) g.innerHTML="<div class='text-center text-muted w-100 py-5'>æš‚æ— èµ„äº§</div>";
        }

        async function loadProposals() {
            const t = document.getElementById("proposal-table"); t.innerHTML="";
            try {
                const c = await cID.proposalCount();
                for(let i=c; i>Math.max(0,c-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) t.innerHTML+=`<tr><td>#${p.id}</td><td>${p.targetUser.slice(0,6)}...</td><td>${p.role}</td><td><button onclick="approveID(${p.id})" class="btn btn-success btn-sm">æ‰¹å‡†</button></td></tr>`;
                }
            } catch(e){}
        }
        
        async function loadIssuerList() {
            const t = document.getElementById("issuer-list-tbody"); t.innerHTML="";
            try {
                const l = await cID.getAllIssuers();
                for(let a of l) { const i = await cID.issuers(a); if(i.name) t.innerHTML+=`<tr><td>${i.name}</td><td>${a.slice(0,6)}...</td><td>${i.isActive?'Active':'Revoked'}</td></tr>`; }
            } catch(e){}
        }

        async function loadLogs() {
            const t=document.getElementById("logs-table"); t.innerHTML="";
            const l=await cMKT.queryFilter("TradeExecuted", -5000);
            for(let i=l.length-1; i>=0; i--) {
                const e=l[i]; t.innerHTML+=`<tr><td>${e.args.type_}</td><td>${e.args.assetName}</td><td><a href="https://sepolia.etherscan.io/tx/${e.transactionHash}" target="_blank">View</a></td></tr>`;
            }
        }

        // Actions
        function approveHKC() { tx(cHKC.connect(signer).approve(ADDR_MARKET, ethers.constants.MaxUint256), "æˆæƒæˆåŠŸ"); }
        function buy(id) { tx(cMKT.connect(signer).buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
        function sell(id,n,p) { tx(cMKT.connect(signer).sellAsset(id), "å–å‡ºæˆåŠŸ"); }
        function addAsset() { tx(cMKT.connect(signer).addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, "", "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }
        function toggle(id,s) { tx(cMKT.connect(signer).setAssetStatus(id,s), "çŠ¶æ€æ›´æ–°"); }
        function govAdd() { tx(cID.connect(signer).addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value), "æˆæƒæˆåŠŸ"); }
        
        function proposeID() { 
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.connect(signer).proposeIdentity(u,r,role,365), "ææ¡ˆæäº¤");
        }
        async function approveID(id) {
            const p=await cID.getProposal(id);
            if(p.proposer.toLowerCase()===myAddr.toLowerCase()) return Swal.fire("æƒé™é™åˆ¶","ä¸èƒ½å®¡æ‰¹è‡ªå·±å‘èµ·çš„ææ¡ˆ","error");
            tx(cID.connect(signer).approveIdentity(id), "å®¡æ‰¹é€šè¿‡");
        }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
            if(signer) {
                if(p==='issuer') loadProposals();
                if(p==='gov') loadIssuerList();
                if(p==='logs') loadLogs();
            }
        }
    </script>
</body>
</html>
