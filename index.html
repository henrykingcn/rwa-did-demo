<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKUST RWA Platform V6</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --sidebar-width: 260px; --primary-color: #2c3e50; --accent-color: #3498db; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { height: 100vh; width: var(--sidebar-width); position: fixed; top: 0; left: 0; background: var(--primary-color); color: white; padding-top: 20px; z-index: 1000; transition: 0.3s; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 0.95rem; color: #bdc3c7; display: block; transition: 0.2s; cursor: pointer; border-left: 4px solid transparent; }
        .sidebar a:hover, .sidebar a.active { background: rgba(0,0,0,0.2); color: #fff; border-left-color: var(--accent-color); }
        .sidebar i { width: 25px; text-align: center; margin-right: 10px; }

        /* ä¸»å†…å®¹åŒº */
        .main-content { margin-left: var(--sidebar-width); padding: 20px; }
        .top-bar { background: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* å¡ç‰‡ä¸è¡¨æ ¼ */
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); background: white; margin-bottom: 20px; overflow: hidden; }
        .card-header-custom { background: white; padding: 20px; border-bottom: 1px solid #f1f1f1; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .table-custom th { background-color: #f8f9fa; font-weight: 600; color: #666; border-top: none; }
        .table-custom td { vertical-align: middle; }

        /* èµ„äº§å¡ç‰‡ */
        .asset-card { transition: 0.3s; border: none; border-radius: 15px; overflow: hidden; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); height: 100%; position: relative; }
        .asset-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .asset-img { height: 180px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: bold; position: relative; }
        .asset-badge { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; backdrop-filter: blur(5px); }

        /* çŠ¶æ€å¾½ç«  */
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-green { background-color: #2ecc71; }
        .dot-red { background-color: #e74c3c; }
        
        /* é¡µé¢åˆ‡æ¢ */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ä¸ªäººä¸­å¿ƒç»Ÿè®¡å¡ */
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .stat-num { font-size: 2.5rem; font-weight: bold; }
        .stat-label { opacity: 0.8; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <h4>ğŸ¦ RWA Lab V6</h4>
            <small class="text-muted" style="font-size:0.7rem">Built for HKUST Demo</small>
        </div>
        <a onclick="nav('market')" class="active" id="nav-market"><i class="fas fa-store"></i> èµ„äº§å¸‚åœº (Market)</a>
        <a onclick="nav('profile')" id="nav-profile"><i class="fas fa-user-circle"></i> ä¸ªäººä¸­å¿ƒ (Profile)</a>
        <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 20px;">
        <small style="padding: 0 25px; color: #666; font-weight:bold; text-transform:uppercase;">Management</small>
        <a onclick="nav('admin-assets')" id="nav-admin-assets"><i class="fas fa-box"></i> èµ„äº§ç®¡ç†</a>
        <a onclick="nav('admin-users')" id="nav-admin-users"><i class="fas fa-users-cog"></i> ç”¨æˆ·ä¸æœºæ„ç®¡ç†</a>
        <a onclick="nav('logs')" id="nav-logs"><i class="fas fa-history"></i> å…¨å±€å®¡è®¡æ—¥å¿—</a>
    </nav>

    <div class="main-content">
        
        <div class="top-bar">
            <div><h4 id="page-title" class="m-0 fw-bold">èµ„äº§äº¤æ˜“å¸‚åœº</h4></div>
            <div class="d-flex align-items-center gap-3">
                <div id="wallet-info-box" class="d-none align-items-center gap-2">
                    <span class="badge bg-light text-dark border"><i class="fas fa-coins text-warning"></i> <span id="hkc-bal">-</span> HKC</span>
                    <span class="badge bg-light text-dark border" id="id-status-badge">æ£€æŸ¥èº«ä»½...</span>
                </div>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary btn-sm shadow-sm"><i class="fas fa-wallet"></i> è¿æ¥é’±åŒ…</button>
                <span id="addr-display" class="text-muted small fw-bold"></span>
            </div>
        </div>

        <div id="view-market" class="view-section active">
            <div class="row" id="market-grid">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">æ­£åœ¨é€šè¿‡ RPC èŠ‚ç‚¹è¯»å–é“¾ä¸Šèµ„äº§...</p>
                </div>
            </div>
        </div>

        <div id="view-profile" class="view-section">
            <div id="profile-lock" class="text-center py-5">
                <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                <h5>è¯·è¿æ¥é’±åŒ…æŸ¥çœ‹ä¸ªäººèµ„äº§</h5>
                <button class="btn btn-primary mt-2" onclick="connectWallet()">ç«‹å³è¿æ¥</button>
            </div>

            <div id="profile-content" class="d-none">
                <div class="row">
                    <div class="col-md-8">
                        <div class="stat-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="stat-label">å½“å‰èº«ä»½ (Identity)</div>
                                    <div class="stat-num" style="font-size:1.8rem" id="my-role">Loading...</div>
                                    <div id="my-region" class="badge bg-white text-primary mt-2">Region: -</div>
                                    <div id="my-issuer" class="mt-2 small text-white-50">Issuer: -</div>
                                </div>
                                <i class="fas fa-id-card fa-4x text-white-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="stat-card" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
                            <div class="stat-label">æŒæœ‰èµ„äº§æ•°</div>
                            <div class="stat-num" id="my-asset-count">0</div>
                            <div class="mt-2 small text-white-50">å·²ç¡®æƒ RWA</div>
                         </div>
                    </div>
                </div>

                <h5 class="mb-3 mt-4 fw-bold"><i class="fas fa-box-open text-primary"></i> æˆ‘çš„èµ„äº§åº“ (Inventory)</h5>
                <div class="card-custom">
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead><tr><th>è´­ä¹°æ—¶é—´</th><th>èµ„äº§åç§°</th><th>æˆäº¤ä»·æ ¼</th><th>äº¤æ˜“å“ˆå¸Œ</th></tr></thead>
                            <tbody id="my-inventory-table">
                                <tr><td colspan="4" class="text-center text-muted py-4">æš‚æ— è´­ä¹°è®°å½•</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin-assets" class="view-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="card-custom p-3">
                        <h5 class="mb-3">ä¸Šæ¶æ–°èµ„äº§</h5>
                        <input type="text" class="form-control mb-2" id="newAssetName" placeholder="èµ„äº§åç§°">
                        <input type="number" class="form-control mb-2" id="newAssetPrice" placeholder="ä»·æ ¼ (HKC)">
                        <select class="form-select mb-2" id="newAssetRegion">
                            <option value="">ğŸŒ å…¨çƒ (Global)</option>
                            <option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯ (HK Only)</option>
                            <option value="US">ğŸ‡ºğŸ‡¸ ç¾å›½ (US Only)</option>
                        </select>
                        <button class="btn btn-success w-100" onclick="addAsset()">ä¸Šæ¶</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-custom">
                        <div class="table-responsive">
                            <table class="table table-custom mb-0">
                                <thead><tr><th>ID</th><th>åç§°</th><th>ä»·æ ¼</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="admin-asset-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin-users" class="view-section">
            
            <div class="card-custom p-3 bg-light border">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="small fw-bold text-muted">ç”¨æˆ·åœ°å€</label>
                        <input type="text" class="form-control form-control-sm" id="targetUser" placeholder="0x...">
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted">åœ°åŒº</label>
                        <select class="form-select form-select-sm" id="targetRegion"><option value="HK">HK</option><option value="CN">CN</option><option value="US">US</option></select>
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted">è§’è‰²</label>
                        <select class="form-select form-select-sm" id="targetRole"><option value="Student">Student</option><option value="Investor">Investor</option></select>
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted">å‘è¯æœºæ„</label>
                        <select class="form-select form-select-sm" id="targetType"><option value="user">å‘ç»™ç”¨æˆ·</option><option value="issuer">è®¾ä¸ºæœºæ„</option></select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-warning btn-sm w-100 fw-bold text-white" onclick="issueAction()">æ‰§è¡Œé¢å‘</button>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <span>ğŸ›ï¸ æœºæ„åå• (Issuers)</span>
                            <button class="btn btn-xs btn-outline-secondary" onclick="refreshAdminData()"><i class="fas fa-sync"></i></button>
                        </div>
                        <table class="table table-custom mb-0 table-sm" style="font-size:0.9rem">
                            <thead><tr><th>åç§°</th><th>åœ°å€</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="issuer-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <span>ğŸ‘¥ å·²å‘è¯ç”¨æˆ· (All Users)</span>
                            <small class="text-muted">åŸºäºé“¾ä¸Šæ—¥å¿—</small>
                        </div>
                        <table class="table table-custom mb-0 table-sm" style="font-size:0.9rem">
                            <thead><tr><th>åœ°å€</th><th>åœ°åŒº/è§’è‰²</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="user-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-logs" class="view-section">
            <ul class="nav nav-tabs mb-3" id="logTabs">
                <li class="nav-item"><a class="nav-link active" onclick="switchLogTab('trade')">RWA äº¤æ˜“è®°å½•</a></li>
                <li class="nav-item"><a class="nav-link" onclick="switchLogTab('identity')">èº«ä»½/åŠé”€è®°å½•</a></li>
            </ul>

            <div class="card-custom">
                <div class="table-responsive">
                    <table class="table table-striped mb-0" id="log-table">
                        </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // âš ï¸ é…ç½®åŒºï¼šè¯·å¡«å…¥ä½ çš„ V4/V5 åˆçº¦åœ°å€ (ä¸ç”¨é‡æ–°éƒ¨ç½²ï¼Œåœ°å€é€šç”¨çš„)
        // =================================================================
        const ADDR_HKC      = "0xB0B8c886C6e8469C43bB309452a7f3C911681453";
        const ADDR_ID       = "0xA69098Bc7077cB3011D8E6d670A858669Ac3a034";
        const ADDR_MARKET   = "0x1ae6c3DE25A0aDBF01a600E1F960321567020a12";
        // ğŸ“¢ è¿™é‡Œå¡«ä¸€ä¸ª Sepolia çš„å…¬å…±èŠ‚ç‚¹ï¼Œå®ç°å…é’±åŒ…æµè§ˆ
        const RPC_URL       = "https://rpc.sepolia.org"; // æˆ–è€… https://1rpc.io/sepolia
        // =================================================================

        // ABI å®šä¹‰
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function setAssetStatus(uint256, bool) external", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "event TradeExecuted(address indexed user, uint256 assetId, string assetName, uint256 price, uint256 timestamp)"];
        const ABI_ID = ["function addIssuer(address,string) external", "function revokeIssuer(address) external", "function issueIdentity(address,string,string,uint256) external", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "event IssuerAdded(address indexed issuer, string name)", "event IssuerRevoked(address indexed issuer)", "event IdentityIssued(address indexed user, address indexed issuer, string region)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let provider, signer, myAddr;
        let cID, cMKT, cHKC; // åˆçº¦å®ä¾‹ (å¯èƒ½æ˜¯åªè¯»ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯å†™)

        // åˆå§‹åŒ–ï¼šé»˜è®¤ä½¿ç”¨ RPC åªè¯»è¿æ¥
        window.onload = async () => {
            // 1. å…ˆå°è¯•å»ºç«‹åªè¯»è¿æ¥
            try {
                const readProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
                initContracts(readProvider);
                console.log("Read-only provider connected");
                loadMarketAssets(); // åŠ è½½å¸‚åœº (ä¸éœ€è¦é’±åŒ…)
            } catch(e) { console.error("RPC Connection failed", e); }
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        // è¿æ¥é’±åŒ… (å‡çº§ä¸º Signer)
        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("Error", "No MetaMask found", "error");
            const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
            await web3Provider.send("eth_requestAccounts", []);
            signer = web3Provider.getSigner();
            myAddr = await signer.getAddress();

            // é‡æ–°åˆå§‹åŒ–åˆçº¦ (å¸¦ Signerï¼Œå¯å†™)
            initContracts(signer);
            
            // UI æ›´æ–°
            document.getElementById("btn-conn").style.display = "none";
            document.getElementById("wallet-info-box").classList.remove("d-none");
            document.getElementById("wallet-info-box").classList.add("d-flex");
            document.getElementById("addr-display").innerText = myAddr.slice(0,6) + "...";

            // åŠ è½½ä¸ªäººæ•°æ®
            loadUserData();
            refreshUI();
        }

        // ------------------ æ•°æ®åŠ è½½é€»è¾‘ ------------------

        async function loadMarketAssets() {
            const grid = document.getElementById("market-grid");
            const table = document.getElementById("admin-asset-table");
            grid.innerHTML = ""; table.innerHTML = "";

            try {
                const count = await cMKT.assetCount();
                if(count.toNumber() === 0) {
                    grid.innerHTML = "<div class='text-center py-5 text-muted'>æš‚æ— ä¸Šæ¶èµ„äº§</div>";
                    return;
                }

                for(let i=1; i<=count; i++) {
                    const a = await cMKT.assets(i);
                    
                    // Market View (åªæ˜¾ç¤º Active)
                    if(a.isActive) {
                        const hue = (i * 137) % 360;
                        grid.innerHTML += `
                        <div class="col-md-4 col-lg-3 mb-4">
                            <div class="asset-card">
                                <div class="asset-img" style="background: linear-gradient(45deg, hsl(${hue}, 70%, 60%), hsl(${hue+60}, 70%, 60%))">
                                    ${a.name.substring(0,2).toUpperCase()}
                                    <span class="asset-badge">${a.requiredRegion || 'GLOBAL'}</span>
                                </div>
                                <div class="p-3">
                                    <h5 class="text-truncate fw-bold">${a.name}</h5>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="text-primary fw-bold fs-5">${a.price} HKC</span>
                                        <button class="btn btn-primary btn-sm px-3" onclick="buyAsset(${i})">Buy</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }

                    // Admin View (æ˜¾ç¤ºå…¨éƒ¨)
                    table.innerHTML += `<tr><td>${i}</td><td>${a.name}</td><td>${a.price}</td>
                        <td>${a.isActive?'<span class="text-success">ä¸Šæ¶</span>':'<span class="text-danger">ä¸‹æ¶</span>'}</td>
                        <td><button class="btn btn-sm btn-outline-dark" onclick="toggleAsset(${i},${!a.isActive})">${a.isActive?'ä¸‹æ¶':'ä¸Šæ¶'}</button></td></tr>`;
                }
            } catch(e) { console.error(e); grid.innerHTML = "<div class='text-center py-5 text-danger'>RPCè¿æ¥æ…¢ï¼Œè¯·å°è¯•è¿æ¥é’±åŒ…åŠ è½½</div>"; }
        }

        async function loadUserData() {
            // 1. ä½™é¢
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];

            // 2. èº«ä»½çŠ¶æ€
            const id = await cID.identities(myAddr);
            const badge = document.getElementById("id-status-badge");
            const profileLock = document.getElementById("profile-lock");
            const profileContent = document.getElementById("profile-content");

            if(id.isValid && Date.now()/1000 < id.expiry) {
                badge.className = "badge bg-success"; badge.innerHTML = `âœ” ${id.region} ${id.role}`;
                document.getElementById("my-role").innerText = id.role;
                document.getElementById("my-region").innerText = "Region: " + id.region;
                document.getElementById("my-issuer").innerText = "Issuer: " + id.issuedBy.slice(0,10)+"...";
            } else {
                badge.className = "badge bg-danger"; badge.innerHTML = `âŒ æ— æ•ˆèº«ä»½`;
                document.getElementById("my-role").innerText = "No Identity";
            }

            // è§£é”ä¸ªäººä¸­å¿ƒ
            profileLock.classList.add('d-none');
            profileContent.classList.remove('d-none');

            // 3. åŠ è½½æˆ‘çš„ Inventory (é€šè¿‡ Logs)
            loadMyInventory();
        }

        async function loadMyInventory() {
            // è¿‡æ»¤ï¼šæˆ‘å‘èµ·çš„ TradeExecuted
            const filter = cMKT.filters.TradeExecuted(myAddr, null);
            const logs = await cMKT.queryFilter(filter); // ä»åˆ›ä¸–åŒºå—æŸ¥èµ·
            
            const table = document.getElementById("my-inventory-table");
            document.getElementById("my-asset-count").innerText = logs.length;
            
            if(logs.length > 0) table.innerHTML = "";
            
            // å€’åºæ˜¾ç¤º
            for(let i=logs.length-1; i>=0; i--) {
                const log = logs[i];
                const date = new Date(log.args.timestamp * 1000).toLocaleString();
                table.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td class="fw-bold">${log.args.assetName}</td>
                        <td>${log.args.price} HKC</td>
                        <td><a href="https://sepolia.etherscan.io/tx/${log.transactionHash}" target="_blank" class="text-decoration-none">View â†—</a></td>
                    </tr>
                `;
            }
        }

        // ğŸ”¥ Admin æ•°æ®åŠ è½½ (V6 æ ¸å¿ƒï¼šäº‹ä»¶ç´¢å¼•é‡å»ºç”¨æˆ·è¡¨)
        async function refreshAdminData() {
            if(!signer) return;
            
            // 1. åŠ è½½æœºæ„ (ä»åˆçº¦æ•°ç»„)
            const issuerTbody = document.getElementById("issuer-list-tbody");
            issuerTbody.innerHTML = "";
            try {
                const list = await cID.getAllIssuers();
                for(let addr of list) {
                    const info = await cID.issuers(addr);
                    if(info.name) {
                        issuerTbody.innerHTML += `
                            <tr>
                                <td>${info.name}</td>
                                <td class="small text-muted">${addr.slice(0,8)}...</td>
                                <td>${info.isActive?'<span class="badge bg-success">Active</span>':'<span class="badge bg-danger">Revoked</span>'}</td>
                                <td><button class="btn btn-xs btn-outline-danger" onclick="revokeIssuer('${addr}')">åŠé”€</button></td>
                            </tr>`;
                    }
                }
            } catch(e){}

            // 2. åŠ è½½ç”¨æˆ· (ä»æ—¥å¿—é‡å»º)
            const userTbody = document.getElementById("user-list-tbody");
            userTbody.innerHTML = "<tr><td colspan='4' class='text-center'>æ­£åœ¨ä»åŒºå—é“¾ç´¢å¼•æ•°æ®...</td></tr>";
            
            // æŠ“å–æ‰€æœ‰ 'IdentityIssued' äº‹ä»¶
            const logs = await cID.queryFilter("IdentityIssued");
            const userMap = new Map(); // å»é‡

            // åªä¿ç•™æ¯ä¸ªç”¨æˆ·æœ€æ–°çš„è®°å½•
            for(let log of logs) {
                userMap.set(log.args.user, { 
                    region: log.args.region,
                    block: log.blockNumber
                });
            }

            userTbody.innerHTML = "";
            for(let [addr, data] of userMap) {
                // æ£€æŸ¥å½“å‰æ˜¯å¦è¿˜æœ‰æ•ˆ
                const info = await cID.identities(addr);
                const isExpired = Date.now()/1000 > info.expiry;
                const statusHtml = (info.isValid && !isExpired) 
                    ? '<span class="badge bg-success">æœ‰æ•ˆ</span>' 
                    : '<span class="badge bg-secondary">å·²è¿‡æœŸ/åŠé”€</span>';

                userTbody.innerHTML += `
                    <tr>
                        <td class="small">${addr.slice(0,10)}...</td>
                        <td class="small">${data.region} / ${info.role}</td>
                        <td>${statusHtml}</td>
                        <td>
                            ${(info.isValid && !isExpired) ? `<button class="btn btn-xs btn-outline-danger" onclick="revokeUser('${addr}')">åŠé”€</button>` : '-'}
                        </td>
                    </tr>
                `;
            }
        }

        // å…¨å±€æ—¥å¿—
        async function loadGlobalLogs() {
            const table = document.getElementById("log-table");
            table.innerHTML = "<tr><td colspan='5' class='text-center'>åŠ è½½ä¸­...</td></tr>";
            
            // æ··åˆä¸¤ç§æ—¥å¿—ï¼šäº¤æ˜“ + èº«ä»½
            const logs1 = await cMKT.queryFilter("TradeExecuted");
            const logs2 = await cID.queryFilter("IdentityIssued");
            const logs3 = await cID.queryFilter("IssuerRevoked");
            
            // ç®€å•åˆå¹¶å±•ç¤º
            let all = [];
            logs1.forEach(l => all.push({type:'TRADE', ...l}));
            logs2.forEach(l => all.push({type:'ISSUE', ...l}));
            logs3.forEach(l => all.push({type:'REVOKE', ...l}));
            
            // æŒ‰åŒºå—æ’åº
            all.sort((a,b) => b.blockNumber - a.blockNumber);

            table.innerHTML = "<thead><tr><th>ç±»å‹</th><th>è¯¦æƒ…</th><th>Hash</th></tr></thead><tbody>";
            all.slice(0, 50).forEach(l => { // åªæ˜¾ç¤ºæœ€è¿‘50æ¡
                let badge = "", content = "";
                if(l.type === 'TRADE') { badge="<span class='badge bg-primary'>Trade</span>"; content = `ç”¨æˆ· ${l.args.user.slice(0,6)} è´­ä¹°äº† ${l.args.assetName}`; }
                if(l.type === 'ISSUE') { badge="<span class='badge bg-success'>Issue</span>"; content = `å‘è¯ç»™ ${l.args.user.slice(0,6)} (${l.args.region})`; }
                if(l.type === 'REVOKE') { badge="<span class='badge bg-danger'>Revoke</span>"; content = `åŠé”€æœºæ„ ${l.args.issuer.slice(0,6)}`; }
                
                table.innerHTML += `<tr><td>${badge}</td><td>${content}</td><td><a href="https://sepolia.etherscan.io/tx/${l.transactionHash}" target="_blank">View</a></td></tr></tbody>`;
            });
        }


        // ------------------ äº¤äº’æ“ä½œ ------------------
        
        async function tx(promise) {
            if(!signer) return Swal.fire("è¯·è¿æ¥é’±åŒ…");
            try {
                Swal.fire({title:'ç­‰å¾…ç¡®è®¤...', didOpen:()=>Swal.showLoading()});
                const t = await promise;
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
                await t.wait();
                Swal.fire("æˆåŠŸ", "æ“ä½œå®Œæˆ", "success");
                refreshUI(); // æ“ä½œå®Œè‡ªåŠ¨åˆ·æ–°æ‰€æœ‰æ•°æ®
            } catch(e) { Swal.fire("Error", e.reason||e.message, "error"); }
        }

        function buyAsset(id) { tx(cMKT.buyAsset(id)); }
        function approveHKC() { tx(cHKC.approve(ADDR_MARKET, ethers.constants.MaxUint256)); }
        function addAsset() { tx(cMKT.addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, document.getElementById("newAssetRegion").value, "0x0000000000000000000000000000000000000000")); }
        function toggleAsset(id, s) { tx(cMKT.setAssetStatus(id, s)); }
        
        // é¢å‘èº«ä»½ (æˆ–æ·»åŠ æœºæ„)
        function issueAction() {
            const u = document.getElementById("targetUser").value;
            const r = document.getElementById("targetRegion").value;
            const role = document.getElementById("targetRole").value;
            const type = document.getElementById("targetType").value;
            
            if(type === 'user') tx(cID.issueIdentity(u, r, role, 365)); // å‘ç»™ç”¨æˆ·ï¼Œæœ‰æ•ˆæœŸ1å¹´
            else tx(cID.addIssuer(u, role + " Org")); // æ·»åŠ ä¸ºæœºæ„
        }

        function revokeIssuer(addr) { tx(cID.revokeIssuer(addr)); }
        
        // åŠé”€ç”¨æˆ· (æŠ€å·§ï¼šé‡æ–°å‘ä¸€ä¸ªæœ‰æ•ˆæœŸä¸º 0 çš„è¯ = ç«‹å³è¿‡æœŸ)
        function revokeUser(addr) { 
            Swal.fire({title:'ç¡®å®šåŠé”€è¯¥ç”¨æˆ·?', text:'å°†é€šè¿‡è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º0æ¥å®ç°', showCancelButton:true})
            .then(res => {
                if(res.isConfirmed) tx(cID.issueIdentity(addr, "REVOKED", "Banned", 0)); 
            });
        }

        // ------------------ è·¯ç”± ------------------
        function nav(page) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+page).classList.add('active');
            document.querySelectorAll('.sidebar a').forEach(e => e.classList.remove('active'));
            document.getElementById('nav-'+page).classList.add('active');
            
            const map = {'market':'èµ„äº§å¸‚åœº','profile':'ä¸ªäººä¸­å¿ƒ','admin-assets':'èµ„äº§åå°','admin-users':'ç”¨æˆ·ä¸æœºæ„ç®¡ç†','logs':'å®¡è®¡æ—¥å¿—'};
            document.getElementById('page-title').innerText = map[page];

            // æ‡’åŠ è½½æ•°æ®
            if(signer) {
                if(page === 'admin-users') refreshAdminData();
                if(page === 'logs') loadGlobalLogs();
                if(page === 'profile') loadUserData();
            }
        }
        
        function refreshUI() {
            loadMarketAssets();
            if(signer) loadUserData();
        }

    </script>
</body>
</html>
