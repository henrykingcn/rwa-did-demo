<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKUST RWA/DID ç»ˆææ§åˆ¶å°</title>
    <!-- å¼•å…¥ Bootstrap 5 (å¸ƒå±€) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome (å›¾æ ‡) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ Google Fonts (å­—ä½“) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- å¼•å…¥ SweetAlert2 (å¼¹çª—) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6; /* ç§‘æŠ€è“ */
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --sidebar-width: 260px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* ç»ç’ƒæ‹Ÿæ€ä¾§è¾¹æ  */
        .sidebar {
            height: 100vh;
            width: var(--sidebar-width);
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding-top: 20px;
            z-index: 1000;
            transition: 0.3s;
        }

        .sidebar-brand {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
        }
        
        .sidebar-brand h4 {
            font-weight: 700;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        .nav-link {
            padding: 12px 25px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
            border-left-color: var(--accent-color);
        }

        .nav-link i {
            width: 24px;
            margin-right: 10px;
            text-align: center;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .top-bar {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card-custom {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-title { font-size: 1.1rem; font-weight: 600; margin: 0; }

        /* NFT èµ„äº§å¡ç‰‡ */
        .asset-card {
            background: #263345;
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-color);
        }

        .asset-img {
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 800;
            color: rgba(255,255,255,0.9);
            position: relative;
        }

        .region-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .asset-body { padding: 20px; }
        
        .price-tag {
            color: var(--accent-color);
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-primary-custom {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            border: none;
            color: white;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 8px;
            transition: 0.2s;
        }
        .btn-primary-custom:hover {
            background: linear-gradient(45deg, #2563eb, #1d4ed8);
            transform: scale(1.02);
        }

        .btn-danger-custom {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            border: none;
            color: white;
            border-radius: 8px;
        }

        /* è¡¨å•æ§ä»¶æš—è‰²æ¨¡å¼ */
        .form-control, .form-select {
            background-color: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .form-control:focus, .form-select:focus {
            background-color: #0f172a;
            border-color: var(--accent-color);
            color: white;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
        }

        /* çŠ¶æ€æŒ‡ç¤º */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .bg-success-glow { background-color: #10b981; box-shadow: 0 0 10px #10b981; }
        .bg-danger-glow { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }

        /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼æ ·å¼ */
        .table-dark-custom {
            color: var(--text-secondary);
            margin-bottom: 0;
        }
        .table-dark-custom th {
            background-color: rgba(255,255,255,0.02);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
            color: var(--text-primary);
        }
        .table-dark-custom td {
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }
    </style>
</head>
<body>

    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar">
        <div class="sidebar-brand">
            <h4>ğŸ¦ RWA LAB <span style="font-size:0.6em; color:var(--text-secondary); display:block; margin-top:5px; font-weight:400">V9 Ultimate</span></h4>
        </div>
        
        <div class="nav flex-column">
            <a onclick="nav('market')" class="nav-link active" id="nav-market">
                <i class="fas fa-globe"></i> äº¤æ˜“å¸‚åœº (Market)
            </a>
            <a onclick="nav('profile')" class="nav-link" id="nav-profile">
                <i class="fas fa-wallet"></i> æˆ‘çš„èµ„äº§ (Sell)
            </a>
            <a onclick="nav('issuer')" class="nav-link" id="nav-issuer">
                <i class="fas fa-signature"></i> å¤šç­¾å‘è¯ (Multi-Sig)
            </a>
            
            <div style="margin: 20px 25px; border-top: 1px solid rgba(255,255,255,0.1);"></div>
            <small style="padding: 0 25px; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block;">Admin Zone</small>
            
            <a onclick="nav('admin')" class="nav-link" id="nav-admin">
                <i class="fas fa-layer-group"></i> èµ„äº§ç®¡ç†
            </a>
            <a onclick="nav('gov')" class="nav-link" id="nav-gov">
                <i class="fas fa-university"></i> ç›‘ç®¡æœºæ„
            </a>
            <a onclick="nav('logs')" class="nav-link" id="nav-logs">
                <i class="fas fa-list-ul"></i> å®¡è®¡æ—¥å¿—
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="top-bar">
            <div>
                <h4 id="page-title" class="m-0" style="font-weight: 700;">èµ„äº§äº¤æ˜“å¸‚åœº</h4>
                <small class="text-muted" id="network-status"><i class="fas fa-circle text-success small me-1"></i> RPC èŠ‚ç‚¹æ­£å¸¸</small>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <!-- èº«ä»½å¾½ç«  (è¿é’±åŒ…åæ˜¾ç¤º) -->
                <div id="id-badge" class="d-none px-3 py-2 rounded-3 bg-opacity-10" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                    <span id="id-text" class="small fw-bold">æ£€æŸ¥ä¸­...</span>
                </div>

                <!-- ä½™é¢ -->
                <div class="px-3 py-2 rounded-3" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); color: #3b82f6;">
                    <i class="fas fa-coins me-2"></i><span id="hkc-bal" class="fw-bold">-</span> HKC
                </div>

                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary-custom shadow-sm">
                    <i class="fas fa-link me-2"></i> è¿æ¥é’±åŒ…
                </button>
                <span id="wallet-addr" class="text-muted small fw-bold font-monospace d-none"></span>
            </div>
        </div>

        <!-- ==================== 1. å¸‚åœº (Market) ==================== -->
        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <p class="text-muted m-0">æµè§ˆå…¨çƒåˆè§„ RWA èµ„äº§ã€‚è´­ä¹°å‰è¯·ç¡®ä¿å·²é€šè¿‡ KYCã€‚</p>
                <button class="btn btn-outline-light btn-sm" onclick="approveHKC()">
                    <i class="fas fa-key me-2"></i> èµ„é‡‘æˆæƒ (Approve)
                </button>
            </div>

            <div class="row" id="market-grid">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-3">æ­£åœ¨é€šè¿‡å»ä¸­å¿ƒåŒ–èŠ‚ç‚¹åŠ è½½èµ„äº§...</p>
                </div>
            </div>
        </div>

        <!-- ==================== 2. ä¸ªäººä¸­å¿ƒ (Profile & Sell) ==================== -->
        <div id="view-profile" class="view-section">
            <!-- èº«ä»½å¡ç‰‡ -->
            <div class="card-custom" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border:none;">
                <div class="d-flex justify-content-between align-items-center text-white">
                    <div>
                        <h6 class="opacity-75 mb-2">å½“å‰æ•°å­—èº«ä»½ (DID)</h6>
                        <h2 class="fw-bold mb-1" id="profile-role">æœªè¿æ¥</h2>
                        <div class="d-flex gap-2 mt-3">
                            <span class="badge bg-white bg-opacity-25 border border-white border-opacity-25" id="profile-region">Region: -</span>
                            <span class="badge bg-white bg-opacity-25 border border-white border-opacity-25" id="profile-issuer">Issuer: -</span>
                        </div>
                    </div>
                    <div class="d-none d-md-block">
                        <i class="fas fa-id-card fa-6x opacity-25"></i>
                    </div>
                </div>
            </div>

            <h5 class="mb-3 mt-4 border-start border-4 border-primary ps-3">ğŸ“¦ æˆ‘çš„èµ„äº§åº“ (Inventory)</h5>
            <div class="row" id="inventory-grid">
                <div class="text-center text-muted py-5">æš‚æ— æŒä»“ï¼Œè¯·å‰å¾€å¸‚åœºè´­ä¹°</div>
            </div>
        </div>

        <!-- ==================== 3. å¤šç­¾å‘è¯ (Multi-Sig) ==================== -->
        <div id="view-issuer" class="view-section">
            <div class="row">
                <!-- å·¦ä¾§ï¼šå‘èµ· -->
                <div class="col-md-4">
                    <div class="card-custom border-top border-warning border-4">
                        <div class="card-header-custom">
                            <h5 class="card-title text-warning"><i class="fas fa-pen-nib me-2"></i> å‘èµ·ææ¡ˆ (Maker)</h5>
                        </div>
                        <div class="mb-3">
                            <label class="small text-muted mb-1">ç”¨æˆ·åœ°å€</label>
                            <input id="targetUser" class="form-control" placeholder="0x...">
                        </div>
                        <div class="mb-3">
                            <label class="small text-muted mb-1">åœ°åŒº</label>
                            <select id="targetRegion" class="form-select"><option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯ (HK)</option><option value="US">ğŸ‡ºğŸ‡¸ ç¾å›½ (US)</option><option value="CN">ğŸ‡¨ğŸ‡³ å†…åœ° (CN)</option></select>
                        </div>
                        <div class="mb-4">
                            <label class="small text-muted mb-1">è§’è‰²</label>
                            <select id="targetRole" class="form-select"><option value="Student">Student</option><option value="Investor">Investor</option></select>
                        </div>
                        <button onclick="proposeID()" class="btn btn-warning w-100 fw-bold text-dark">å‘èµ·ææ¡ˆ</button>
                    </div>
                </div>
                <!-- å³ä¾§ï¼šå®¡æ‰¹ -->
                <div class="col-md-8">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <h5 class="card-title">ğŸ“‹ å¾…å®¡æ‰¹åˆ—è¡¨ (Checker)</h5>
                            <button onclick="loadProposals()" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync"></i></button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark-custom">
                                <thead><tr><th>ID</th><th>ç›®æ ‡ç”¨æˆ·</th><th>è§’è‰²</th><th>å‘èµ·äºº</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="proposal-table"><tr><td colspan="5" class="text-center text-muted py-3">æš‚æ— å¾…åŠäº‹é¡¹</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== 4. èµ„äº§ç®¡ç† (Admin) ==================== -->
        <div id="view-admin" class="view-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="card-custom border-top border-success border-4">
                        <div class="card-header-custom"><h5 class="card-title text-success">ä¸Šæ¶æ–°èµ„äº§</h5></div>
                        <input id="newAssetName" class="form-control mb-2" placeholder="èµ„äº§åç§°">
                        <input id="newAssetPrice" type="number" class="form-control mb-2" placeholder="ä»·æ ¼ (HKC)">
                        <select id="newAssetRegion" class="form-select mb-3"><option value="">ğŸŒ å…¨çƒ</option><option value="HK">ğŸ‡­ğŸ‡° HK Only</option><option value="US">ğŸ‡ºğŸ‡¸ US Only</option></select>
                        <button onclick="addAsset()" class="btn btn-success w-100 fw-bold">ä¸Šæ¶</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-custom">
                        <div class="card-header-custom"><h5 class="card-title">ç°å­˜èµ„äº§åˆ—è¡¨</h5></div>
                        <table class="table table-dark-custom">
                            <thead><tr><th>ID</th><th>åç§°</th><th>ä»·æ ¼</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="admin-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== 5. ç›‘ç®¡ (Gov) & æ—¥å¿— ==================== -->
        <div id="view-gov" class="view-section">
            <div class="row">
                <div class="col-md-5">
                    <div class="card-custom border-top border-danger border-4">
                        <h5 class="card-title text-danger mb-3">æœºæ„æˆæƒ</h5>
                        <input id="issuerAddr" class="form-control mb-2" placeholder="æœºæ„åœ°å€ (0x...)">
                        <input id="issuerName" class="form-control mb-3" placeholder="æœºæ„åç§°">
                        <div class="d-flex gap-2">
                            <button onclick="govAdd()" class="btn btn-danger flex-fill">æˆæƒ</button>
                            <button onclick="govRevoke()" class="btn btn-outline-light flex-fill">åŠé”€</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-custom">
                        <h5 class="card-title mb-3">å·²æˆæƒæœºæ„</h5>
                        <table class="table table-dark-custom table-sm">
                            <tbody id="issuer-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="view-logs" class="view-section">
            <div class="card-custom">
                <div class="card-header-custom"><h5 class="card-title">å…¨ç½‘å®¡è®¡æ—¥å¿—</h5></div>
                <table class="table table-dark-custom table-striped">
                    <thead><tr><th>ç±»å‹</th><th>æ‘˜è¦</th><th>Hash</th></tr></thead>
                    <tbody id="logs-table"><tr><td colspan="3" class="text-center text-muted">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- è„šæœ¬åŒº -->
    <script>
        // ==================== âš™ï¸ é…ç½®åŒº (å¡«å…¥ V7 åˆçº¦åœ°å€) ====================
        const ADDR_HKC      = "0xB0B8c886C6e8469C43bB309452a7f3C911681453";
        const ADDR_ID       = "0xA69098Bc7077cB3011D8E6d670A858669Ac3a034";
        const ADDR_MARKET   = "0x1ae6c3DE25A0aDBF01a600E1F960321567020a12";
        
        // ğŸš€ 3ä¸ªå¤‡ç”¨èŠ‚ç‚¹ï¼Œç¡®ä¿ 100% èƒ½è¿ä¸Š
        const RPC_NODES = [
            "https://ethereum-sepolia.publicnode.com",
            "https://sepolia.drpc.org",
            "https://rpc.sepolia.org"
        ];
        // ====================================================================

        // ABI (åŒ…å« V7 æ‰€æœ‰åŠŸèƒ½)
        const ABI_ID = ["function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)", "function issuers(address) view returns (bool isActive, string name)", "function getAllIssuers() view returns (address[])", "function addIssuer(address,string) external", "function revokeIssuer(address) external", "function checkCompliance(address,string,address) view returns (bool, string)", "event IssuerAdded(address,string)", "event IssuerRevoked(address)", "event IdentityIssued(address,address,string)"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)", "function setAssetStatus(uint256, bool) external", "event TradeExecuted(address,string,uint256,string,uint256,uint256)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC, provider;

        // åˆå§‹åŒ–ï¼šå°è¯•è¿æ¥ RPC
        window.onload = async () => {
            for(let url of RPC_NODES) {
                try {
                    provider = new ethers.providers.JsonRpcProvider(url);
                    await provider.getBlockNumber(); // æµ‹è¯•è¿æ¥
                    console.log("RPC Connected:", url);
                    initContracts(provider);
                    loadAssets(); // å…é’±åŒ…åŠ è½½
                    document.getElementById("network-status").innerHTML = `<i class="fas fa-circle text-success small me-1"></i> RPC åœ¨çº¿`;
                    break;
                } catch(e) { console.warn("Node failed:", url); }
            }
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("é”™è¯¯", "è¯·å®‰è£… MetaMask", "error");
            try {
                const p = new ethers.providers.Web3Provider(window.ethereum);
                await p.send("eth_requestAccounts", []);
                signer = p.getSigner();
                myAddr = await signer.getAddress();
                
                document.getElementById("btn-conn").classList.add("d-none");
                document.getElementById("wallet-addr").classList.remove("d-none");
                document.getElementById("wallet-addr").innerText = myAddr.slice(0,6)+"..."+myAddr.slice(-4);
                document.getElementById("id-badge").classList.remove("d-none");
                
                initContracts(signer);
                refreshAll();
            } catch(e) { console.error(e); }
        }

        function refreshAll() {
            loadAssets();
            loadUserData();
            if(document.getElementById("view-issuer").classList.contains("active")) loadProposals();
            if(document.getElementById("view-gov").classList.contains("active")) loadIssuerList();
            if(document.getElementById("view-logs").classList.contains("active")) loadLogs();
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        async function loadAssets() {
            const mGrid = document.getElementById("market-grid");
            const aTable = document.getElementById("admin-table");
            if(!cMKT) return;
            
            mGrid.innerHTML = ""; aTable.innerHTML = "";
            try {
                const count = await cMKT.assetCount();
                if(count.toNumber() === 0) mGrid.innerHTML = "<div class='text-center text-muted py-5'>æš‚æ— èµ„äº§</div>";

                for(let i=1; i<=count; i++) {
                    const a = await cMKT.assets(i);
                    
                    // Market Card
                    if(a.isActive) {
                        const hue = (i*137)%360;
                        mGrid.innerHTML += `
                        <div class="col-md-4 col-lg-3 mb-4">
                            <div class="asset-card">
                                <div class="asset-img" style="background:linear-gradient(135deg, hsl(${hue},60%,20%), hsl(${hue},70%,40%))">
                                    ${a.name.substring(0,2).toUpperCase()}
                                    <span class="region-badge">${a.requiredRegion || 'GLOBAL'}</span>
                                </div>
                                <div class="asset-body">
                                    <h5 class="fw-bold mb-1">${a.name}</h5>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="price-tag">${a.price} HKC</span>
                                        <button class="btn btn-sm btn-primary-custom" onclick="buy(${i})">è´­ä¹°</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                    // Admin Table
                    aTable.innerHTML += `<tr><td>${i}</td><td>${a.name}</td><td>${a.price} HKC</td><td>${a.isActive?'<span class="text-success">ä¸Šæ¶</span>':'<span class="text-danger">ä¸‹æ¶</span>'}</td><td><button class="btn btn-sm btn-outline-secondary" onclick="toggle(${i},${!a.isActive})">åˆ‡æ¢</button></td></tr>`;
                }
            } catch(e) { console.error(e); }
        }

        async function loadUserData() {
            if(!myAddr) return;
            
            // 1. ä½™é¢
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = ethers.utils.formatUnits(bal, 18).split('.')[0];

            // 2. èº«ä»½
            const id = await cID.identities(myAddr);
            if(id.isValid && Date.now()/1000 < id.expiry) {
                document.getElementById("profile-role").innerText = id.role;
                document.getElementById("profile-region").innerText = "Region: "+id.region;
                document.getElementById("profile-issuer").innerText = "By: "+id.issuedBy.slice(0,6)+"...";
                document.getElementById("id-text").innerHTML = `<span class="status-dot bg-success-glow"></span> ${id.region}/${id.role}`;
            } else {
                document.getElementById("profile-role").innerText = "æ— æœ‰æ•ˆèº«ä»½";
                document.getElementById("id-text").innerHTML = `<span class="status-dot bg-danger-glow"></span> æ— èº«ä»½`;
            }

            // 3. æŒä»“ (ç›´æ¥è¯» V6 è´¦æœ¬)
            const grid = document.getElementById("inventory-grid");
            grid.innerHTML = "";
            const count = await cMKT.assetCount();
            let has = false;
            for(let i=1; i<=count; i++) {
                const bal = await cMKT.userBalances(myAddr, i);
                if(bal.gt(0)) {
                    has = true;
                    const a = await cMKT.assets(i);
                    const hue = (i*137)%360;
                    grid.innerHTML += `
                    <div class="col-md-3 mb-4">
                        <div class="asset-card" style="border-color:var(--success-color)">
                            <div class="asset-img" style="height:120px; background:hsl(${hue},50%,20%)">
                                ${a.name.substring(0,2)}
                                <span class="badge bg-success position-absolute top-0 end-0 m-2">æŒæœ‰: ${bal}</span>
                            </div>
                            <div class="p-3 text-center">
                                <h6 class="mb-2">${a.name}</h6>
                                <button class="btn btn-sm btn-danger w-100" onclick="sell(${i}, '${a.name}', ${a.price})">å–å‡º (å˜ç°)</button>
                            </div>
                        </div>
                    </div>`;
                }
            }
            if(!has) grid.innerHTML = "<div class='text-center text-muted w-100 py-5'>æš‚æ— èµ„äº§</div>";
        }

        // --- Multi-Sig ---
        async function loadProposals() {
            const t = document.getElementById("proposal-table"); t.innerHTML = "";
            try {
                const c = await cID.proposalCount();
                let has = false;
                for(let i=c; i>Math.max(0, c-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) {
                        has = true;
                        t.innerHTML += `<tr><td>#${p.id}</td><td class="font-monospace small">${p.targetUser.slice(0,6)}...</td><td><span class="badge bg-info text-dark">${p.role}</span></td><td class="small">${p.proposer.slice(0,6)}...</td><td><button class="btn btn-sm btn-success" onclick="approveID(${p.id})">æ‰¹å‡†</button></td></tr>`;
                    }
                }
                if(!has) t.innerHTML = "<tr><td colspan='5' class='text-center text-muted py-3'>æ— å¾…åŠ</td></tr>";
            } catch(e){}
        }

        // --- Logs ---
        async function loadLogs() {
            const t = document.getElementById("logs-table");
            // ç®€å•å–æœ€è¿‘10æ¡äº¤æ˜“
            const logs = await cMKT.queryFilter("TradeExecuted", -10000); 
            let html = "";
            for(let i=logs.length-1; i>=0; i--) {
                const l = logs[i];
                const type = l.args.type_ === 'BUY' ? '<span class="badge bg-success">ä¹°å…¥</span>' : '<span class="badge bg-danger">å–å‡º</span>';
                html += `<tr><td>${type}</td><td>ç”¨æˆ· ${l.args.user.slice(0,6)} æ“ä½œäº† ${l.args.assetName}</td><td><a href="https://sepolia.etherscan.io/tx/${l.transactionHash}" target="_blank" class="text-decoration-none text-info">View</a></td></tr>`;
            }
            t.innerHTML = html;
        }

        // --- Actions ---
        async function tx(p, msg) {
            if(!signer) return Swal.fire("è¯·è¿æ¥é’±åŒ…");
            try {
                Swal.fire({title:'ç­‰å¾…ç¡®è®¤...', didOpen:()=>Swal.showLoading(), background:'#1e293b', color:'#fff'});
                const t = await p;
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading(), background:'#1e293b', color:'#fff'});
                await t.wait();
                Swal.fire({icon:'success', title:'æˆåŠŸ', text:msg, background:'#1e293b', color:'#fff'});
                refreshAll();
            } catch(e) { Swal.fire({icon:'error', title:'é”™è¯¯', text:e.reason||e.message, background:'#1e293b', color:'#fff'}); }
        }

        function approveHKC() { tx(cHKC.approve(ADDR_MARKET, ethers.constants.MaxUint256), "æˆæƒæˆåŠŸ"); }
        function buy(id) { tx(cMKT.buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
        function sell(id, n, p) { tx(cMKT.sellAsset(id), `æˆåŠŸå–å‡º ${n}ï¼Œè·å¾— ${p} HKC`); }
        function addAsset() { tx(cMKT.addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, document.getElementById("newAssetRegion").value, "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }
        function toggle(id, s) { tx(cMKT.setAssetStatus(id, s), "çŠ¶æ€æ›´æ–°"); }
        
        function govAdd() { tx(cID.addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value), "æˆæƒæˆåŠŸ"); }
        function govRevoke() { tx(cID.revokeIssuer(document.getElementById("issuerAddr").value), "åŠé”€æˆåŠŸ"); }
        
        function proposeID() {
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.proposeIdentity(u,r,role,365), "ææ¡ˆå·²æäº¤ï¼Œè¯·åˆ‡æ¢ç®¡ç†å‘˜å¤æ ¸");
        }
        async function approveID(id) {
            const p = await cID.getProposal(id);
            if(p.proposer.toLowerCase() === myAddr.toLowerCase()) return Swal.fire("æƒé™é”™è¯¯", "ä¸èƒ½å®¡æ‰¹è‡ªå·±å‘èµ·çš„ææ¡ˆ (Maker-CheckeråŸåˆ™)", "error");
            tx(cID.approveIdentity(id), "å®¡æ‰¹é€šè¿‡ï¼Œèº«ä»½å·²å‘æ”¾");
        }
        async function loadIssuerList() {
            const t = document.getElementById("issuer-list-tbody"); t.innerHTML = "";
            const l = await cID.getAllIssuers();
            for(let a of l) {
                const i = await cID.issuers(a);
                if(i.name) t.innerHTML += `<tr><td>${i.name}</td><td class="font-monospace text-muted">${a.slice(0,8)}...</td><td>${i.isActive?'<span class="text-success">â—</span>':'<span class="text-danger">â—</span>'}</td></tr>`;
            }
        }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
            if(signer) {
                if(p==='issuer') loadProposals();
                if(p==='gov') loadIssuerList();
                if(p==='logs') loadLogs();
                if(p==='profile') loadUserData();
            }
        }
    </script>
</body>
</html>
