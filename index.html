<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>HKUST RWA Platform V8 (All-In-One)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --sidebar-width: 260px; --primary-color: #2c3e50; --accent-color: #e67e22; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { height: 100vh; width: var(--sidebar-width); position: fixed; top: 0; left: 0; background: var(--primary-color); color: white; padding-top: 20px; z-index: 1000; transition: 0.3s; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 0.95rem; color: #bdc3c7; display: block; transition: 0.2s; cursor: pointer; border-left: 4px solid transparent; }
        .sidebar a:hover, .sidebar a.active { background: rgba(0,0,0,0.2); color: #fff; border-left-color: var(--accent-color); }
        .sidebar i { width: 25px; text-align: center; margin-right: 10px; }

        /* ä¸»å†…å®¹ */
        .main-content { margin-left: var(--sidebar-width); padding: 20px; }
        .top-bar { background: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ ·å¼ */
        .card-custom { border: none; border-radius: 12px; background: white; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .asset-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: 0.3s; }
        .asset-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .asset-img { height: 160px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: bold; position: relative; }
        .asset-badge { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; backdrop-filter: blur(4px); }
        
        .sell-btn { background: #e74c3c; color: white; border:none; width: 100%; padding: 8px; border-radius: 6px; margin-top: 10px; transition: 0.2s;}
        .sell-btn:hover { background: #c0392b; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <h4>ğŸ¦ RWA Lab V8</h4>
            <small class="text-muted" style="font-size:0.7rem">Full Features (Multi-Sig + Sell)</small>
        </div>
        <a onclick="nav('market')" class="active" id="nav-market"><i class="fas fa-store"></i> èµ„äº§å¸‚åœº (Market)</a>
        <a onclick="nav('profile')" id="nav-profile"><i class="fas fa-user-circle"></i> æˆ‘çš„èµ„äº§ (Sell)</a>
        <a onclick="nav('issuer')" id="nav-issuer"><i class="fas fa-file-signature"></i> å‘è¯ç®¡ç† (Multi-Sig)</a>
        <a onclick="nav('admin')" id="nav-admin"><i class="fas fa-cogs"></i> èµ„äº§ç®¡ç† (Admin)</a>
        <a onclick="nav('gov')" id="nav-gov"><i class="fas fa-landmark"></i> ç›‘ç®¡æœºæ„ (Gov)</a>
    </nav>

    <div class="main-content">
        
        <div class="top-bar">
            <div><h4 id="page-title" class="m-0 fw-bold">èµ„äº§äº¤æ˜“å¸‚åœº</h4></div>
            <div class="d-flex align-items-center gap-3">
                <span id="hkc-bal" class="badge bg-primary p-2">HKC: -</span>
                <span id="wallet-addr" class="text-muted small">æœªè¿æ¥</span>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary btn-sm shadow-sm">è¿æ¥é’±åŒ…</button>
            </div>
        </div>

        <div id="view-market" class="view-section active">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-dark btn-sm" onclick="approveHKC()"><i class="fas fa-key"></i> èµ„é‡‘æˆæƒ (Approve)</button>
            </div>
            <div class="row" id="market-grid">
                <div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="text-muted mt-2">æ­£åœ¨è¯»å–é“¾ä¸Šèµ„äº§...</p></div>
            </div>
        </div>

        <div id="view-profile" class="view-section">
            <div class="card-custom p-4 bg-primary text-white mb-4">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>å½“å‰èº«ä»½</h5>
                        <h2 id="my-role">Loading...</h2>
                        <span id="my-region" class="badge bg-white text-primary">Region: -</span>
                        <span id="my-issuer" class="small ms-2 opacity-75">Issuer: -</span>
                    </div>
                    <i class="fas fa-id-card fa-4x opacity-50"></i>
                </div>
            </div>

            <h5 class="mb-3"><i class="fas fa-box-open text-primary"></i> æˆ‘çš„æŒä»“ (Inventory)</h5>
            <div class="row" id="my-inventory-grid">
                <div class="text-center text-muted py-5">æš‚æ— æŒä»“</div>
            </div>
        </div>

        <div id="view-issuer" class="view-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="card-custom p-3 border-warning border-top border-4">
                        <h5 class="text-warning"><i class="fas fa-pen-nib"></i> å‘èµ·å‘è¯ææ¡ˆ (Maker)</h5>
                        <p class="text-muted small">éœ€è¦å¦ä¸€ä½ç®¡ç†å‘˜å¤æ ¸æ‰èƒ½ç”Ÿæ•ˆã€‚</p>
                        <input id="targetUser" class="form-control mb-2" placeholder="ç”¨æˆ·åœ°å€ (0x...)">
                        <select id="targetRegion" class="form-select mb-2"><option value="HK">HK (é¦™æ¸¯)</option><option value="US">US (ç¾å›½)</option><option value="CN">CN (å†…åœ°)</option></select>
                        <select id="targetRole" class="form-select mb-2"><option value="Student">Student</option><option value="Investor">Investor</option></select>
                        <button onclick="proposeID()" class="btn btn-warning w-100 text-white fw-bold">å‘èµ·ææ¡ˆ (Propose)</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-custom p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="m-0">ğŸ“‹ å¾…å®¡æ‰¹åˆ—è¡¨ (Checker)</h5>
                            <button onclick="loadProposals()" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync"></i></button>
                        </div>
                        <table class="table table-hover">
                            <thead><tr><th>ID</th><th>ç”¨æˆ·</th><th>è§’è‰²</th><th>å‘èµ·äºº</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="proposal-table">
                                <tr><td colspan="5" class="text-center text-muted">æš‚æ— å¾…åŠäº‹é¡¹</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="card-custom p-3">
                        <h5>ä¸Šæ¶æ–°èµ„äº§</h5>
                        <input id="newAssetName" class="form-control mb-2" placeholder="åç§°">
                        <input id="newAssetPrice" type="number" class="form-control mb-2" placeholder="ä»·æ ¼ (HKC)">
                        <select id="newAssetRegion" class="form-select mb-2"><option value="">ğŸŒ å…¨çƒ</option><option value="HK">HK Only</option><option value="US">US Only</option></select>
                        <button onclick="addAsset()" class="btn btn-success w-100">ä¸Šæ¶</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-custom p-3">
                        <h5>å·²ä¸Šæ¶èµ„äº§</h5>
                        <table class="table">
                            <thead><tr><th>ID</th><th>åç§°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="admin-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-gov" class="view-section">
            <div class="row">
                <div class="col-md-5">
                    <div class="card-custom p-3 border-danger border-top border-4">
                        <h5 class="text-danger">æœºæ„æˆæƒ/åŠé”€</h5>
                        <input id="issuerAddr" class="form-control mb-2" placeholder="æœºæ„åœ°å€ (0x...)">
                        <input id="issuerName" class="form-control mb-2" placeholder="æœºæ„åç§°">
                        <div class="d-flex gap-2">
                            <button onclick="govAdd()" class="btn btn-danger flex-fill">æˆæƒ</button>
                            <button onclick="govRevoke()" class="btn btn-dark flex-fill">åŠé”€</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="card-custom p-3">
                        <h5>ç°æœ‰æœºæ„åå•</h5>
                        <table class="table table-sm">
                            <thead><tr><th>åç§°</th><th>åœ°å€</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="issuer-list-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // âš ï¸ è¯·å¡«å…¥ä½ çš„ V7 åˆçº¦åœ°å€ (ç¡®ä¿æ˜¯éƒ¨ç½²äº† SystemV7.sol çš„åœ°å€)
        // =================================================================
        const ADDR_HKC    = "å¡«å…¥HKCåœ°å€";
        const ADDR_ID     = "å¡«å…¥èº«ä»½åˆçº¦åœ°å€";
        const ADDR_MARKET = "å¡«å…¥å¸‚åœºåˆçº¦åœ°å€";
        
        // ä½¿ç”¨å…¬å…±èŠ‚ç‚¹å®ç°å…é’±åŒ…æµè§ˆ
        const RPC_URL     = "https://ethereum-sepolia.publicnode.com"; 
        // =================================================================

        // å®Œæ•´çš„ V7 ABI
        const ABI_ID = [
            "function proposeIdentity(address,string,string,uint256) external", 
            "function approveIdentity(uint256) external", 
            "function proposalCount() view returns (uint256)", 
            "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", 
            "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)",
            "function issuers(address) view returns (bool isActive, string name)",
            "function getAllIssuers() view returns (address[])",
            "function addIssuer(address,string) external",
            "function revokeIssuer(address) external",
            "function checkCompliance(address,string,address) view returns (bool, string)"
        ];
        const ABI_MKT = [
            "function addAsset(string,uint256,string,address) external", 
            "function buyAsset(uint256) external", 
            "function sellAsset(uint256) external", 
            "function userBalances(address,uint256) view returns (uint256)", 
            "function assetCount() view returns (uint256)", 
            "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)",
            "function setAssetStatus(uint256, bool) external"
        ];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC;

        // åˆå§‹åŒ–
        window.onload = async () => {
            const p = new ethers.providers.JsonRpcProvider(RPC_URL);
            initContracts(p);
            loadAssets(); // å…é’±åŒ…åŠ è½½
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("Err","MetaMask needed","error");
            const p = new ethers.providers.Web3Provider(window.ethereum);
            await p.send("eth_requestAccounts", []);
            signer = p.getSigner();
            myAddr = await signer.getAddress();
            
            document.getElementById("btn-conn").style.display="none";
            document.getElementById("wallet-addr").innerText = myAddr.slice(0,6)+"...";
            
            initContracts(signer);
            loadAssets(); 
            loadUserData();
            loadIssuerList();
        }

        // --- æ•°æ®åŠ è½½ ---

        async function loadAssets() {
            const mGrid = document.getElementById("market-grid");
            const aTable = document.getElementById("admin-table");
            mGrid.innerHTML = ""; aTable.innerHTML = "";
            
            try {
                const count = await cMKT.assetCount();
                for(let i=1; i<=count; i++) {
                    const a = await cMKT.assets(i);
                    
                    // å¸‚åœºè§†å›¾ (Market)
                    if(a.isActive) {
                        const hue = (i*137)%360;
                        mGrid.innerHTML += `
                        <div class="col-md-4 col-lg-3 mb-4">
                            <div class="asset-card">
                                <div class="asset-img" style="background:hsl(${hue},70%,60%)">
                                    ${a.name.substring(0,2).toUpperCase()}
                                    <span class="asset-badge">${a.requiredRegion || 'GLOBAL'}</span>
                                </div>
                                <div class="p-3">
                                    <h5 class="fw-bold text-truncate">${a.name}</h5>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="text-primary fw-bold">${a.price} HKC</span>
                                        <button class="btn btn-primary btn-sm px-3" onclick="buy(${i})">è´­ä¹°</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                    
                    // èµ„äº§ç®¡ç†è§†å›¾ (Admin)
                    aTable.innerHTML += `<tr><td>${i}</td><td>${a.name}</td><td>${a.isActive?'âœ…':'âŒ'}</td><td><button class="btn btn-sm btn-outline-dark" onclick="toggle(${i},${!a.isActive})">åˆ‡æ¢çŠ¶æ€</button></td></tr>`;
                }
            } catch(e) { console.error(e); }
        }

        async function loadUserData() {
            if(!myAddr) return;
            
            // 1. ä½™é¢ä¸èº«ä»½
            const bal = await cHKC.balanceOf(myAddr);
            document.getElementById("hkc-bal").innerText = "HKC: " + ethers.utils.formatUnits(bal, 18).split('.')[0];
            
            const id = await cID.identities(myAddr);
            if(id.isValid && Date.now()/1000 < id.expiry) {
                document.getElementById("my-role").innerText = id.role;
                document.getElementById("my-region").innerText = "Region: "+id.region;
                document.getElementById("my-issuer").innerText = "Issuer: "+id.issuedBy.slice(0,8)+"...";
            } else {
                document.getElementById("my-role").innerText = "æ— æœ‰æ•ˆèº«ä»½";
            }

            // 2. ä¸ªäººæŒä»“ (Inventory) - åŒ…å«å–å‡ºæŒ‰é’®
            const invGrid = document.getElementById("my-inventory-grid");
            invGrid.innerHTML = "";
            const count = await cMKT.assetCount();
            let hasAsset = false;

            for(let i=1; i<=count; i++) {
                // ç›´æ¥æŸ¥è¯¢ä½™é¢ (SystemV6/V7 ç‰¹æ€§)
                const myBal = await cMKT.userBalances(myAddr, i);
                if(myBal.gt(0)) {
                    hasAsset = true;
                    const a = await cMKT.assets(i);
                    const hue = (i*137)%360;
                    invGrid.innerHTML += `
                    <div class="col-md-3 mb-4">
                        <div class="asset-card border border-primary">
                            <div class="asset-img" style="background:hsl(${hue},60%,50%)">
                                ${a.name.substring(0,2)}
                                <span class="badge bg-white text-dark position-absolute top-0 end-0 m-2">x${myBal}</span>
                            </div>
                            <div class="p-3">
                                <h6 class="fw-bold">${a.name}</h6>
                                <p class="small text-muted mb-2">ç°ä»·: ${a.price} HKC</p>
                                <button class="sell-btn" onclick="sell(${i}, '${a.name}', ${a.price})">
                                    <i class="fas fa-arrow-up"></i> å–å‡º (Sell)
                                </button>
                            </div>
                        </div>
                    </div>`;
                }
            }
            if(!hasAsset) invGrid.innerHTML = "<div class='text-center text-muted py-5'>æš‚æ— æŒä»“ï¼Œè¯·å»å¸‚åœºè´­ä¹°</div>";
        }

        // Multi-Sig å¾…åŠåˆ—è¡¨
        async function loadProposals() {
            const tbody = document.getElementById("proposal-table");
            tbody.innerHTML = "<tr><td colspan='5' class='text-center'>Loading...</td></tr>";
            try {
                const count = await cID.proposalCount();
                let html = "";
                for(let i=count; i>Math.max(0, count-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) {
                        html += `<tr>
                            <td>#${p.id}</td>
                            <td>${p.targetUser.slice(0,6)}...</td>
                            <td><span class="badge bg-info">${p.role}</span></td>
                            <td>${p.proposer.slice(0,6)}...</td>
                            <td><button class="btn btn-sm btn-success" onclick="approveID(${p.id})">âœ… æ‰¹å‡†</button></td>
                        </tr>`;
                    }
                }
                tbody.innerHTML = html || "<tr><td colspan='5' class='text-center text-muted'>æš‚æ— å¾…åŠ</td></tr>";
            } catch(e) { console.error(e); }
        }

        async function loadIssuerList() {
            const t = document.getElementById("issuer-list-tbody"); t.innerHTML = "";
            try {
                const list = await cID.getAllIssuers();
                for(let addr of list) {
                    const i = await cID.issuers(addr);
                    if(i.name) t.innerHTML += `<tr><td>${i.name}</td><td class="small">${addr.slice(0,6)}...</td><td>${i.isActive?'âœ…':'âŒ'}</td><td><button class="btn btn-sm btn-outline-danger" onclick="govRevoke('${addr}')">åŠé”€</button></td></tr>`;
                }
            } catch(e){}
        }

        // --- äº¤æ˜“ Action ---
        async function tx(p, msg) {
            if(!signer) return Swal.fire("è¯·è¿æ¥é’±åŒ…");
            try {
                Swal.fire({title:'ç¡®è®¤äº¤æ˜“', didOpen:()=>Swal.showLoading()});
                const t = await p;
                Swal.fire({title:'ä¸Šé“¾ä¸­...', didOpen:()=>Swal.showLoading()});
                await t.wait();
                Swal.fire("æˆåŠŸ", msg, "success");
                // åˆ·æ–°æ‰€æœ‰æ•°æ®
                loadAssets(); loadUserData(); if(document.getElementById('view-issuer').classList.contains('active')) loadProposals();
            } catch(e) { Swal.fire("Error", e.reason||e.message, "error"); }
        }

        function approveHKC() { tx(cHKC.approve(ADDR_MARKET, ethers.constants.MaxUint256), "æˆæƒæˆåŠŸ"); }
        function buy(id) { tx(cMKT.buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
        function sell(id, n, p) { tx(cMKT.sellAsset(id), `å–å‡º ${n} æˆåŠŸï¼Œè·å¾— ${p} HKC`); }
        
        function addAsset() { tx(cMKT.addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, document.getElementById("newAssetRegion").value, "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }
        function toggle(id, s) { tx(cMKT.setAssetStatus(id, s), "çŠ¶æ€æ›´æ–°"); }
        
        function proposeID() {
            const u=document.getElementById("targetUser").value, r=document.getElementById("targetRegion").value, role=document.getElementById("targetRole").value;
            tx(cID.proposeIdentity(u,r,role,365), "ææ¡ˆå·²æäº¤");
        }
        async function approveID(id) {
            const p = await cID.getProposal(id);
            if(p.proposer.toLowerCase() === myAddr.toLowerCase()) return Swal.fire("é”™è¯¯", "åˆè§„é™åˆ¶ï¼šä¸èƒ½å®¡æ‰¹è‡ªå·±å‘èµ·çš„ææ¡ˆ", "error");
            tx(cID.approveIdentity(id), "å®¡æ‰¹é€šè¿‡");
        }
        
        function govAdd() { tx(cID.addIssuer(document.getElementById("issuerAddr").value, document.getElementById("issuerName").value), "æœºæ„æˆæƒæˆåŠŸ"); }
        function govRevoke(a) { tx(cID.revokeIssuer(a || document.getElementById("issuerAddr").value), "æœºæ„å·²åŠé”€"); }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            document.querySelectorAll('.sidebar a').forEach(e=>e.classList.remove('active')); document.getElementById('nav-'+p).classList.add('active');
            const t={'market':'èµ„äº§å¸‚åœº','profile':'ä¸ªäººä¸­å¿ƒ & å–å‡º','issuer':'å¤šç­¾å‘è¯','admin':'èµ„äº§åå°','gov':'ç›‘ç®¡æœºæ„'};
            document.getElementById('page-title').innerText = t[p];
            if(p==='issuer') loadProposals();
            if(p==='gov') loadIssuerList();
        }
    </script>
</body>
</html>
