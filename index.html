<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>HKUST RWA V7 (Multi-Sig)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --sidebar-width: 260px; --primary-color: #2c3e50; --accent-color: #e74c3c; }
        body { background: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .sidebar { height: 100vh; width: var(--sidebar-width); position: fixed; top: 0; left: 0; background: var(--primary-color); color: white; padding-top: 20px; }
        .sidebar a { padding: 15px 25px; text-decoration: none; color: #bdc3c7; display: block; cursor: pointer; transition:0.2s; }
        .sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.1); color: #fff; border-left: 4px solid var(--accent-color); }
        .main-content { margin-left: var(--sidebar-width); padding: 20px; }
        .card-custom { border: none; border-radius: 12px; background: white; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .ms-badge { font-size: 0.8rem; padding: 5px 10px; border-radius: 4px; background: #f1c40f; color: #333; font-weight: bold; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="text-center mb-4"><h4>ğŸ¦ RWA V7</h4><small class="text-muted">Multi-Sig Enabled</small></div>
        <a onclick="nav('market')" class="active" id="nav-market"><i class="fas fa-store me-2"></i> èµ„äº§å¸‚åœº</a>
        <a onclick="nav('profile')" id="nav-profile"><i class="fas fa-user-circle me-2"></i> ä¸ªäººä¸­å¿ƒ</a>
        <a onclick="nav('issuer')" id="nav-issuer"><i class="fas fa-id-card me-2"></i> å‘è¯ (Multi-Sig)</a>
        <a onclick="nav('admin')" id="nav-admin"><i class="fas fa-cogs me-2"></i> èµ„äº§ç®¡ç†</a>
    </nav>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <h4 id="page-title" class="m-0">èµ„äº§å¸‚åœº</h4>
            <div class="d-flex align-items-center gap-3">
                <span id="wallet-addr" class="text-muted small">æœªè¿æ¥</span>
                <button onclick="connectWallet()" id="btn-conn" class="btn btn-primary btn-sm">è¿æ¥é’±åŒ…</button>
            </div>
        </div>

        <div id="view-market" class="view-section active">
            <div class="row" id="market-grid"></div>
        </div>

        <div id="view-profile" class="view-section">
            <div class="card-custom p-4 bg-primary text-white">
                <h5>æˆ‘çš„èº«ä»½</h5>
                <h2 id="my-role">Loading...</h2>
                <span id="my-region">Region: -</span>
            </div>
            <h5 class="mt-4">æŒæœ‰èµ„äº§</h5>
            <div class="row" id="my-inventory-grid"></div>
        </div>

        <div id="view-issuer" class="view-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="card-custom p-3 border-warning border-top border-4">
                        <h5 class="text-warning"><i class="fas fa-file-signature"></i> å‘èµ·ææ¡ˆ (Maker)</h5>
                        <p class="text-muted small">ç¬¬ä¸€æ­¥ï¼šå‘èµ·å‘è¯è¯·æ±‚ï¼Œè¿›å…¥å¾…åŠåˆ—è¡¨ã€‚</p>
                        <input id="targetUser" class="form-control mb-2" placeholder="ç”¨æˆ·åœ°å€ (0x...)">
                        <select id="targetRegion" class="form-select mb-2"><option value="HK">HK</option><option value="US">US</option></select>
                        <select id="targetRole" class="form-select mb-2"><option value="Student">Student</option><option value="Investor">Investor</option></select>
                        <button onclick="proposeID()" class="btn btn-warning w-100 text-white fw-bold">å‘èµ·ææ¡ˆ (Propose)</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-custom p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>ğŸ“‹ å¾…å®¡æ‰¹åˆ—è¡¨ (Pending Approvals)</h5>
                            <button onclick="loadProposals()" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync"></i></button>
                        </div>
                        <table class="table table-hover">
                            <thead><tr><th>ID</th><th>ç›®æ ‡ç”¨æˆ·</th><th>è§’è‰²</th><th>å‘èµ·äºº</th><th>æ“ä½œ (Checker)</th></tr></thead>
                            <tbody id="proposal-table">
                                <tr><td colspan="5" class="text-center text-muted">æš‚æ— å¾…åŠäº‹é¡¹</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-section">
            <div class="card-custom p-3">
                <h5>ä¸Šæ¶èµ„äº§</h5>
                <div class="d-flex gap-2">
                    <input id="newAssetName" class="form-control" placeholder="åç§°">
                    <input id="newAssetPrice" class="form-control" placeholder="ä»·æ ¼">
                    <button onclick="addAsset()" class="btn btn-success">ä¸Šæ¶</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= V7 åœ°å€ =================
        const ADDR_HKC      = "0xB0B8c886C6e8469C43bB309452a7f3C911681453";
        const ADDR_ID       = "0xA69098Bc7077cB3011D8E6d670A858669Ac3a034";
        const ADDR_MARKET   = "0x1ae6c3DE25A0aDBF01a600E1F960321567020a12";
        const RPC_URL     = "https://ethereum-sepolia.publicnode.com"; 
        // ===========================================

        const ABI_ID = ["function proposeIdentity(address,string,string,uint256) external", "function approveIdentity(uint256) external", "function proposalCount() view returns (uint256)", "function getProposal(uint256) view returns (tuple(uint256 id, address targetUser, string region, string role, uint256 validityDays, address proposer, bool executed))", "function identities(address) view returns (address issuedBy, string region, string role, uint256 expiry, bool isValid)"];
        const ABI_MKT = ["function addAsset(string,uint256,string,address) external", "function buyAsset(uint256) external", "function sellAsset(uint256) external", "function userBalances(address,uint256) view returns (uint256)", "function assetCount() view returns (uint256)", "function assets(uint256) view returns (string name, uint256 price, string requiredRegion, address requiredIssuer, bool isActive)"];
        const ABI_HKC = ["function approve(address,uint256) external", "function balanceOf(address) view returns (uint256)"];

        let signer, myAddr, cID, cMKT, cHKC;

        window.onload = async () => {
            const p = new ethers.providers.JsonRpcProvider(RPC_URL);
            initContracts(p);
            loadAssets();
        };

        function initContracts(p) {
            cID = new ethers.Contract(ADDR_ID, ABI_ID, p);
            cMKT = new ethers.Contract(ADDR_MARKET, ABI_MKT, p);
            cHKC = new ethers.Contract(ADDR_HKC, ABI_HKC, p);
        }

        async function connectWallet() {
            if(!window.ethereum) return Swal.fire("Err","MetaMask needed","error");
            const p = new ethers.providers.Web3Provider(window.ethereum);
            await p.send("eth_requestAccounts", []);
            signer = p.getSigner();
            myAddr = await signer.getAddress();
            
            document.getElementById("btn-conn").style.display="none";
            document.getElementById("wallet-addr").innerText = myAddr.slice(0,6)+"...";
            initContracts(signer);
            
            loadAssets(); loadUserData();
            if(document.getElementById('view-issuer').classList.contains('active')) loadProposals();
        }

        // å¤šç­¾é€»è¾‘
        async function proposeID() {
            const u=document.getElementById("targetUser").value;
            const r=document.getElementById("targetRegion").value;
            const role=document.getElementById("targetRole").value;
            tx(cID.proposeIdentity(u,r,role,365), "ææ¡ˆå·²æäº¤ï¼Œç­‰å¾…ç¬¬äºŒäººå®¡æ‰¹");
        }

        async function approveID(id) {
            // å‰ç«¯æ ¡éªŒï¼šä¸èƒ½è‡ªå·±æ‰¹è‡ªå·±
            const p = await cID.getProposal(id);
            if(p.proposer.toLowerCase() === myAddr.toLowerCase()) return Swal.fire("é”™è¯¯", "åˆè§„é™åˆ¶ï¼šä¸èƒ½å®¡æ‰¹è‡ªå·±å‘èµ·çš„ææ¡ˆ (Segregation of Duties)", "error");
            tx(cID.approveIdentity(id), "å®¡æ‰¹é€šè¿‡ï¼Œèº«ä»½å·²é¢å‘");
        }

        async function loadProposals() {
            const tbody = document.getElementById("proposal-table");
            tbody.innerHTML = "<tr><td colspan='5' class='text-center'>Loading...</td></tr>";
            try {
                const count = await cID.proposalCount();
                let html = "";
                // å€’åºæŸ¥æœ€è¿‘ 5 ä¸ªææ¡ˆ
                for(let i=count; i>Math.max(0, count-5); i--) {
                    const p = await cID.getProposal(i);
                    if(!p.executed) {
                        html += `<tr>
                            <td>#${p.id}</td>
                            <td>${p.targetUser.slice(0,6)}...</td>
                            <td><span class="badge bg-info">${p.role}</span></td>
                            <td>${p.proposer.slice(0,6)}...</td>
                            <td><button class="btn btn-sm btn-success" onclick="approveID(${p.id})">âœ… æ‰¹å‡† (Approve)</button></td>
                        </tr>`;
                    }
                }
                tbody.innerHTML = html || "<tr><td colspan='5' class='text-center text-muted'>æš‚æ— å¾…åŠ</td></tr>";
            } catch(e) { console.error(e); }
        }

        async function loadAssets() {
            const grid = document.getElementById("market-grid"); grid.innerHTML = "";
            const count = await cMKT.assetCount();
            for(let i=1; i<=count; i++) {
                const a = await cMKT.assets(i);
                if(a.isActive) grid.innerHTML += `<div class="col-md-3 mb-3"><div class="card-custom p-3"><h5>${a.name}</h5><p class="text-primary fw-bold">${a.price} HKC</p><button class="btn btn-primary w-100" onclick="buy(${i})">Buy</button></div></div>`;
            }
        }

        async function loadUserData() {
            if(!myAddr) return;
            const id = await cID.identities(myAddr);
            document.getElementById("my-role").innerText = id.isValid ? id.role : "æ— èº«ä»½";
            document.getElementById("my-region").innerText = id.isValid ? "Region: "+id.region : "";
            
            // Inventory
            const inv = document.getElementById("my-inventory-grid"); inv.innerHTML = "";
            const count = await cMKT.assetCount();
            for(let i=1; i<=count; i++) {
                const bal = await cMKT.userBalances(myAddr, i);
                if(bal.gt(0)) {
                    const a = await cMKT.assets(i);
                    inv.innerHTML += `<div class="col-md-3"><div class="card-custom p-3 border-primary"><h6>${a.name}</h6><span class="badge bg-secondary">x${bal}</span><button class="btn btn-sm btn-danger w-100 mt-2" onclick="sell(${i})">å–å‡º</button></div></div>`;
                }
            }
        }

        async function tx(p, msg) {
            try { Swal.fire({title:'ç¡®è®¤äº¤æ˜“', didOpen:()=>Swal.showLoading()}); await (await p).wait(); Swal.fire("æˆåŠŸ", msg, "success"); loadProposals(); loadAssets(); loadUserData(); } 
            catch(e) { Swal.fire("Error", e.reason||e.message, "error"); }
        }

        function buy(id) { tx(cMKT.buyAsset(id), "è´­ä¹°æˆåŠŸ"); }
        function sell(id) { tx(cMKT.sellAsset(id), "å–å‡ºæˆåŠŸ"); }
        function addAsset() { tx(cMKT.addAsset(document.getElementById("newAssetName").value, document.getElementById("newAssetPrice").value, "", "0x0000000000000000000000000000000000000000"), "ä¸Šæ¶æˆåŠŸ"); }

        function nav(p) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+p).classList.add('active');
            if(p==='issuer') loadProposals();
        }
    </script>
</body>
</html>
